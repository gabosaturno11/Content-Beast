<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CONTENT BEAST — PDF Maker + Content Tools</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>if(window.pdfjsLib)pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Sora:wght@300;400;500;600;700&display=swap');

*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg-void:#08070c;--bg-base:#0d0b14;--bg-elevated:#13111c;--bg-surface:#1a1726;
  --border:rgba(168,85,247,0.08);--border-hover:rgba(168,85,247,0.16);--border-active:rgba(168,85,247,0.3);
  --text-primary:#e8e4f0;--text-secondary:rgba(232,228,240,0.55);--text-muted:rgba(232,228,240,0.25);
  --accent:#a855f7;--cyan:#818cf8;--green:#4ade80;--amber:#fbbf24;--red:#f87171;
  --mono:'JetBrains Mono',monospace;--sans:'Sora',system-ui,sans-serif;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.4);
  --shadow-md:0 4px 12px rgba(0,0,0,0.4);
  --shadow-lg:0 8px 24px rgba(0,0,0,0.5);
  --shadow-xl:0 16px 48px rgba(0,0,0,0.6);
  --glow-accent:0 0 24px rgba(168,85,247,0.12);
  --glow-cyan:0 0 20px rgba(129,140,248,0.1);
  --panel-inset:inset 0 1px 0 rgba(255,255,255,0.02);
  --grad-surface:linear-gradient(135deg,rgba(168,85,247,0.03) 0%,transparent 100%);
}
body{font-family:var(--mono);background:var(--bg-void);color:var(--text-secondary);height:100vh;overflow:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background-image:radial-gradient(ellipse 80% 50% at 50% 0%,rgba(168,85,247,0.03) 0%,transparent 70%)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.12)}

/* === APP SHELL === */
.app{display:grid;grid-template-rows:48px 1fr 30px;height:100vh}

/* HEADER */
.hdr{border-bottom:1px solid var(--border);background:var(--bg-base);display:flex;align-items:center;padding:0 16px;gap:14px;box-shadow:var(--panel-inset),0 1px 6px rgba(0,0,0,0.2);position:relative}
.hdr::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(168,85,247,0.2) 30%,rgba(168,85,247,0.2) 70%,transparent);pointer-events:none}
.hdr-brand{display:flex;align-items:center;gap:10px}
.hdr-brand h1{color:var(--text-primary);font-size:12px;font-weight:700;letter-spacing:0.02em}
.hdr-brand .ver{font-size:7px;color:var(--accent);padding:2px 6px;border:1px solid rgba(168,85,247,0.25);border-radius:4px;background:rgba(168,85,247,0.06);font-weight:600;letter-spacing:0.05em}
.hdr .tab-bar{display:flex;gap:2px;background:var(--bg-base);border:1px solid var(--border);border-radius:6px;padding:3px}
.tab-btn{padding:6px 12px;font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;background:transparent;border:none;color:var(--text-muted);cursor:pointer;border-radius:4px;font-family:var(--mono);transition:all 0.2s cubic-bezier(0.4,0,0.2,1)}
.tab-btn:hover{color:var(--text-secondary);background:rgba(255,255,255,0.03)}
.tab-btn.active{background:var(--accent);color:#fff;box-shadow:0 2px 8px rgba(168,85,247,0.3)}
.hdr-right{margin-left:auto;display:flex;gap:10px;align-items:center}
.status{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:12px;font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:0.04em}
.status-ok{background:rgba(34,197,94,0.08);color:var(--green);border:1px solid rgba(34,197,94,0.15)}
.status-busy{background:rgba(245,158,11,0.08);color:var(--amber);border:1px solid rgba(245,158,11,0.15)}

/* FOOTER */
.ftr{border-top:1px solid var(--border);background:var(--bg-base);display:flex;align-items:center;justify-content:space-between;padding:0 16px;font-size:8px;color:var(--text-muted);letter-spacing:0.02em}

/* === 3-COLUMN LAYOUT === */
.workspace{display:grid;grid-template-columns:210px 1fr 1fr;overflow:hidden;transition:grid-template-columns 0.35s cubic-bezier(0.22,1,0.36,1)}
.workspace.two-col{grid-template-columns:0px 1fr 1fr}
.workspace.caption-mode{grid-template-columns:210px 340px 1fr}

/* LEFT: LIBRARY */
.lib{background:var(--bg-base);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;position:relative;box-shadow:var(--panel-inset);transition:opacity 0.2s ease}
.lib-hdr{padding:10px;border-bottom:1px solid var(--border);display:flex;gap:4px;background:rgba(255,255,255,0.01)}
.lib-list{flex:1;overflow-y:auto;padding:6px}
.lib-item{padding:9px 12px;border-radius:6px;cursor:pointer;transition:all 0.15s cubic-bezier(0.4,0,0.2,1);margin-bottom:2px;border:1px solid transparent}
.lib-item:hover{background:rgba(255,255,255,0.03);border-color:var(--border)}
.lib-item.active{background:rgba(168,85,247,0.08);border-left:3px solid var(--accent);border-color:rgba(168,85,247,0.15);box-shadow:inset 0 0 0 1px rgba(168,85,247,0.06)}
.lib-item .li-title{font-size:10px;color:var(--text-primary);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lib-item .li-meta{font-size:8px;color:var(--text-muted);margin-top:3px}
.lib-empty{padding:20px;text-align:center;font-size:9px;color:var(--text-muted);line-height:1.8}

/* MID: CONTROLS */
.ctrl{border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;position:relative;background:var(--bg-base);box-shadow:var(--panel-inset)}
.ctrl-hdr{background:var(--bg-elevated);border-bottom:1px solid var(--border);padding:10px 14px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.ctrl-hdr .title{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.14em}
.ctrl-body{flex:1;overflow-y:auto;padding:14px}

/* RIGHT: PREVIEW */
.preview{display:flex;flex-direction:column;overflow:hidden;background:var(--bg-void)}
.preview-hdr{background:var(--bg-elevated);border-bottom:1px solid var(--border);padding:8px 14px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.preview-hdr .title{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.14em;color:var(--accent)}
.preview-toolbar{display:flex;gap:3px;flex-wrap:wrap;align-items:center}
.preview-body{flex:1;overflow-y:auto;padding:24px;background:var(--bg-void)}

/* FORM */
textarea,input[type="text"],select{width:100%;background:var(--bg-base);border:1px solid var(--border);border-radius:5px;padding:8px 10px;color:var(--text-primary);font-family:var(--mono);font-size:11px;resize:none;transition:all 0.2s cubic-bezier(0.4,0,0.2,1)}
textarea:focus,input:focus,select:focus{outline:none;border-color:rgba(168,85,247,0.5);box-shadow:0 0 0 3px rgba(168,85,247,0.08)}
.lbl{display:block;font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.14em;margin-bottom:5px;font-weight:700}
.row{margin-bottom:12px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}

/* BUTTONS */
.btn{padding:7px 14px;border:none;border-radius:5px;font-family:var(--mono);font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.06em;cursor:pointer;transition:all 0.15s cubic-bezier(0.4,0,0.2,1);display:inline-flex;align-items:center;gap:5px}
.btn-primary{background:var(--accent);color:#fff;box-shadow:0 1px 4px rgba(168,85,247,0.2)}
.btn-primary:hover{background:#9333ea;box-shadow:0 2px 12px rgba(168,85,247,0.3)}
.btn-primary:active{transform:scale(0.97);box-shadow:0 1px 4px rgba(168,85,247,0.15)}
.btn-outline{background:transparent;color:var(--text-secondary);border:1px solid var(--border)}
.btn-outline:hover{border-color:var(--border-active);color:#fff;background:rgba(255,255,255,0.02)}
.btn-green{background:var(--green);color:#111}
.btn-green:hover{background:#16a34a}
.btn-cyan{background:var(--cyan);color:#fff}
.btn-cyan:hover{background:#6366f1}
.btn-red{background:transparent;color:var(--red);border:1px solid rgba(239,68,68,0.2)}
.btn-red:hover{background:rgba(239,68,68,0.08);border-color:rgba(239,68,68,0.4)}
.btn-sm{padding:4px 8px;font-size:8px}
.btn-block{width:100%}
.btn-icon{width:28px;height:28px;padding:0;display:inline-flex;align-items:center;justify-content:center;background:var(--bg-elevated);border:1px solid var(--border);border-radius:5px;color:var(--text-muted);cursor:pointer;font-family:var(--mono);font-size:10px;font-weight:700;transition:all 0.15s cubic-bezier(0.4,0,0.2,1)}
.btn-icon:hover{border-color:var(--border-hover);color:var(--text-primary);background:rgba(255,255,255,0.04);box-shadow:var(--shadow-sm)}
.btn-icon.active{border-color:var(--accent);color:var(--accent);background:rgba(168,85,247,0.08);box-shadow:var(--glow-accent)}

/* MODE BTNS */
.mode-btn{padding:5px 9px;font-size:8px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:5px;color:var(--text-muted);cursor:pointer;transition:all 0.15s cubic-bezier(0.4,0,0.2,1);font-family:var(--mono);font-weight:600}
.mode-btn:hover{border-color:var(--border-hover);color:var(--text-secondary);background:rgba(255,255,255,0.03)}
.mode-btn.active{border-color:rgba(168,85,247,0.4);color:var(--accent);background:rgba(168,85,247,0.08);box-shadow:0 0 12px rgba(168,85,247,0.1)}

/* PRESET CARDS */
.preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.preset-card{background:var(--bg-elevated);border:1px solid var(--border);border-radius:6px;padding:10px;cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1)}
.preset-card:hover{border-color:var(--border-hover);background:var(--bg-surface)}
.preset-card.active{border-color:var(--border-active);background:rgba(168,85,247,0.06)}
.preset-card .pn{font-size:9px;font-weight:700;color:var(--text-primary);margin-bottom:2px}
.preset-card .pd{font-size:7px;color:var(--text-muted);line-height:1.4}

/* === PDF CANVAS === */
.pdf-canvas{background:#fff;color:#1a1a1a;font-family:var(--sans);padding:48px 56px;border-radius:8px;min-height:600px;position:relative;box-shadow:0 8px 40px rgba(0,0,0,0.5),0 0 0 1px rgba(255,255,255,0.03);line-height:1.75;transition:all 0.3s cubic-bezier(0.4,0,0.2,1)}
.pdf-canvas[contenteditable]{outline:none;cursor:text}
.pdf-canvas[contenteditable]:focus{box-shadow:0 0 0 2px var(--accent),0 8px 40px rgba(0,0,0,0.5),0 0 60px rgba(168,85,247,0.08)}
.pdf-canvas[contenteditable]:empty::before{content:attr(data-placeholder);color:#ccc;font-style:italic;pointer-events:none}

.pdf-canvas h1{font-size:28px;font-weight:700;margin-bottom:4px;color:#111;line-height:1.2}
.pdf-canvas h2{font-size:13px;color:#888;margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid #111}
.pdf-canvas h3{font-size:15px;font-weight:700;margin-top:24px;margin-bottom:8px;color:#222;text-transform:uppercase;letter-spacing:0.04em}
.pdf-canvas h4{font-size:13px;font-weight:600;margin-top:16px;margin-bottom:6px;color:#444}
.pdf-canvas p{font-size:12px;margin-bottom:8px;color:#333}
.pdf-canvas ul,.pdf-canvas ol{margin-left:20px;margin-bottom:10px}
.pdf-canvas li{font-size:12px;margin-bottom:3px;color:#333}
.pdf-canvas strong{font-weight:700;color:#111}
.pdf-canvas em{font-style:italic}
.pdf-canvas hr{border:none;border-top:1px solid #ddd;margin:20px 0}
.pdf-canvas blockquote{border-left:3px solid #a855f7;padding:8px 16px;margin:12px 0;background:#faf5ff;font-style:italic;color:#555}
.pdf-canvas code{background:#f4f4f5;padding:1px 4px;border-radius:2px;font-family:var(--mono);font-size:11px}
.pdf-canvas .pdf-footer{font-size:9px;color:#aaa;margin-top:40px;padding-top:12px;border-top:1px solid #eee;font-family:var(--mono);letter-spacing:0.04em}
.pdf-canvas table{width:100%;border-collapse:collapse;margin:12px 0;font-size:12px}
.pdf-canvas th{background:#f8f8f8;font-weight:600;text-align:left;padding:8px 10px;border:1px solid #e5e5e5;font-size:11px;text-transform:uppercase;letter-spacing:0.03em}
.pdf-canvas td{padding:6px 10px;border:1px solid #e5e5e5;color:#444}

/* DARK */
.pdf-canvas.tpl-dark{background:#0a0a0a;color:#e2e8f0}
.pdf-canvas.tpl-dark h1{color:#fff}
.pdf-canvas.tpl-dark h2{color:#a855f7;border-bottom-color:#a855f7}
.pdf-canvas.tpl-dark h3{color:#22d3ee}
.pdf-canvas.tpl-dark h4{color:#94a3b8}
.pdf-canvas.tpl-dark p,.pdf-canvas.tpl-dark li{color:#cbd5e1}
.pdf-canvas.tpl-dark blockquote{background:rgba(168,85,247,0.05);border-left-color:#a855f7;color:#a78bfa}
.pdf-canvas.tpl-dark th{background:#111;border-color:#222;color:#94a3b8}
.pdf-canvas.tpl-dark td{border-color:#1a1a1a;color:#94a3b8}
.pdf-canvas.tpl-dark hr{border-top-color:#222}
.pdf-canvas.tpl-dark .pdf-footer{color:#334155;border-top-color:#1e293b}

/* SATURNO */
.pdf-canvas.tpl-saturno{background:linear-gradient(180deg,#030508 0%,#050711 100%);color:#e2e8f0;border:1px solid #1a1f2e;padding:48px 52px}
.pdf-canvas.tpl-saturno h1{color:#fff;font-size:30px;letter-spacing:-0.02em}
.pdf-canvas.tpl-saturno h2{color:#06b6d4;border-bottom-color:#06b6d430;font-weight:300}
.pdf-canvas.tpl-saturno h3{color:#a855f7}
.pdf-canvas.tpl-saturno h4{color:#06b6d4}
.pdf-canvas.tpl-saturno p,.pdf-canvas.tpl-saturno li{color:#94a3b8}
.pdf-canvas.tpl-saturno strong{color:#e2e8f0}
.pdf-canvas.tpl-saturno blockquote{background:rgba(6,182,212,0.05);border-left-color:#06b6d4;color:#67e8f9}
.pdf-canvas.tpl-saturno th{background:rgba(168,85,247,0.08);border-color:#1e293b;color:#a78bfa}
.pdf-canvas.tpl-saturno td{border-color:#1e293b;color:#94a3b8}
.pdf-canvas.tpl-saturno hr{border-top-color:#1e293b}
.pdf-canvas.tpl-saturno .pdf-footer{color:#334155;border-top-color:#1e293b}
.pdf-canvas.tpl-saturno .level-badge{display:inline-block;padding:3px 10px;border-radius:3px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:12px;font-family:var(--mono)}
.level-badge.lv-foundation{background:rgba(34,197,94,0.12);color:#4ade80;border:1px solid rgba(34,197,94,0.25)}
.level-badge.lv-intermediate{background:rgba(6,182,212,0.12);color:#22d3ee;border:1px solid rgba(6,182,212,0.25)}
.level-badge.lv-advanced{background:rgba(168,85,247,0.12);color:#c084fc;border:1px solid rgba(168,85,247,0.25)}
.level-badge.lv-elite{background:rgba(245,158,11,0.12);color:#fbbf24;border:1px solid rgba(245,158,11,0.25)}

/* MINIMAL */
.pdf-canvas.tpl-minimal{padding:60px 64px;font-family:Georgia,'Times New Roman',serif}
.pdf-canvas.tpl-minimal h1{font-size:24px;font-weight:400;letter-spacing:0.01em}
.pdf-canvas.tpl-minimal h2{font-size:11px;color:#aaa;border-bottom:1px solid #eee;font-weight:400}
.pdf-canvas.tpl-minimal h3{font-size:13px;font-weight:400;text-transform:none;color:#555}

/* PAGE EST */
.page-est{font-size:8px;color:var(--text-muted);text-align:center;padding:6px;margin-top:8px}

/* ZOOM */
.zoom-bar{display:flex;align-items:center;gap:4px;margin-left:auto}
.zoom-bar .zb{font-size:8px;color:var(--text-muted);font-family:var(--mono);min-width:32px;text-align:center}

/* IMAGE IN CANVAS */
.pdf-canvas img{max-width:100%;height:auto;border-radius:3px;margin:8px 0}
.pdf-canvas .img-block{position:relative;display:inline-block;margin:8px 0}
.pdf-canvas .img-block img{display:block}

/* PAGE BREAK MARKER */
.page-break{border:none;border-top:2px dashed var(--accent);margin:24px 0;position:relative;page-break-after:always}
.page-break::after{content:'PAGE BREAK';position:absolute;top:-8px;left:50%;transform:translateX(-50%);background:var(--bg-elevated);padding:0 8px;font-size:7px;color:var(--accent);font-family:var(--mono);letter-spacing:0.1em}

/* EXPORT SETTINGS PANEL */
.export-panel{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-elevated);border:1px solid var(--border-hover);border-radius:12px;padding:24px;width:380px;z-index:1000;display:none;box-shadow:var(--shadow-xl),0 0 40px rgba(168,85,247,0.06);backdrop-filter:blur(12px)}
.export-panel.open{display:block}
.export-overlay{position:fixed;inset:0;background:rgba(8,7,12,0.75);backdrop-filter:blur(4px);z-index:999;display:none}
.export-overlay.open{display:block}
.export-panel h3{font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.08em}
.export-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.export-row label{font-size:9px;color:var(--text-secondary)}
.export-row select,.export-row input[type="number"]{width:140px;padding:6px 8px;font-size:10px}

/* FULLSCREEN CANVAS */
.fullscreen-mode .workspace{grid-template-columns:0 0 1fr !important}
.fullscreen-mode .lib,.fullscreen-mode .ctrl{display:none !important}
.fullscreen-mode .preview-body{padding:32px 10%}

/* FOCUS VIEW — immersive writing */
.workspace.focus-mode .lib{width:0;overflow:hidden;border:none;padding:0}
.workspace.focus-mode .ctrl{border-right-color:var(--border)}
.workspace.focus-mode .preview-body{padding:40px 12%;background:var(--bg-void)}
.workspace.focus-mode .pdf-canvas{box-shadow:0 8px 48px rgba(0,0,0,0.6),0 0 80px rgba(168,85,247,0.04);max-width:780px;margin:0 auto}
.workspace.focus-mode .preview-hdr{background:var(--bg-void);border-bottom-color:transparent}
.workspace.focus-mode .preview-toolbar{opacity:0.2;transition:opacity 0.3s cubic-bezier(0.4,0,0.2,1)}
.workspace.focus-mode .preview-toolbar:hover{opacity:1}
.workspace.focus-mode .wc-bar{background:var(--bg-void)}

/* SPLIT VIEW */
.workspace.split-view .lib{width:0;overflow:hidden;border:none;padding:0}
.workspace.split-view{grid-template-columns:0 1fr 1fr}

/* COVER PAGE */
.cover-page{text-align:center;padding:80px 60px;min-height:500px;display:flex;flex-direction:column;justify-content:center;align-items:center}
.cover-page h1{font-size:42px;margin-bottom:8px;line-height:1.1}
.cover-page .cover-sub{font-size:16px;color:#06b6d4;margin-bottom:40px;font-weight:300}
.cover-page .cover-author{font-size:14px;color:#94a3b8;margin-top:auto}
.cover-page .cover-brand{font-size:10px;color:#334155;margin-top:16px;letter-spacing:0.1em;text-transform:uppercase;font-family:var(--mono)}
.cover-page .cover-line{width:60px;height:2px;background:var(--accent);margin:24px auto}

/* TOOLBAR SEP */
.tb-sep{width:1px;height:16px;background:var(--border);margin:0 3px}

/* CAPTION */
.variant-card{background:var(--bg-elevated);border-left:3px solid var(--accent);padding:12px;margin-bottom:8px;border-radius:0 8px 8px 0}
.variant-card.ig{border-color:#e1306c}
.variant-card.email{border-color:var(--amber)}
.variant-card.yt{border-color:#ff0000}
.variant-card.twitter{border-color:#1da1f2}
.variant-card.linkedin{border-color:#0077b5}
.variant-card.tiktok{border-color:#69c9d0}
.chk{display:flex;align-items:center;gap:6px;padding:5px 8px;background:var(--bg-base);border:1px solid var(--border);border-radius:3px;cursor:pointer;transition:all 0.12s;font-size:9px}
.chk:hover{border-color:var(--border-hover)}
.chk.on{border-color:var(--accent);background:rgba(168,85,247,0.08)}
.chk input{display:none}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;background:var(--bg-surface);border:1px solid var(--border-active);color:var(--text-primary);padding:10px 18px;border-radius:8px;font-size:10px;opacity:0;transform:translateY(12px) scale(0.96);transition:all 0.3s cubic-bezier(0.22,1,0.36,1);pointer-events:none;z-index:9999;font-family:var(--mono);box-shadow:var(--shadow-lg),0 0 24px rgba(168,85,247,0.08);backdrop-filter:blur(12px)}
.toast.show{opacity:1;transform:translateY(0) scale(1)}

/* SAVE PULSE */
@keyframes savePulse{0%{opacity:1}50%{opacity:0.3}100%{opacity:1}}
.save-pulse{animation:savePulse 0.6s ease-in-out}

/* DROP ZONE */
.drop-zone{border:2px dashed rgba(168,85,247,0.15);border-radius:8px;padding:20px;text-align:center;margin-bottom:10px;transition:all 0.25s cubic-bezier(0.4,0,0.2,1);cursor:pointer}
.drop-zone:hover,.drop-zone.over{border-color:var(--accent);background:rgba(168,85,247,0.04)}
.drop-zone .dz-text{font-size:9px;color:var(--text-muted)}

/* SHORTCUTS HELP */
.shortcuts-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-elevated);border:1px solid var(--border-hover);border-radius:12px;padding:24px;width:440px;max-height:80vh;overflow-y:auto;z-index:1000;display:none;box-shadow:var(--shadow-xl)}
.shortcuts-modal.open{display:block}
.shortcuts-modal h3{font-size:11px;font-weight:600;color:var(--text-primary);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:16px}
.sc-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border)}
.sc-key{font-size:9px;color:var(--accent);font-family:var(--mono);background:var(--bg-base);padding:2px 6px;border-radius:2px;border:1px solid var(--border)}
.sc-desc{font-size:9px;color:var(--text-secondary)}

/* MD CHEATSHEET */
.md-cheat{display:none;padding:8px;background:var(--bg-base);border:1px solid var(--border);border-radius:3px;margin-bottom:10px;font-size:8px;color:var(--text-muted);line-height:1.8}
.md-cheat.open{display:block}
.md-cheat code{background:var(--bg-elevated);padding:1px 4px;border-radius:2px;color:var(--text-secondary)}

/* WORD COUNT BAR */
.wc-bar{padding:4px 12px;border-top:1px solid var(--border);font-size:8px;color:var(--text-muted);display:flex;gap:12px;flex-shrink:0;font-family:var(--mono)}
.wc-bar span{display:inline-flex;gap:3px}

/* TABLE INSERT MODAL */
.tbl-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-elevated);border:1px solid var(--border-hover);border-radius:12px;padding:24px;width:320px;z-index:1000;display:none;box-shadow:var(--shadow-xl)}
.tbl-modal.open{display:block}
.tbl-grid-pick{display:grid;grid-template-columns:repeat(8,1fr);gap:2px;margin:10px 0}
.tbl-cell{width:100%;aspect-ratio:1;background:var(--bg-base);border:1px solid var(--border);border-radius:2px;cursor:pointer;transition:all 0.1s}
.tbl-cell.hl{background:rgba(168,85,247,0.2);border-color:var(--accent)}

/* FIND BAR */
.find-bar{display:none;padding:6px 12px;border-top:1px solid var(--border);gap:6px;align-items:center;flex-shrink:0;background:var(--bg-surface)}
.find-bar.open{display:flex}
.find-bar input{width:160px;padding:5px 8px;font-size:10px}
.find-bar .find-count{font-size:8px;color:var(--text-muted);min-width:50px;font-family:var(--mono)}

/* VERSION HISTORY */
.ver-panel{position:fixed;top:0;right:-340px;width:340px;height:100vh;background:var(--bg-base);border-left:1px solid var(--border);z-index:900;transition:right 0.3s cubic-bezier(0.4,0,0.2,1);display:flex;flex-direction:column;box-shadow:-8px 0 32px rgba(0,0,0,0.3)}
.ver-panel.open{right:0}
.ver-panel-hdr{padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.ver-panel-hdr h3{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-primary)}
.ver-list{flex:1;overflow-y:auto;padding:8px}
.ver-item{padding:8px 10px;border-radius:4px;cursor:pointer;margin-bottom:4px;transition:all 0.1s}
.ver-item:hover{background:var(--bg-elevated)}
.ver-item .vi-time{font-size:9px;color:var(--text-primary);font-weight:500}
.ver-item .vi-meta{font-size:8px;color:var(--text-muted);margin-top:2px}
.ver-item .vi-preview{font-size:8px;color:var(--text-muted);margin-top:4px;max-height:40px;overflow:hidden;line-height:1.4}

/* CALLOUT BLOCKS */
.pdf-canvas .callout{padding:12px 16px;border-radius:4px;margin:12px 0;font-size:12px}
.pdf-canvas .callout-info{background:#eff6ff;border-left:3px solid #3b82f6;color:#1e40af}
.pdf-canvas .callout-warning{background:#fffbeb;border-left:3px solid #f59e0b;color:#92400e}
.pdf-canvas .callout-tip{background:#f0fdf4;border-left:3px solid #22c55e;color:#166534}
.pdf-canvas .callout-fire{background:#fef2f2;border-left:3px solid #ef4444;color:#991b1b}
.pdf-canvas.tpl-dark .callout-info,.pdf-canvas.tpl-saturno .callout-info{background:rgba(59,130,246,0.08);color:#93c5fd}
.pdf-canvas.tpl-dark .callout-warning,.pdf-canvas.tpl-saturno .callout-warning{background:rgba(245,158,11,0.08);color:#fcd34d}
.pdf-canvas.tpl-dark .callout-tip,.pdf-canvas.tpl-saturno .callout-tip{background:rgba(34,197,94,0.08);color:#86efac}
.pdf-canvas.tpl-dark .callout-fire,.pdf-canvas.tpl-saturno .callout-fire{background:rgba(239,68,68,0.08);color:#fca5a5}

/* QUICK INSERT DROPDOWN */
.qi-menu{position:absolute;background:var(--bg-elevated);border:1px solid var(--border-hover);border-radius:8px;padding:4px;width:200px;z-index:100;display:none;box-shadow:var(--shadow-lg)}
.qi-menu.open{display:block}
.qi-item{padding:7px 12px;font-size:9px;color:var(--text-secondary);cursor:pointer;border-radius:5px;font-family:var(--mono);transition:all 0.12s;display:flex;align-items:center;gap:8px}
.qi-item:hover{background:rgba(168,85,247,0.06);color:var(--text-primary)}
.qi-item .qi-icon{font-size:10px;width:16px;text-align:center}

/* SORT BTNS */
.sort-bar{padding:4px;border-bottom:1px solid var(--border);display:flex;gap:2px}
.sort-btn{padding:2px 6px;font-size:7px;background:transparent;border:1px solid transparent;border-radius:2px;color:var(--text-muted);cursor:pointer;font-family:var(--mono);transition:all 0.1s}
.sort-btn:hover{border-color:var(--border)}
.sort-btn.active{color:var(--accent);border-color:var(--accent)}

/* COLOR PICKER */
.color-grid{display:flex;gap:3px;flex-wrap:wrap;padding:4px 0}
.color-dot{width:18px;height:18px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.1s}
.color-dot:hover{transform:scale(1.2)}
.color-dot.active{border-color:var(--text-primary)}

/* EXPORT FORMAT PICKER */
.export-formats{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:6px}
.ef-btn{background:var(--bg-elevated);border:1px solid var(--border);border-radius:6px;padding:10px 4px;cursor:pointer;text-align:center;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);font-family:var(--mono)}
.ef-btn:hover{border-color:var(--border-hover);background:var(--bg-surface)}
.ef-btn.active{border-color:var(--border-active);background:rgba(168,85,247,0.06)}
.ef-btn .ef-icon{display:block;font-size:11px;font-weight:700;color:var(--text-primary);margin-bottom:2px}
.ef-btn .ef-label{display:block;font-size:7px;color:var(--text-muted)}
.ef-btn.active .ef-icon{color:var(--accent)}
.ef-btn.active .ef-label{color:var(--accent)}

/* DRAGGABLE PANEL RESIZE */
.resize-handle{width:6px;cursor:col-resize;background:transparent;position:absolute;right:-3px;top:0;height:100%;z-index:20;transition:all 0.2s}
.resize-handle:hover,.resize-handle.dragging{background:rgba(168,85,247,0.3)}
.resize-handle::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:2px;height:28px;background:rgba(168,85,247,0.15);border-radius:2px;transition:background 0.2s}
.resize-handle:hover::after{background:var(--accent)}

/* ATOMIZER */
.atom-import{border:2px dashed rgba(168,85,247,0.15);border-radius:10px;padding:28px 20px;text-align:center;cursor:pointer;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);margin-bottom:12px;position:relative}
.atom-import:hover,.atom-import.over{border-color:var(--accent);background:rgba(168,85,247,0.04)}
.atom-import .ai-icon{font-size:20px;color:var(--text-muted);margin-bottom:8px;font-weight:700;font-family:var(--mono)}
.atom-import .ai-title{font-size:11px;color:var(--text-secondary);margin-bottom:4px;font-weight:500}
.atom-import .ai-sub{font-size:8px;color:var(--text-muted);line-height:1.5}
.atom-import .ai-formats{display:flex;gap:4px;justify-content:center;margin-top:8px}
.atom-import .ai-fmt{font-size:7px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;padding:2px 6px;border-radius:2px;background:var(--bg-surface);border:1px solid var(--border);color:var(--text-muted);font-family:var(--mono)}

.atom-filters{display:flex;gap:3px;flex-wrap:wrap;margin-bottom:8px}
.atom-filter{padding:3px 8px;font-size:7px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;background:var(--bg-base);border:1px solid var(--border);border-radius:3px;color:var(--text-muted);cursor:pointer;font-family:var(--mono);transition:all 0.12s}
.atom-filter:hover{border-color:var(--border-hover);color:var(--text-secondary)}
.atom-filter.active{border-color:var(--accent);color:var(--accent);background:rgba(168,85,247,0.08)}
.atom-filter .af-count{font-size:6px;opacity:0.6;margin-left:2px}

.atom-list{overflow-y:auto;flex:1}
.atom-card{background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);position:relative}
.atom-card:hover{border-color:var(--border-hover);box-shadow:var(--shadow-sm)}
.atom-card.selected{border-color:var(--border-active);background:rgba(168,85,247,0.04);box-shadow:var(--glow-accent)}
.atom-card .ac-type{display:inline-block;font-size:7px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;padding:2px 6px;border-radius:2px;margin-bottom:6px;font-family:var(--mono)}
.ac-type.t-quote{background:rgba(168,85,247,0.12);color:#c084fc}
.ac-type.t-heading{background:rgba(6,182,212,0.12);color:#22d3ee}
.ac-type.t-paragraph{background:rgba(148,163,184,0.12);color:#94a3b8}
.ac-type.t-list{background:rgba(34,197,94,0.12);color:#4ade80}
.ac-type.t-table{background:rgba(245,158,11,0.12);color:#fbbf24}
.ac-type.t-image{background:rgba(236,72,153,0.12);color:#f472b6}
.ac-type.t-code{background:rgba(99,102,241,0.12);color:#a5b4fc}
.ac-type.t-divider{background:rgba(100,116,139,0.08);color:#64748b}
.atom-card .ac-text{font-size:10px;color:var(--text-secondary);line-height:1.6;margin-bottom:8px;max-height:80px;overflow:hidden}
.atom-card .ac-text.expanded{max-height:none}
.atom-card .ac-actions{display:flex;gap:3px;flex-wrap:wrap}
.atom-card .ac-meta{font-size:7px;color:var(--text-muted);margin-bottom:4px}

.atom-stats{padding:8px;border-top:1px solid var(--border);font-size:8px;color:var(--text-muted);display:flex;gap:10px;flex-shrink:0}
.atom-bulk{padding:6px 8px;border-bottom:1px solid var(--border);display:flex;gap:4px;align-items:center;flex-shrink:0}

/* SEED LIBRARY */
.seed-item{padding:6px 8px;font-size:9px;color:var(--text-secondary);cursor:pointer;border-bottom:1px solid var(--border);transition:all 0.1s;line-height:1.5}
.seed-item:hover{background:rgba(168,85,247,0.06);color:var(--text-primary)}
.seed-item:last-child{border-bottom:none}
.seed-tag{display:inline-block;font-size:7px;padding:1px 4px;border-radius:2px;background:var(--bg-base);color:var(--text-muted);margin-right:4px;border:1px solid var(--border)}

/* CAPTION LIBRARY */
.cap-subtabs{display:flex;gap:2px;background:var(--bg-base);border:1px solid var(--border);border-radius:6px;padding:3px;margin-bottom:12px}
.cap-subtab{flex:1;padding:6px 10px;font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;background:transparent;border:none;color:var(--text-muted);cursor:pointer;border-radius:4px;font-family:var(--mono);transition:all 0.2s cubic-bezier(0.4,0,0.2,1);text-align:center}
.cap-subtab:hover{color:var(--text-secondary);background:rgba(255,255,255,0.02)}
.cap-subtab.active{background:var(--accent);color:#fff;box-shadow:0 1px 6px rgba(168,85,247,0.25)}
.cl-search{display:flex;gap:4px;margin-bottom:8px}
.cl-search input{flex:1}
.cl-filters{display:flex;gap:3px;flex-wrap:wrap;margin-bottom:8px}
.cl-filter{padding:3px 7px;font-size:7px;font-weight:600;text-transform:uppercase;letter-spacing:0.06em;background:var(--bg-base);border:1px solid var(--border);border-radius:3px;color:var(--text-muted);cursor:pointer;font-family:var(--mono);transition:all 0.12s}
.cl-filter:hover{border-color:var(--border-hover);color:var(--text-secondary)}
.cl-filter.active{border-color:var(--border-active);color:var(--accent);background:rgba(168,85,247,0.06)}
.cl-filter .clf-n{font-size:6px;opacity:0.6;margin-left:2px}
.cl-list{overflow-y:auto;flex:1}
.cl-item{background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);position:relative}
.cl-item:hover{border-color:var(--border-hover);box-shadow:var(--shadow-sm)}
.cl-item.selected{border-color:var(--border-active);background:rgba(168,85,247,0.04);box-shadow:var(--glow-accent)}
.cl-item .cl-voice{display:inline-block;font-size:7px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;padding:2px 6px;border-radius:2px;margin-right:4px;font-family:var(--mono);background:rgba(168,85,247,0.12);color:#c084fc}
.cl-item .cl-theme{display:inline-block;font-size:7px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;padding:2px 6px;border-radius:2px;font-family:var(--mono);background:rgba(6,182,212,0.12);color:#22d3ee}
.cl-item .cl-text{font-size:10px;color:var(--text-secondary);line-height:1.6;margin:6px 0;max-height:60px;overflow:hidden}
.cl-item .cl-text.expanded{max-height:none}
.cl-item .cl-meta{font-size:7px;color:var(--text-muted);display:flex;gap:8px}
.cl-item .cl-actions{display:flex;gap:3px;margin-top:6px;flex-wrap:wrap}
.cl-bulk{padding:6px 8px;border-bottom:1px solid var(--border);display:flex;gap:4px;align-items:center;flex-shrink:0;display:none}
.cl-stats{padding:6px 8px;border-top:1px solid var(--border);font-size:8px;color:var(--text-muted);display:flex;gap:10px;flex-shrink:0}
.cl-empty{padding:24px 16px;text-align:center;font-size:9px;color:var(--text-muted);line-height:2}
.cl-import-zone{border:2px dashed rgba(168,85,247,0.15);border-radius:8px;padding:16px;text-align:center;cursor:pointer;transition:all 0.25s cubic-bezier(0.4,0,0.2,1);margin-bottom:10px}
.cl-import-zone:hover,.cl-import-zone.over{border-color:var(--accent);background:rgba(168,85,247,0.04)}

/* SPLIT VIEW */
.workspace.split-view{grid-template-columns:0 1fr 1fr}
.workspace.split-view .lib{display:none}
.workspace.split-view .ctrl{overflow-y:auto}
.workspace.split-view .ctrl .ctrl-body{padding:0}
.workspace.split-view .ctrl #f-content{height:100% !important;min-height:calc(100vh - 120px);border:none;border-radius:0;font-size:12px;line-height:1.7;resize:none}
.workspace.split-view .ctrl .ctrl-hdr{display:flex}
.workspace.split-view .ctrl #pdf-ctrl .row:not(:last-child){display:none}
.workspace.split-view .ctrl #pdf-ctrl .grid2{display:none}
.workspace.split-view .ctrl #pdf-ctrl [class*="preset"]{display:none}
.workspace.split-view .ctrl #pdf-ctrl [data-tpl]{display:none}
.workspace.split-view .ctrl #pdf-ctrl [data-lv]{display:none}
.workspace.split-view .ctrl #pdf-ctrl .drop-zone{display:none}
.workspace.split-view .ctrl #pdf-ctrl .md-cheat{display:none}
.workspace.split-view .ctrl #pdf-ctrl > div:last-child{display:none}

/* FOCUS MODE (hides library) */
.workspace.focus-mode{grid-template-columns:0 1fr 1fr}
.workspace.focus-mode .lib{display:none}

/* COMMAND PALETTE */
.cmd-overlay{position:fixed;inset:0;background:rgba(8,7,12,0.7);backdrop-filter:blur(4px);z-index:1100;display:none}
.cmd-overlay.open{display:block}
.cmd-palette{position:fixed;top:18%;left:50%;transform:translateX(-50%);width:500px;background:var(--bg-elevated);border:1px solid var(--border-hover);border-radius:12px;z-index:1101;display:none;box-shadow:var(--shadow-xl),0 0 60px rgba(168,85,247,0.06);overflow:hidden}
.cmd-palette.open{display:block}
.cmd-palette input{width:100%;padding:16px 18px;background:transparent;border:none;border-bottom:1px solid var(--border);color:var(--text-primary);font-family:var(--mono);font-size:13px;outline:none}
.cmd-results{max-height:340px;overflow-y:auto;padding:6px}
.cmd-item{padding:10px 14px;cursor:pointer;border-radius:6px;margin:2px;display:flex;align-items:center;gap:10px;transition:all 0.12s cubic-bezier(0.4,0,0.2,1)}
.cmd-item:hover,.cmd-item.sel{background:rgba(168,85,247,0.08)}
.cmd-item .ci-icon{font-size:11px;width:20px;text-align:center;color:var(--text-muted)}
.cmd-item .ci-text{font-size:11px;color:var(--text-primary)}
.cmd-item .ci-desc{font-size:8px;color:var(--text-muted);margin-left:auto}
.cmd-item .ci-key{font-size:8px;color:var(--text-muted);background:var(--bg-base);padding:2px 5px;border-radius:2px;border:1px solid var(--border);margin-left:auto}

/* === 3D PANEL ELEVATION SYSTEM === */
.lib{box-shadow:var(--panel-inset),4px 0 16px rgba(0,0,0,0.3),inset -1px 0 0 rgba(255,255,255,0.02)}
.ctrl{box-shadow:var(--panel-inset),4px 0 20px rgba(0,0,0,0.25),inset 1px 0 0 rgba(255,255,255,0.015),inset -1px 0 0 rgba(255,255,255,0.015)}
.preview{box-shadow:inset 4px 0 24px rgba(0,0,0,0.15)}
.hdr{box-shadow:var(--panel-inset),0 2px 12px rgba(0,0,0,0.35),0 1px 0 rgba(168,85,247,0.04)}
.ftr{box-shadow:inset 0 1px 0 rgba(255,255,255,0.02),0 -2px 12px rgba(0,0,0,0.2)}
.ctrl-hdr{box-shadow:0 2px 8px rgba(0,0,0,0.2),inset 0 -1px 0 rgba(255,255,255,0.02)}
.preview-hdr{box-shadow:0 2px 8px rgba(0,0,0,0.15),inset 0 -1px 0 rgba(255,255,255,0.02)}
.lib-hdr{box-shadow:0 2px 6px rgba(0,0,0,0.15)}
.atom-card,.cl-item{box-shadow:0 1px 4px rgba(0,0,0,0.25),inset 0 1px 0 rgba(255,255,255,0.03)}
.atom-card:hover,.cl-item:hover{box-shadow:0 4px 16px rgba(0,0,0,0.35),inset 0 1px 0 rgba(255,255,255,0.04);transform:translateY(-1px)}
.atom-card.selected,.cl-item.selected{box-shadow:0 4px 20px rgba(168,85,247,0.15),inset 0 1px 0 rgba(255,255,255,0.04);transform:translateY(-1px)}
.preset-card{box-shadow:0 1px 3px rgba(0,0,0,0.2),inset 0 1px 0 rgba(255,255,255,0.02)}
.preset-card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.3);transform:translateY(-1px)}
.lib-item{transition:all 0.15s cubic-bezier(0.4,0,0.2,1)}
.lib-item:hover{box-shadow:0 2px 8px rgba(0,0,0,0.2)}
.lib-item.active{box-shadow:inset 3px 0 0 var(--accent),0 2px 8px rgba(168,85,247,0.1)}
.btn-primary{box-shadow:0 2px 8px rgba(168,85,247,0.25),inset 0 1px 0 rgba(255,255,255,0.1)}
.btn-primary:hover{box-shadow:0 4px 16px rgba(168,85,247,0.35),inset 0 1px 0 rgba(255,255,255,0.12);transform:translateY(-1px)}
.btn-icon{box-shadow:0 1px 2px rgba(0,0,0,0.15)}
.btn-icon:hover{box-shadow:0 2px 6px rgba(0,0,0,0.25);transform:translateY(-1px)}
.mode-btn{box-shadow:0 1px 2px rgba(0,0,0,0.1)}
.mode-btn.active{box-shadow:0 2px 10px rgba(168,85,247,0.2),inset 0 1px 0 rgba(255,255,255,0.05)}
.tab-btn{box-shadow:none;transition:all 0.2s cubic-bezier(0.4,0,0.2,1)}
.tab-btn.active{box-shadow:0 2px 12px rgba(168,85,247,0.35),inset 0 1px 0 rgba(255,255,255,0.1)}
textarea,input[type="text"],select{box-shadow:inset 0 2px 4px rgba(0,0,0,0.15)}
textarea:focus,input:focus,select:focus{box-shadow:inset 0 1px 3px rgba(0,0,0,0.1),0 0 0 3px rgba(168,85,247,0.1),0 0 16px rgba(168,85,247,0.05)}

/* === TOGGLE SWITCH === */
.toggle-wrap{display:flex;align-items:center;gap:8px;padding:4px 0}
.toggle-label{font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;font-weight:600;cursor:pointer;user-select:none}
.toggle{position:relative;width:32px;height:18px;background:rgba(255,255,255,0.06);border:1px solid var(--border);border-radius:9px;cursor:pointer;transition:all 0.25s cubic-bezier(0.4,0,0.2,1);flex-shrink:0}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:12px;height:12px;border-radius:50%;background:var(--text-muted);transition:all 0.25s cubic-bezier(0.4,0,0.2,1);box-shadow:0 1px 3px rgba(0,0,0,0.3)}
.toggle.on{background:rgba(168,85,247,0.25);border-color:rgba(168,85,247,0.4)}
.toggle.on::after{transform:translateX(14px);background:var(--accent);box-shadow:0 1px 6px rgba(168,85,247,0.4)}

/* === COLLAPSIBLE SECTION === */
.section-toggle{display:flex;align-items:center;justify-content:space-between;padding:8px 0;cursor:pointer;user-select:none;border-bottom:1px solid var(--border);margin-bottom:8px}
.section-toggle .lbl{margin:0;cursor:pointer}
.section-toggle .section-arrow{font-size:8px;color:var(--text-muted);transition:transform 0.2s cubic-bezier(0.4,0,0.2,1);font-family:var(--mono)}
.section-toggle.collapsed .section-arrow{transform:rotate(-90deg)}
.section-content{overflow:hidden;transition:max-height 0.3s cubic-bezier(0.4,0,0.2,1),opacity 0.2s ease;max-height:1000px;opacity:1}
.section-content.collapsed{max-height:0;opacity:0;overflow:hidden}

/* === ALIVE: BREATHING & ORGANIC === */
@keyframes breathe{0%,100%{opacity:0.6}50%{opacity:1}}
@keyframes ambientGlow{0%,100%{box-shadow:0 0 16px rgba(168,85,247,0.08)}50%{box-shadow:0 0 24px rgba(168,85,247,0.16)}}
@keyframes subtlePulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
@keyframes fadeSlideUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideInLeft{from{opacity:0;transform:translateX(-12px)}to{opacity:1;transform:translateX(0)}}
.app{animation:fadeIn 0.4s ease}
.hdr-brand h1{animation:slideInLeft 0.5s ease 0.1s both}
.status-ok span:first-child{animation:breathe 4s ease-in-out infinite}
.hdr-brand .ver{animation:ambientGlow 6s ease-in-out infinite}

/* === RANGE SLIDER (Collision Matrix Style) === */
input[type="range"]{-webkit-appearance:none;appearance:none;width:100%;height:6px;border-radius:3px;background:rgba(255,255,255,0.06);outline:none;cursor:pointer;border:none;box-shadow:inset 0 1px 2px rgba(0,0,0,0.3);padding:0;margin:6px 0}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 1px 6px rgba(168,85,247,0.4),0 0 12px rgba(168,85,247,0.2);border:2px solid rgba(255,255,255,0.15);transition:all 0.15s cubic-bezier(0.4,0,0.2,1);margin-top:0}
input[type="range"]::-webkit-slider-thumb:hover{transform:scale(1.2);box-shadow:0 2px 12px rgba(168,85,247,0.5),0 0 20px rgba(168,85,247,0.25)}
input[type="range"]::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 1px 6px rgba(168,85,247,0.4);border:2px solid rgba(255,255,255,0.15)}
input[type="range"]::-webkit-slider-runnable-track{height:6px;border-radius:3px}

/* SLIDER CARD */
.slider-card{background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:8px;transition:all 0.2s cubic-bezier(0.4,0,0.2,1)}
.slider-card:hover{border-color:var(--border-hover);box-shadow:var(--shadow-sm)}
.slider-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.slider-name{font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-secondary)}
.slider-value{font-size:11px;font-weight:700;color:var(--accent);font-family:var(--mono);min-width:24px;text-align:right}
.slider-labels{display:flex;justify-content:space-between;font-size:7px;color:var(--text-muted);margin-top:2px;padding:0 2px}
.slider-level{font-size:7px;color:var(--text-muted);text-align:center;margin-top:3px;font-style:italic}

/* === PIPELINE STAGES === */
.pipeline{display:flex;gap:3px;padding:8px 10px;background:rgba(0,0,0,0.15);border-bottom:1px solid var(--border);overflow-x:auto;flex-shrink:0}
.pipeline-stage{flex:1;min-width:60px;padding:6px 4px;text-align:center;border-radius:5px;font-size:7px;font-weight:600;text-transform:uppercase;letter-spacing:0.04em;background:rgba(255,255,255,0.03);border:1px solid var(--border);transition:all 0.3s cubic-bezier(0.4,0,0.2,1);cursor:default;color:var(--text-muted)}
.pipeline-stage.active{background:rgba(168,85,247,0.15);border-color:rgba(168,85,247,0.35);color:var(--accent);animation:ambientGlow 2s ease-in-out infinite}
.pipeline-stage.complete{background:rgba(74,222,128,0.1);border-color:rgba(74,222,128,0.25);color:var(--green)}
.pipeline-stage .ps-icon{display:block;font-size:10px;margin-bottom:2px;font-family:var(--mono)}
.pipeline-stage .ps-label{display:block;font-size:7px}

/* === VOICE CARDS (Rich) === */
.voice-card{background:var(--bg-elevated);border:2px solid transparent;border-radius:8px;padding:10px;cursor:pointer;transition:all 0.25s cubic-bezier(0.4,0,0.2,1);position:relative;overflow:hidden}
.voice-card::after{content:'';position:absolute;inset:0;background:var(--grad-surface);opacity:0;transition:opacity 0.3s}
.voice-card:hover{transform:translateY(-2px);border-color:var(--border-hover);box-shadow:var(--shadow-md)}
.voice-card:hover::after{opacity:1}
.voice-card.selected{border-color:var(--accent);background:rgba(168,85,247,0.06);box-shadow:var(--glow-accent)}
.voice-card .vc-name{font-size:10px;font-weight:700;color:var(--text-primary);margin-bottom:2px;position:relative;z-index:1}
.voice-card .vc-desc{font-size:7px;color:var(--text-muted);line-height:1.4;position:relative;z-index:1}
.voice-card .vc-bar{margin-top:6px;height:3px;border-radius:2px;background:rgba(168,85,247,0.15);position:relative;z-index:1}
.voice-card .vc-bar-fill{height:100%;border-radius:2px;background:var(--accent);transition:width 0.3s ease}

/* === UNIVERSAL DRAG-DROP === */
.drag-ghost{position:fixed;pointer-events:none;z-index:2000;padding:8px 14px;background:var(--bg-surface);border:1px solid var(--border-active);border-radius:8px;font-size:9px;color:var(--text-primary);font-family:var(--mono);box-shadow:var(--shadow-lg),0 0 24px rgba(168,85,247,0.15);max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;opacity:0.92;backdrop-filter:blur(8px)}
.drop-target{transition:all 0.2s cubic-bezier(0.4,0,0.2,1)}
.drop-target.drag-over{border-color:var(--accent) !important;background:rgba(168,85,247,0.06) !important;box-shadow:0 0 24px rgba(168,85,247,0.12),inset 0 0 20px rgba(168,85,247,0.04) !important}
.drop-target.drag-over::before{content:'Drop here';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:0.12em;color:var(--accent);font-family:var(--mono);z-index:5;background:var(--bg-base);padding:4px 12px;border-radius:4px;border:1px solid rgba(168,85,247,0.3);box-shadow:0 2px 8px rgba(168,85,247,0.15)}
.draggable-item{cursor:grab}
.draggable-item:active{cursor:grabbing}
.draggable-item.dragging{opacity:0.4;transform:scale(0.97)}
.drag-handle{width:12px;height:16px;display:flex;flex-direction:column;gap:2px;justify-content:center;cursor:grab;opacity:0.3;transition:opacity 0.15s;flex-shrink:0;padding:0 2px}
.drag-handle:hover{opacity:0.7}
.drag-handle::before,.drag-handle::after{content:'';display:block;width:8px;height:1.5px;background:var(--text-muted);border-radius:1px}
.drag-handle span{display:block;width:8px;height:1.5px;background:var(--text-muted);border-radius:1px}
.canvas-drop-zone{position:relative;min-height:100px}
.canvas-drop-zone.drag-over{outline:2px dashed var(--accent);outline-offset:-4px;border-radius:8px}

/* === SIDEBAR TOGGLE BUTTON (Astra-style) === */
.sidebar-btn{width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;background:var(--bg-elevated);border:1px solid var(--border);border-radius:6px;color:var(--text-muted);cursor:pointer;transition:all 0.2s cubic-bezier(0.4,0,0.2,1);flex-shrink:0;padding:0}
.sidebar-btn:hover{border-color:var(--border-hover);color:var(--text-primary);background:rgba(255,255,255,0.04)}
.sidebar-btn:active{transform:scale(0.92)}
.sidebar-btn.active{border-color:rgba(168,85,247,0.3);color:var(--accent)}
.sidebar-btn svg{width:14px;height:14px;stroke:currentColor;fill:none}
.workspace.two-col .lib{opacity:0;pointer-events:none;overflow:hidden;transition:opacity 0.2s ease}

/* === MOBILE BOTTOM NAV === */
.mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;height:48px;background:var(--bg-base);border-top:1px solid var(--border);padding:4px;gap:4px;z-index:100;box-shadow:0 -2px 12px rgba(0,0,0,0.3)}
.mobile-tab{flex:1;border:none;background:transparent;color:var(--text-muted);font-family:var(--mono);font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.06em;border-radius:6px;cursor:pointer;transition:all 0.15s}
.mobile-tab.active{background:var(--accent);color:#fff;box-shadow:0 2px 8px rgba(168,85,247,0.3)}
.mobile-tab:active{transform:scale(0.96)}

/* MOBILE */
@media (max-width: 768px) {
  .app{grid-template-rows:44px 1fr 0px}
  .ftr{display:none}
  .mobile-nav{display:flex}
  .workspace{display:block !important;overflow:auto}
  .lib,.ctrl{position:fixed;top:44px;left:0;right:0;bottom:48px;z-index:50;display:none !important;background:var(--bg-base);overflow-y:auto;border:none}
  .lib.mobile-show,.ctrl.mobile-show{display:flex !important;animation:fadeSlideUp 0.25s ease}
  .preview{height:calc(100vh - 44px - 48px);overflow:auto}
  .preview-body{padding:12px}
  .pdf-canvas{padding:24px 20px;min-height:auto}
  .hdr{padding:0 10px;gap:8px;height:44px}
  .hdr-brand h1{font-size:10px}
  .hdr .tab-bar{display:none}
  .hdr-right .tab-bar{display:none}
  .hdr-right{gap:6px}
  .preview-toolbar{flex-wrap:wrap;gap:2px;padding:6px 8px}
  .preview-toolbar .tb-sep{display:none}
  .preview-toolbar .zoom-bar{display:none}
  .btn-icon{width:36px;height:36px;font-size:11px}
  .wc-bar{font-size:7px;gap:6px}
  .wc-bar span:nth-child(n+3){display:none}
  .btn{min-height:36px}
  .mode-btn{min-height:32px;padding:6px 10px}
  .preset-card{padding:14px}
  .atom-card,.cl-item{padding:14px}
  .lib-item{padding:12px 14px}
  .voice-card{padding:12px}
  .slider-card{padding:12px 14px}
  .toast{bottom:60px;right:16px;left:16px;text-align:center}
  .export-panel,.shortcuts-modal{width:calc(100vw - 32px);max-width:400px}
  .cmd-palette{top:10%;width:calc(100vw - 24px);max-width:none}
  .tbl-modal{width:calc(100vw - 32px);max-width:340px}
  .ver-panel{width:100vw}
  .ctrl-body{padding:12px}
  .grid2{grid-template-columns:1fr}
}

/* PRINT */
@media print {
  body{background:#fff !important;overflow:visible !important}
  .app{display:block !important;height:auto !important}
  .hdr,.ftr,.lib,.ctrl,.preview-hdr,.preview-toolbar,.wc-bar,.find-bar,.page-est,.toast,.export-panel,.export-overlay,.tbl-modal,.ver-panel,.shortcuts-modal{display:none !important}
  .workspace{display:block !important}
  .preview{display:block !important;overflow:visible !important}
  .preview-body{overflow:visible !important;padding:0 !important;background:#fff !important}
  .pdf-canvas{box-shadow:none !important;border-radius:0 !important;transform:none !important}
  .pdf-canvas.tpl-saturno,.pdf-canvas.tpl-dark{background:#fff !important;color:#1a1a1a !important}
  .pdf-canvas.tpl-saturno h1,.pdf-canvas.tpl-dark h1{color:#111 !important}
  .pdf-canvas.tpl-saturno h2,.pdf-canvas.tpl-dark h2{color:#666 !important}
  .pdf-canvas.tpl-saturno h3,.pdf-canvas.tpl-dark h3{color:#333 !important}
  .pdf-canvas.tpl-saturno p,.pdf-canvas.tpl-dark p,.pdf-canvas.tpl-saturno li,.pdf-canvas.tpl-dark li{color:#333 !important}
  .page-break{page-break-after:always !important;border:none !important}
  .page-break::after{display:none !important}
}
</style>
</head>
<body>
<div class="app">

<div class="hdr">
  <button class="sidebar-btn active" id="sidebar-btn" onclick="toggleSidebar()" title="Toggle sidebar">
    <svg width="14" height="14" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
  </button>
  <div class="hdr-brand">
    <h1>CONTENT BEAST</h1>
    <span class="ver">v6.5</span>
  </div>
  <div class="tab-bar">
    <button class="tab-btn active" onclick="setMode('pdf')">PDF Maker</button>
    <button class="tab-btn" onclick="setMode('caption')">Captions</button>
    <button class="tab-btn" onclick="setMode('atomizer')">Atomizer</button>
  </div>
  <div class="hdr-right">
    <div class="tab-bar" style="margin-right:4px">
      <button class="tab-btn active" id="view-default" onclick="setView('default')" title="3-panel">Full</button>
      <button class="tab-btn" id="view-split" onclick="setView('split')" title="Markdown + Preview">Split</button>
      <button class="tab-btn" id="view-focus" onclick="setView('focus')" title="Controls + Preview">Focus</button>
    </div>
    <span id="save-ind" style="font-size:8px;color:var(--text-muted);opacity:0;transition:opacity 0.3s">Saved</span>
    <span id="status" class="status status-ok"><span style="width:5px;height:5px;border-radius:50%;background:currentColor;display:inline-block"></span> READY</span>
  </div>
</div>

<div class="workspace" id="workspace">

  <!-- LIBRARY -->
  <div class="lib" id="lib-panel">
    <div class="lib-hdr">
      <button class="btn btn-primary btn-sm" style="flex:1" onclick="newDoc()">+ New</button>
      <button class="btn btn-outline btn-sm" onclick="importFile()" title="Import .md or .txt">Import</button>
    </div>
    <div style="padding:4px 4px 0">
      <input type="text" id="lib-search" placeholder="Search docs..." style="padding:5px 8px;font-size:9px;margin-bottom:2px" oninput="filterLibrary()">
    </div>
    <div class="sort-bar">
      <button class="sort-btn active" onclick="sortDocs('recent',this)">Recent</button>
      <button class="sort-btn" onclick="sortDocs('name',this)">A-Z</button>
      <button class="sort-btn" onclick="sortDocs('oldest',this)">Oldest</button>
      <button class="sort-btn" onclick="batchExport()" title="Export all as ZIP" style="margin-left:auto;color:var(--green)">ZIP</button>
    </div>
    <div class="lib-list" id="lib-list">
      <div class="lib-empty">No documents yet.<br>Click + New to start.</div>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="ctrl" id="ctrl-panel">
    <div class="ctrl-hdr">
      <span class="title" id="ctrl-title" style="color:var(--accent)">PDF Controls</span>
    </div>
    <div class="ctrl-body" id="ctrl-body">

      <!-- PDF CONTROLS -->
      <div id="pdf-ctrl">
        <div class="grid2 row">
          <div><label class="lbl">Title</label><input type="text" id="f-title" value="" placeholder="Document title" oninput="onFieldChange()"></div>
          <div><label class="lbl">Author</label><input type="text" id="f-author" value="Gabo Saturno" oninput="onFieldChange()"></div>
        </div>

        <div class="section-toggle" onclick="toggleSection(this)">
          <label class="lbl">Template & Style</label>
          <span class="section-arrow">v</span>
        </div>
        <div class="section-content">
        <div class="row">
          <div style="display:flex;gap:3px;flex-wrap:wrap">
            <button class="mode-btn active" data-tpl="tpl-saturno" onclick="setTpl(this)">Saturno</button>
            <button class="mode-btn" data-tpl="tpl-dark" onclick="setTpl(this)">Dark</button>
            <button class="mode-btn" data-tpl="tpl-minimal" onclick="setTpl(this)">Minimal</button>
            <button class="mode-btn" data-tpl="" onclick="setTpl(this)">White</button>
          </div>
        </div>
        <div class="row">
          <label class="lbl" style="font-size:7px;margin-bottom:3px">Level Badge</label>
          <div style="display:flex;gap:3px;flex-wrap:wrap">
            <button class="mode-btn active" data-lv="" onclick="setLv(this)">None</button>
            <button class="mode-btn" data-lv="foundation" onclick="setLv(this)" style="color:#4ade80">Foundation</button>
            <button class="mode-btn" data-lv="intermediate" onclick="setLv(this)" style="color:#22d3ee">Intermediate</button>
            <button class="mode-btn" data-lv="advanced" onclick="setLv(this)" style="color:#c084fc">Advanced</button>
            <button class="mode-btn" data-lv="elite" onclick="setLv(this)" style="color:#fbbf24">Elite</button>
          </div>
        </div>
        </div>

        <div class="section-toggle" onclick="toggleSection(this)">
          <label class="lbl">Presets</label>
          <span class="section-arrow">v</span>
        </div>
        <div class="section-content">
        <div class="row">
          <div class="preset-grid">
            <div class="preset-card" onclick="loadPreset('program',this)"><div class="pn">Program PDF</div><div class="pd">Workout with exercises, sets, reps</div></div>
            <div class="preset-card" onclick="loadPreset('level',this)"><div class="pn">Level Guide</div><div class="pd">Foundation to Elite progression</div></div>
            <div class="preset-card" onclick="loadPreset('framework',this)"><div class="pn">Framework</div><div class="pd">Training methodology breakdown</div></div>
            <div class="preset-card" onclick="loadPreset('transcript',this)"><div class="pn">Transcript</div><div class="pd">Video key points + actions</div></div>
            <div class="preset-card" onclick="loadPreset('cover',this)"><div class="pn">Cover Page</div><div class="pd">Branded title page</div></div>
          </div>
        </div>
        </div>

        <div class="section-toggle" onclick="toggleSection(this)">
          <label class="lbl">Content</label>
          <span class="section-arrow">v</span>
        </div>
        <div class="section-content">
        <div class="row">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <label class="lbl" style="margin-bottom:0">Content (Markdown)</label>
            <button class="btn btn-outline btn-sm" onclick="document.getElementById('md-cheat').classList.toggle('open')" style="font-size:7px;padding:2px 6px">Syntax Help</button>
          </div>
          <div class="md-cheat" id="md-cheat">
            <code># H1</code> <code>## H2</code> <code>### H3</code><br>
            <code>**bold**</code> <code>*italic*</code> <code>`code`</code><br>
            <code>- bullet</code> <code>1. numbered</code> <code>> quote</code><br>
            <code>---</code> horizontal rule<br>
            <code>| Col | Col |</code> table (with separator row)
          </div>
          <div class="drop-zone" id="drop-zone" onclick="document.getElementById('f-content').focus()">
            <div class="dz-text">Drop .md / .txt file here or type below</div>
          </div>
          <textarea id="f-content" style="height:200px" placeholder="# Heading&#10;## Subheading&#10;### Section&#10;- Bullet points&#10;**Bold** *italic*&#10;> Blockquote&#10;---&#10;| Col1 | Col2 |&#10;|------|------|&#10;| data | data |" oninput="onFieldChange()"></textarea>
        </div>
        </div>

        <div style="display:flex;gap:6px">
          <button onclick="renderPreview()" class="btn btn-outline" style="flex:1">Refresh</button>
          <button onclick="openExport()" class="btn btn-primary" style="flex:1">Export PDF</button>
          <button onclick="downloadHTML()" class="btn btn-outline" title="Download as HTML">HTML</button>
        </div>
      </div>

      <!-- CAPTION CONTROLS (Library + Multiplier) -->
      <div id="cap-ctrl" style="display:none">
        <div class="cap-subtabs">
          <button class="cap-subtab active" onclick="setCapSub('library')">Library</button>
          <button class="cap-subtab" onclick="setCapSub('multiplier')">Multiplier</button>
        </div>

        <!-- SUB: LIBRARY -->
        <div id="cap-library">
          <div class="cl-search">
            <input type="text" id="cl-search" placeholder="Search captions..." style="padding:5px 8px;font-size:9px" oninput="searchCaptions()">
            <button class="btn btn-outline btn-sm" onclick="document.getElementById('cl-file').click()" title="Import captions">Import</button>
            <button class="btn btn-outline btn-sm" onclick="seedGaboCaptions()" title="Load Gabo's full content library" style="color:var(--accent)">Seed</button>
            <button class="btn btn-outline btn-sm" onclick="addCaptionManual()" title="Add new caption">+</button>
          </div>
          <input type="file" id="cl-file" accept=".json,.md,.txt,.csv" style="display:none" multiple onchange="importCaptions(this.files)">
          <div class="cl-filters" id="cl-filters"></div>
          <div class="cl-bulk" id="cl-bulk">
            <span style="font-size:8px;color:var(--text-muted)"><b id="cl-sel-count">0</b> selected</span>
            <button class="btn btn-primary btn-sm" onclick="clBulkToCanvas()">To Canvas</button>
            <button class="btn btn-outline btn-sm" onclick="clBulkToSeed()">To Seed</button>
            <button class="btn btn-outline btn-sm" onclick="clBulkCopy()">Copy</button>
            <button class="btn btn-outline btn-sm" onclick="clBulkExport()">Export</button>
            <button class="btn btn-outline btn-sm" onclick="clDeselectAll()" style="margin-left:auto">x</button>
          </div>
          <div class="cl-list" id="cl-list" style="max-height:calc(100vh - 300px);overflow-y:auto">
            <div class="cl-empty">
              <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;font-weight:500">Caption Library</div>
              Import captions from JSON, Markdown, or TXT.<br>
              Or click <b style="color:var(--cyan)">+</b> to write one now.<br><br>
              Every caption gets tagged, searchable,<br>and ready to deploy.
            </div>
          </div>
          <div class="cl-stats" id="cl-stats" style="display:none"></div>
        </div>

        <!-- SUB: MULTIPLIER -->
        <div id="cap-multiplier" style="display:none">
          <div class="row">
            <label class="lbl">Seed Phrase</label>
            <textarea id="seed-input" class="drop-target" data-drop="seed" style="height:100px" placeholder="Enter your core idea or pick from the Seed Library below... (or drag a caption here)"></textarea>
          </div>

          <div class="row">
            <label class="lbl">Seed Library</label>
            <select id="seed-cat" onchange="renderSeedLibrary()" style="margin-bottom:4px">
              <option value="all">All Themes</option>
              <option value="mindset">Mindset / Will</option>
              <option value="truth">Truth / Clarity</option>
              <option value="courage">Courage / Trust</option>
              <option value="discipline">Discipline / Focus</option>
              <option value="manifesto">Manifesto Lines</option>
              <option value="training">Training / Movement</option>
              <option value="vulnerability">Vulnerability / Growth</option>
            </select>
            <div id="seed-lib" style="max-height:140px;overflow-y:auto;border:1px solid var(--border);border-radius:3px;padding:2px"></div>
          </div>

          <div class="row">
            <label class="lbl">Voice Mode</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px" id="voice-grid">
              <div class="voice-card selected" data-v="teacher" onclick="setVoiceCard(this)">
                <div class="vc-name">Teacher</div>
                <div class="vc-desc">Warm, clear, guiding</div>
                <div class="vc-bar"><div class="vc-bar-fill" style="width:50%"></div></div>
              </div>
              <div class="voice-card" data-v="raw" onclick="setVoiceCard(this)">
                <div class="vc-name">Raw</div>
                <div class="vc-desc">Unfiltered, street, real</div>
                <div class="vc-bar"><div class="vc-bar-fill" style="width:85%"></div></div>
              </div>
              <div class="voice-card" data-v="prophet" onclick="setVoiceCard(this)">
                <div class="vc-name">Prophet</div>
                <div class="vc-desc">Certain, visionary, bold</div>
                <div class="vc-bar"><div class="vc-bar-fill" style="width:75%"></div></div>
              </div>
              <div class="voice-card" data-v="rebel" onclick="setVoiceCard(this)">
                <div class="vc-name">Rebel</div>
                <div class="vc-desc">Against the grain, edgy</div>
                <div class="vc-bar"><div class="vc-bar-fill" style="width:90%"></div></div>
              </div>
              <div class="voice-card" data-v="mystic" onclick="setVoiceCard(this)">
                <div class="vc-name">Mystic</div>
                <div class="vc-desc">Cosmic, transcendent</div>
                <div class="vc-bar"><div class="vc-bar-fill" style="width:60%"></div></div>
              </div>
              <div class="voice-card" data-v="philosopher" onclick="setVoiceCard(this)">
                <div class="vc-name">Philosopher</div>
                <div class="vc-desc">Deep, layered, abstract</div>
                <div class="vc-bar"><div class="vc-bar-fill" style="width:55%"></div></div>
              </div>
              <div class="voice-card" data-v="companion" onclick="setVoiceCard(this)">
                <div class="vc-name">Companion</div>
                <div class="vc-desc">Beside you, intimate</div>
                <div class="vc-bar"><div class="vc-bar-fill" style="width:30%"></div></div>
              </div>
              <div class="voice-card" data-v="confessor" onclick="setVoiceCard(this)">
                <div class="vc-name">Confessor</div>
                <div class="vc-desc">Honest, vulnerable, no BS</div>
                <div class="vc-bar"><div class="vc-bar-fill" style="width:80%"></div></div>
              </div>
            </div>
          </div>

          <div class="row">
            <label class="lbl">Intensity & Tone</label>
            <div class="slider-card">
              <div class="slider-header">
                <span class="slider-name">Intensity</span>
                <span class="slider-value" id="sl-intensity-val">5</span>
              </div>
              <input type="range" id="sl-intensity" min="1" max="10" value="5" oninput="updateSliderUI('intensity',this.value)" style="background:linear-gradient(to right,rgba(168,85,247,0.2) 50%,rgba(255,255,255,0.06) 50%)">
              <div class="slider-labels"><span>whisper</span><span>nuclear</span></div>
              <div class="slider-level" id="sl-intensity-level">confident</div>
            </div>
            <div class="slider-card">
              <div class="slider-header">
                <span class="slider-name">Vulnerability</span>
                <span class="slider-value" id="sl-vuln-val">4</span>
              </div>
              <input type="range" id="sl-vuln" min="1" max="10" value="4" oninput="updateSliderUI('vuln',this.value)" style="background:linear-gradient(to right,rgba(168,85,247,0.2) 40%,rgba(255,255,255,0.06) 40%)">
              <div class="slider-labels"><span>guarded</span><span>exposed</span></div>
              <div class="slider-level" id="sl-vuln-level">open</div>
            </div>
            <div class="slider-card">
              <div class="slider-header">
                <span class="slider-name">Abstraction</span>
                <span class="slider-value" id="sl-abstract-val">4</span>
              </div>
              <input type="range" id="sl-abstract" min="1" max="10" value="4" oninput="updateSliderUI('abstract',this.value)" style="background:linear-gradient(to right,rgba(168,85,247,0.2) 40%,rgba(255,255,255,0.06) 40%)">
              <div class="slider-labels"><span>concrete</span><span>cosmic</span></div>
              <div class="slider-level" id="sl-abstract-level">practical</div>
            </div>
          </div>

          <div class="row">
            <label class="lbl">Framework Module</label>
            <div style="display:flex;gap:3px;flex-wrap:wrap">
              <button class="mode-btn active" data-fw="none" onclick="setFramework(this)">None</button>
              <button class="mode-btn" data-fw="fusion" onclick="setFramework(this)">Fusion</button>
              <button class="mode-btn" data-fw="expansion" onclick="setFramework(this)">Expansion</button>
              <button class="mode-btn" data-fw="contraction" onclick="setFramework(this)">Contraction</button>
              <button class="mode-btn" data-fw="recursive" onclick="setFramework(this)">Recursive</button>
            </div>
            <div id="fw-desc" style="font-size:8px;color:var(--text-muted);margin-top:4px;line-height:1.5;display:none"></div>
          </div>

          <div class="row">
            <label class="lbl">Platforms</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px">
              <label class="chk on"><input type="checkbox" data-pl="ig" checked><span>Instagram</span></label>
              <label class="chk on"><input type="checkbox" data-pl="email" checked><span>Email</span></label>
              <label class="chk on"><input type="checkbox" data-pl="yt" checked><span>YouTube</span></label>
              <label class="chk"><input type="checkbox" data-pl="twitter"><span>Twitter/X</span></label>
              <label class="chk"><input type="checkbox" data-pl="linkedin"><span>LinkedIn</span></label>
              <label class="chk"><input type="checkbox" data-pl="tiktok"><span>TikTok</span></label>
            </div>
          </div>
          <div style="display:flex;gap:4px">
            <button onclick="multiply()" class="btn btn-cyan" style="flex:1">Multiply Variants</button>
            <button onclick="multiplyAndSave()" class="btn btn-outline btn-sm" title="Multiply + save to library">+Lib</button>
          </div>
        </div>
      </div>

      <!-- ATOMIZER CONTROLS -->
      <div id="atom-ctrl" style="display:none">
        <div class="pipeline" id="atom-pipeline">
          <div class="pipeline-stage active" id="ps-ingest"><span class="ps-icon">/</span><span class="ps-label">Ingest</span></div>
          <div class="pipeline-stage" id="ps-parse"><span class="ps-icon">{ }</span><span class="ps-label">Parse</span></div>
          <div class="pipeline-stage" id="ps-classify"><span class="ps-icon">T</span><span class="ps-label">Classify</span></div>
          <div class="pipeline-stage" id="ps-index"><span class="ps-icon">#</span><span class="ps-label">Index</span></div>
          <div class="pipeline-stage" id="ps-ready"><span class="ps-icon">*</span><span class="ps-label">Ready</span></div>
        </div>
        <div class="atom-import" id="atom-drop" onclick="document.getElementById('atom-file').click()">
          <div class="ai-icon">/</div>
          <div class="ai-title">Drop any document to atomize</div>
          <div class="ai-sub">Extracts quotes, headings, paragraphs, lists, tables, code blocks</div>
          <div class="ai-formats"><span class="ai-fmt">PDF</span><span class="ai-fmt">MD</span><span class="ai-fmt">TXT</span><span class="ai-fmt">HTML</span></div>
        </div>
        <input type="file" id="atom-file" accept=".pdf,.md,.txt,.markdown,.text,.html" style="display:none" onchange="atomizeFile(this.files[0])">
        <div id="atom-source-info" style="display:none;padding:8px;background:var(--bg-base);border:1px solid var(--border);border-radius:3px;margin-bottom:8px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span id="atom-source-name" style="font-size:9px;color:var(--text-primary);font-weight:500"></span>
            <button class="btn btn-outline btn-sm" onclick="clearAtoms()">Clear</button>
          </div>
          <div id="atom-source-meta" style="font-size:8px;color:var(--text-muted);margin-top:3px"></div>
        </div>
        <div class="atom-filters" id="atom-filters"></div>
        <div class="atom-bulk" id="atom-bulk" style="display:none">
          <span style="font-size:8px;color:var(--text-muted)"><b id="atom-sel-count">0</b> selected</span>
          <button class="btn btn-primary btn-sm" onclick="bulkToCanvas()">To Canvas</button>
          <button class="btn btn-outline btn-sm" onclick="bulkToSeed()">To Seed</button>
          <button class="btn btn-outline btn-sm" onclick="bulkNewDoc()">New Doc</button>
          <button class="btn btn-outline btn-sm" onclick="bulkCopy()">Copy</button>
          <button class="btn btn-outline btn-sm" onclick="deselectAll()" style="margin-left:auto">Deselect</button>
        </div>
        <div class="atom-list" id="atom-list" style="max-height:calc(100vh - 360px);overflow-y:auto">
          <div style="padding:24px 16px;text-align:center;font-size:9px;color:var(--text-muted);line-height:2">
            <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;font-weight:500">Ingest. Atomize. Transform.</div>
            Drop any document above to break it<br>into reusable atomic units.<br><br>
            <span style="color:var(--accent)">Quotes</span> / <span style="color:var(--cyan)">Headings</span> / <span style="color:var(--text-secondary)">Paragraphs</span><br>
            <span style="color:var(--green)">Lists</span> / <span style="color:var(--amber)">Tables</span> / Code / Images<br><br>
            Each atom can be sent to the canvas,<br>saved as a seed, copied, or exported.
          </div>
        </div>
        <div class="atom-stats" id="atom-stats" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- PREVIEW -->
  <div class="preview">
    <div class="preview-hdr">
      <span class="title" id="preview-title">Live Preview</span>
      <div class="preview-toolbar" id="preview-toolbar">
        <button class="btn-icon" onclick="execCmd('bold')" title="Bold"><b>B</b></button>
        <button class="btn-icon" onclick="execCmd('italic')" title="Italic"><i>I</i></button>
        <button class="btn-icon" onclick="execCmd('underline')" title="Underline"><u>U</u></button>
        <button class="btn-icon" onclick="execCmd('strikeThrough')" title="Strikethrough"><s>S</s></button>
        <span class="tb-sep"></span>
        <select onchange="execCmd('fontSize',this.value);this.selectedIndex=0" style="width:50px;padding:3px;font-size:8px;background:var(--bg-base);border:1px solid var(--border);color:var(--text-muted);border-radius:3px;font-family:var(--mono)" title="Font size">
          <option value="">Size</option>
          <option value="1">Small</option>
          <option value="3">Normal</option>
          <option value="5">Large</option>
          <option value="7">XL</option>
        </select>
        <span class="tb-sep"></span>
        <button class="btn-icon" onclick="execBlock('h1')" title="H1">1</button>
        <button class="btn-icon" onclick="execBlock('h2')" title="H2">2</button>
        <button class="btn-icon" onclick="execBlock('h3')" title="H3">3</button>
        <span class="tb-sep"></span>
        <button class="btn-icon" onclick="execCmd('justifyLeft')" title="Align left">L</button>
        <button class="btn-icon" onclick="execCmd('justifyCenter')" title="Align center">C</button>
        <button class="btn-icon" onclick="execCmd('justifyRight')" title="Align right">R</button>
        <span class="tb-sep"></span>
        <button class="btn-icon" onclick="execCmd('insertUnorderedList')" title="Bullet list">*</button>
        <button class="btn-icon" onclick="execCmd('insertOrderedList')" title="Numbered list">#</button>
        <button class="btn-icon" onclick="execCmd('formatBlock','blockquote')" title="Quote">"</button>
        <button class="btn-icon" onclick="execCmd('indent')" title="Indent">-></button>
        <button class="btn-icon" onclick="execCmd('outdent')" title="Outdent"><-</button>
        <button class="btn-icon" onclick="insertLink()" title="Insert link">Lnk</button>
        <button class="btn-icon" onclick="insertHR()" title="Rule">--</button>
        <button class="btn-icon" onclick="insertPageBreak()" title="Page break">||</button>
        <span class="tb-sep"></span>
        <button class="btn-icon" onclick="insertImage()" title="Insert image">Img</button>
        <button class="btn-icon" onclick="openTblModal()" title="Insert table">Tbl</button>
        <input type="file" id="img-input" accept="image/*" style="display:none" onchange="handleImage(this.files[0])">
        <input type="color" id="color-input" style="display:none" onchange="execCmd('foreColor',this.value)">
        <button class="btn-icon" onclick="document.getElementById('color-input').click()" title="Text color" style="position:relative">A<span style="position:absolute;bottom:2px;left:4px;right:4px;height:2px;background:var(--accent);border-radius:1px"></span></button>
        <div style="position:relative;display:inline-block">
          <button class="btn-icon" onclick="toggleQuickInsert()" title="Quick insert blocks">+B</button>
          <div class="qi-menu" id="qi-menu">
            <div class="qi-item" onclick="insertCallout('info')"><span class="qi-icon" style="color:#3b82f6">i</span> Info Callout</div>
            <div class="qi-item" onclick="insertCallout('tip')"><span class="qi-icon" style="color:#22c55e">*</span> Tip Callout</div>
            <div class="qi-item" onclick="insertCallout('warning')"><span class="qi-icon" style="color:#f59e0b">!</span> Warning Callout</div>
            <div class="qi-item" onclick="insertCallout('fire')"><span class="qi-icon" style="color:#ef4444">~</span> Important Callout</div>
            <div class="qi-item" onclick="insertCodeBlock()"><span class="qi-icon">{}</span> Code Block</div>
            <div class="qi-item" onclick="insertLabeledDivider()"><span class="qi-icon">--</span> Labeled Divider</div>
            <div class="qi-item" onclick="insertColumns()"><span class="qi-icon">||</span> 2-Column Layout</div>
          </div>
        </div>
        <span class="tb-sep"></span>
        <button class="btn-icon" onclick="toggleFind()" title="Find & Replace (Cmd+F)">F/R</button>
        <button class="btn-icon" onclick="generateTOC()" title="Insert Table of Contents">TOC</button>
        <button class="btn-icon" onclick="openVersions()" title="Version history">H</button>
        <span class="tb-sep"></span>
        <button class="btn-icon" onclick="execCmd('removeFormat')" title="Clear formatting">Clr</button>
        <button class="btn-icon" onclick="toggleFullscreen()" title="Fullscreen" id="fs-btn">FS</button>
        <div class="zoom-bar">
          <button class="btn-icon" onclick="zoom(-10)" title="Zoom out">-</button>
          <span class="zb" id="zoom-val">100%</span>
          <button class="btn-icon" onclick="zoom(10)" title="Zoom in">+</button>
          <button class="btn-icon" onclick="zoom(0)" title="Reset zoom">R</button>
        </div>
      </div>
    </div>
    <div class="find-bar" id="find-bar">
      <input type="text" id="find-input" placeholder="Find..." oninput="findInCanvas()">
      <input type="text" id="replace-input" placeholder="Replace..." style="width:140px">
      <button class="btn btn-outline btn-sm" onclick="replaceOne()">Replace</button>
      <button class="btn btn-outline btn-sm" onclick="replaceAll()">All</button>
      <span class="find-count" id="find-count"></span>
      <button class="btn-icon" onclick="toggleFind()" style="margin-left:auto;font-size:8px">x</button>
    </div>
    <div class="preview-body" id="preview-body">
      <div id="pdf-wrap" class="drop-target canvas-drop-zone" data-drop="canvas">
        <div class="pdf-canvas tpl-saturno" id="canvas" contenteditable="true" data-placeholder="Start writing... or paste content here. Everything you type becomes exportable as PDF, HTML, Markdown, or plain text.">
          <h1>Content Beast</h1>
          <h2>By Gabo Saturno</h2>
          <p>Select a preset, pick from the seed library, or just start typing. Your words, any format.</p>
          <div class="pdf-footer">CONTENT BEAST / saturnomovement.com</div>
        </div>
        <div class="page-est" id="page-est">~ 1 page (A4)</div>
      </div>
      <div id="cap-output" style="display:none"></div>
      <div id="cl-preview" style="display:none;padding:16px">
        <div style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:12px">Caption Preview</div>
        <div id="cl-preview-content" style="font-size:13px;color:var(--text-primary);line-height:1.8;font-family:var(--sans);white-space:pre-wrap"></div>
        <div id="cl-preview-meta" style="font-size:8px;color:var(--text-muted);margin-top:16px;padding-top:8px;border-top:1px solid var(--border)"></div>
      </div>
      <div id="atom-preview" style="display:none;padding:8px">
        <div style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px">Atom Preview</div>
        <div id="atom-preview-content" style="font-size:11px;color:var(--text-secondary);line-height:1.7;font-family:var(--sans)"></div>
      </div>
    </div>
    <div class="wc-bar" id="wc-bar">
      <span>Words: <b id="wc-words">0</b></span>
      <span>Chars: <b id="wc-chars">0</b></span>
      <span>Pages: <b id="wc-pages">~1</b></span>
      <span>Read: <b id="wc-read">~1 min</b></span>
    </div>
  </div>

</div>

<div class="ftr">
  <span>CONTENT BEAST v6.5 — by Saturno Movement</span>
  <span>Cmd+K: Commands / Cmd+S: Save / Cmd+Shift+S: Export / Cmd+N: New / Cmd+F: Find</span>
</div>

</div>

<div class="mobile-nav" id="mobile-nav">
  <button class="mobile-tab active" onclick="mobileTab('preview',this)">Preview</button>
  <button class="mobile-tab" onclick="mobileTab('ctrl',this)">Controls</button>
  <button class="mobile-tab" onclick="mobileTab('lib',this)">Library</button>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="file-input" accept=".md,.txt,.markdown,.text" style="display:none" onchange="handleFile(this.files[0])">

<!-- EXPORT SETTINGS MODAL -->
<div class="export-overlay" id="export-overlay" onclick="closeExport()"></div>
<div class="export-panel" id="export-panel">
  <h3>Export Document</h3>
  <div class="export-row"><label>Format</label>
    <div class="export-formats" id="ex-formats">
      <button class="ef-btn active" onclick="setExportFormat('pdf')"><span class="ef-icon">PDF</span><span class="ef-label">Print-ready</span></button>
      <button class="ef-btn" onclick="setExportFormat('html')"><span class="ef-icon">HTML</span><span class="ef-label">Web page</span></button>
      <button class="ef-btn" onclick="setExportFormat('md')"><span class="ef-icon">MD</span><span class="ef-label">Markdown</span></button>
      <button class="ef-btn" onclick="setExportFormat('txt')"><span class="ef-icon">TXT</span><span class="ef-label">Plain text</span></button>
    </div>
  </div>
  <div id="pdf-settings">
    <div class="export-row"><label>Paper Size</label><select id="ex-paper"><option value="a4">A4 (210x297mm)</option><option value="letter">Letter (8.5x11in)</option><option value="legal">Legal (8.5x14in)</option></select></div>
    <div class="export-row"><label>Orientation</label><select id="ex-orient"><option value="portrait">Portrait</option><option value="landscape">Landscape</option></select></div>
    <div class="export-row"><label>Top Margin (mm)</label><input type="number" id="ex-mt" value="12" min="0" max="50"></div>
    <div class="export-row"><label>Side Margins (mm)</label><input type="number" id="ex-ms" value="12" min="0" max="50"></div>
    <div class="export-row"><label>Bottom Margin (mm)</label><input type="number" id="ex-mb" value="16" min="0" max="50"></div>
    <div class="export-row"><label>Quality</label><select id="ex-quality"><option value="2">High (2x)</option><option value="3">Ultra (3x)</option><option value="1">Standard (1x)</option></select></div>
    <div class="export-row"><label>Include Page Numbers</label><select id="ex-pagenum"><option value="yes">Yes</option><option value="no">No</option></select></div>
  </div>
  <div style="display:flex;gap:6px;margin-top:16px">
    <button class="btn btn-primary" style="flex:1" id="ex-action-btn" onclick="runExport()">Export PDF</button>
    <button class="btn btn-outline" style="flex:1" onclick="closeExport()">Cancel</button>
  </div>
</div>

<!-- COMMAND PALETTE -->
<div class="cmd-overlay" id="cmd-overlay" onclick="closeCmd()"></div>
<div class="cmd-palette" id="cmd-palette">
  <input type="text" id="cmd-input" placeholder="Type a command..." oninput="filterCmd()" onkeydown="cmdKeyHandler(event)">
  <div class="cmd-results" id="cmd-results"></div>
</div>

<!-- SHORTCUTS HELP -->
<div class="export-overlay" id="sc-overlay" onclick="closeShortcuts()"></div>
<div class="shortcuts-modal" id="sc-modal">
  <h3>Keyboard Shortcuts</h3>
  <div class="sc-row"><span class="sc-desc">Command Palette</span><span class="sc-key">Cmd+K</span></div>
  <div class="sc-row"><span class="sc-desc">Save document</span><span class="sc-key">Cmd+S</span></div>
  <div class="sc-row"><span class="sc-desc">Export PDF</span><span class="sc-key">Cmd+Shift+S</span></div>
  <div class="sc-row"><span class="sc-desc">New document</span><span class="sc-key">Cmd+N</span></div>
  <div class="sc-row"><span class="sc-desc">Find & Replace</span><span class="sc-key">Cmd+F</span></div>
  <div class="sc-row"><span class="sc-desc">Print</span><span class="sc-key">Cmd+P</span></div>
  <div class="sc-row"><span class="sc-desc">Show this help</span><span class="sc-key">Cmd+/</span></div>
  <div class="sc-row"><span class="sc-desc">Close modal / Exit fullscreen</span><span class="sc-key">Esc</span></div>
  <div style="margin-top:16px">
    <h3 style="margin-bottom:8px">Canvas Editing</h3>
    <div class="sc-row"><span class="sc-desc">Bold</span><span class="sc-key">Cmd+B</span></div>
    <div class="sc-row"><span class="sc-desc">Italic</span><span class="sc-key">Cmd+I</span></div>
    <div class="sc-row"><span class="sc-desc">Underline</span><span class="sc-key">Cmd+U</span></div>
    <div class="sc-row"><span class="sc-desc">Undo</span><span class="sc-key">Cmd+Z</span></div>
    <div class="sc-row"><span class="sc-desc">Redo</span><span class="sc-key">Cmd+Shift+Z</span></div>
  </div>
  <div style="text-align:center;margin-top:16px">
    <button class="btn btn-outline btn-sm" onclick="closeShortcuts()">Close</button>
  </div>
</div>

<!-- TABLE INSERT MODAL -->
<div class="export-overlay" id="tbl-overlay" onclick="closeTblModal()"></div>
<div class="tbl-modal" id="tbl-modal">
  <h3 style="font-size:10px;font-weight:600;color:var(--text-primary);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:8px">Insert Table</h3>
  <div style="font-size:8px;color:var(--text-muted);margin-bottom:6px">Select size: <span id="tbl-size">0 x 0</span></div>
  <div class="tbl-grid-pick" id="tbl-grid"></div>
  <div style="display:flex;gap:6px">
    <button class="btn btn-primary btn-sm" style="flex:1" onclick="insertTable()">Insert</button>
    <button class="btn btn-outline btn-sm" style="flex:1" onclick="closeTblModal()">Cancel</button>
  </div>
</div>

<!-- VERSION HISTORY PANEL -->
<div class="ver-panel" id="ver-panel">
  <div class="ver-panel-hdr">
    <h3>Version History</h3>
    <button class="btn-icon" onclick="closeVersions()" style="font-size:8px">x</button>
  </div>
  <div style="padding:8px 12px;border-bottom:1px solid var(--border)">
    <button class="btn btn-outline btn-sm btn-block" onclick="saveVersion()">Save Snapshot</button>
  </div>
  <div class="ver-list" id="ver-list">
    <div style="padding:16px;text-align:center;font-size:9px;color:var(--text-muted)">No snapshots yet</div>
  </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
const STORE_KEY = 'content-beast-docs';
let docs = [];
let activeDocId = null;
let currentTpl = 'tpl-saturno';
let currentLv = '';
let currentVoice = 'teacher';
let saveTimer = null;
let zoomLevel = 100;
let tblRows = 0, tblCols = 0;
const VER_KEY = 'content-beast-versions';

// ============================================================
// PERSISTENCE
// ============================================================
function loadDocs() {
  try { docs = JSON.parse(localStorage.getItem(STORE_KEY) || '[]'); } catch(e) { docs = []; }
  if (!docs.length) { createDoc('Untitled', '', 'tpl-saturno', ''); }
  renderLibrary();
  if (!activeDocId || !docs.find(d => d.id === activeDocId)) {
    switchDoc(docs[0].id);
  }
}

function saveDocs() {
  snapshotActive();
  localStorage.setItem(STORE_KEY, JSON.stringify(docs));
  flashSave();
}

function flashSave() {
  const ind = document.getElementById('save-ind');
  ind.style.opacity = '1';
  ind.classList.add('save-pulse');
  clearTimeout(ind._t);
  ind._t = setTimeout(() => { ind.style.opacity = '0'; ind.classList.remove('save-pulse'); }, 1500);
}

function scheduleSave() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(saveDocs, 800);
}

// ============================================================
// DOCUMENT MANAGEMENT
// ============================================================
function createDoc(title, content, tpl, lv) {
  const doc = {
    id: 'doc_' + Date.now(),
    title: title || 'Untitled',
    author: 'Gabo Saturno',
    content: content || '',
    tpl: tpl || 'tpl-saturno',
    level: lv || '',
    canvasHTML: '',
    created: new Date().toISOString(),
    updated: new Date().toISOString()
  };
  docs.unshift(doc);
  saveDocs();
  renderLibrary();
  return doc;
}

function newDoc() {
  const doc = createDoc('Untitled', '', currentTpl, '');
  switchDoc(doc.id);
}

function deleteDoc(id) {
  if (docs.length <= 1) { toast('Cannot delete last document'); return; }
  if (!confirm('Delete this document?')) return;
  docs = docs.filter(d => d.id !== id);
  saveDocs();
  renderLibrary();
  if (activeDocId === id) switchDoc(docs[0].id);
}

function duplicateDoc(id) {
  const src = docs.find(d => d.id === id);
  if (!src) return;
  const doc = createDoc(src.title + ' (copy)', src.content, src.tpl, src.level);
  doc.canvasHTML = src.canvasHTML;
  saveDocs();
  renderLibrary();
  switchDoc(doc.id);
}

function switchDoc(id) {
  snapshotActive();
  activeDocId = id;
  const doc = docs.find(d => d.id === id);
  if (!doc) return;

  document.getElementById('f-title').value = doc.title;
  document.getElementById('f-author').value = doc.author;
  document.getElementById('f-content').value = doc.content;
  currentTpl = doc.tpl || 'tpl-saturno';
  currentLv = doc.level || '';

  document.querySelectorAll('[data-tpl]').forEach(b => b.classList.toggle('active', b.dataset.tpl === currentTpl));
  document.querySelectorAll('[data-lv]').forEach(b => b.classList.toggle('active', b.dataset.lv === currentLv));

  if (doc.canvasHTML) {
    const canvas = document.getElementById('canvas');
    canvas.className = 'pdf-canvas ' + currentTpl;
    canvas.innerHTML = doc.canvasHTML;
  } else {
    renderPreview();
  }

  renderLibrary();
}

function snapshotActive() {
  if (!activeDocId) return;
  const doc = docs.find(d => d.id === activeDocId);
  if (!doc) return;
  doc.title = document.getElementById('f-title').value || 'Untitled';
  doc.author = document.getElementById('f-author').value || '';
  doc.content = document.getElementById('f-content').value || '';
  doc.tpl = currentTpl;
  doc.level = currentLv;
  doc.canvasHTML = document.getElementById('canvas').innerHTML;
  doc.updated = new Date().toISOString();
}

// ============================================================
// LIBRARY RENDER
// ============================================================
function renderLibrary() {
  const el = document.getElementById('lib-list');
  if (!docs.length) { el.innerHTML = '<div class="lib-empty">No documents yet.<br><br>Hit <b style="color:var(--accent)">Cmd+N</b> to start writing<br>or drop a file on the Atomizer<br>to break it into gold.</div>'; return; }
  el.innerHTML = docs.map(d => {
    const active = d.id === activeDocId;
    const date = new Date(d.updated).toLocaleDateString();
    return '<div class="lib-item' + (active ? ' active' : '') + '" onclick="switchDoc(\'' + d.id + '\')" draggable="true" data-docid="' + d.id + '">' +
      '<div class="li-title">' + esc(d.title) + '</div>' +
      '<div class="li-meta">' + date + (d.level ? ' / ' + d.level : '') +
      '<span style="float:right;display:flex;gap:4px">' +
      '<span onclick="event.stopPropagation();duplicateDoc(\'' + d.id + '\')" style="cursor:pointer" title="Duplicate">+</span>' +
      '<span onclick="event.stopPropagation();deleteDoc(\'' + d.id + '\')" style="cursor:pointer;color:var(--red)" title="Delete">x</span>' +
      '</span></div></div>';
  }).join('');
  // Wire drag-to-reorder
  el.querySelectorAll('.lib-item').forEach(item => {
    item.addEventListener('dragstart', function(e) {
      e.dataTransfer.setData('text/plain', this.dataset.docid);
      this.style.opacity = '0.4';
    });
    item.addEventListener('dragend', function() { this.style.opacity = '1'; });
    item.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.style.borderTop = '2px solid var(--accent)';
    });
    item.addEventListener('dragleave', function() { this.style.borderTop = ''; });
    item.addEventListener('drop', function(e) {
      e.preventDefault();
      this.style.borderTop = '';
      const draggedId = e.dataTransfer.getData('text/plain');
      const targetId = this.dataset.docid;
      if (draggedId === targetId) return;
      const draggedIdx = docs.findIndex(d => d.id === draggedId);
      const targetIdx = docs.findIndex(d => d.id === targetId);
      if (draggedIdx < 0 || targetIdx < 0) return;
      const [moved] = docs.splice(draggedIdx, 1);
      docs.splice(targetIdx, 0, moved);
      saveDocs();
      renderLibrary();
    });
  });
}

// ============================================================
// PREVIEW RENDERING
// ============================================================
function renderPreview() {
  const title = document.getElementById('f-title').value || 'Untitled';
  const author = document.getElementById('f-author').value || '';
  const content = document.getElementById('f-content').value;
  const canvas = document.getElementById('canvas');

  canvas.className = 'pdf-canvas ' + currentTpl;

  let html = '';
  if (currentLv && currentTpl === 'tpl-saturno') {
    html += '<div class="level-badge lv-' + currentLv + '">' + currentLv.toUpperCase() + '</div>\n';
  }
  html += '<h1>' + esc(title) + '</h1>\n';
  if (author) html += '<h2>By ' + esc(author) + '</h2>\n';

  if (content.trim()) {
    html += md(content);
  } else {
    html += '<p style="color:#999;font-style:italic">Paste content or select a preset. Click the preview to edit directly.</p>';
  }
  html += '\n<div class="pdf-footer">CONTENT BEAST / saturnomovement.com / ' + new Date().toLocaleDateString() + '</div>';
  canvas.innerHTML = html;
  estPages();
  updateWordCount();
  scheduleSave();
}

function onFieldChange() {
  renderPreview();
}

// ============================================================
// MARKDOWN PARSER
// ============================================================
function md(text) {
  // Tables
  text = text.replace(/^(\|.+\|)\n(\|[-:| ]+\|)\n((?:\|.+\|\n?)*)/gm, function(m, header, sep, body) {
    const hCells = header.split('|').filter(c => c.trim());
    const bRows = body.trim().split('\n').map(r => r.split('|').filter(c => c.trim()));
    let t = '<table><thead><tr>' + hCells.map(c => '<th>' + c.trim() + '</th>').join('') + '</tr></thead><tbody>';
    bRows.forEach(row => { t += '<tr>' + row.map(c => '<td>' + c.trim() + '</td>').join('') + '</tr>'; });
    return t + '</tbody></table>';
  });

  return text
    .replace(/^#### (.*$)/gm, '<h4>$1</h4>')
    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
    .replace(/^# (.*$)/gm, '<h1 style="font-size:22px;font-weight:700;margin-top:24px;margin-bottom:8px">$1</h1>')
    .replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>')
    .replace(/^---$/gm, '<hr>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/`(.*?)`/g, '<code>$1</code>')
    .replace(/^\d+\. (.*$)/gm, '<li style="margin-left:20px;list-style:decimal">$1</li>')
    .replace(/^- (.*$)/gm, '<li style="margin-left:20px">$1</li>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/\n/g, '<br>');
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function estPages() {
  const c = document.getElementById('canvas');
  const pages = Math.max(1, Math.ceil(c.scrollHeight / 1050));
  document.getElementById('page-est').textContent = '~ ' + pages + ' page' + (pages > 1 ? 's' : '') + ' (A4)';
}

// ============================================================
// RICH TEXT COMMANDS (for canvas editing)
// ============================================================
function execCmd(cmd, val) { document.execCommand(cmd, false, val || null); }
function execBlock(tag) { document.execCommand('formatBlock', false, '<' + tag + '>'); }
function insertLink() {
  const url = prompt('URL:', 'https://');
  if (!url) return;
  const text = prompt('Link text:', '') || url;
  document.execCommand('insertHTML', false, '<a href="' + url.replace(/"/g, '&quot;') + '" style="color:#06b6d4;text-decoration:underline">' + esc(text) + '</a>');
  scheduleSave();
}

function insertHR() {
  const sel = window.getSelection();
  if (sel.rangeCount) {
    const range = sel.getRangeAt(0);
    const hr = document.createElement('hr');
    range.insertNode(hr);
    range.setStartAfter(hr);
    sel.removeAllRanges();
    sel.addRange(range);
  }
}

// ============================================================
// TEMPLATE & LEVEL
// ============================================================
function setTpl(btn) {
  currentTpl = btn.dataset.tpl;
  document.querySelectorAll('[data-tpl]').forEach(b => b.classList.toggle('active', b === btn));
  document.getElementById('canvas').className = 'pdf-canvas ' + currentTpl;
  scheduleSave();
  toast('Template: ' + (currentTpl || 'white'));
}

function setLv(btn) {
  currentLv = btn.dataset.lv;
  document.querySelectorAll('[data-lv]').forEach(b => b.classList.toggle('active', b === btn));
  renderPreview();
}

// ============================================================
// PRESETS
// ============================================================
const PRESETS = {
  program: {
    title: 'Calisthenics Foundation Phase 1',
    content: '# CALISTHENICS FOUNDATION -- PHASE 1\n## Week 1-4 / Training Block A\n\n### UPPER BODY PUSH\n- Pseudo Planche Push-ups -- 4x8-12 / RER 3\n- Pike Push-ups (Elevated) -- 3x8-10 / RER 3\n- Diamond Push-ups -- 3x10-15 / RER 2\n- Dips (Parallel Bars) -- 3x6-10 / RER 3\n\n### UPPER BODY PULL\n- Pull-ups (Pronated) -- 4x5-8 / RER 3\n- Australian Rows (Rings) -- 3x10-12 / RER 2\n- Chin-ups (Supinated) -- 3x6-8 / RER 3\n\n### CORE\n- L-Sit Progression -- 4x15-30s hold\n- Dragon Flag Negatives -- 3x5-8\n- Hollow Body Hold -- 3x30-45s\n\n### PROGRAMMING NOTES\n\n| Variable | Week 1-2 | Week 3-4 | Deload |\n|----------|----------|----------|--------|\n| Volume | 100% | 110% | 60% |\n| RER | 4-5 | 2-3 | 5+ |\n| Intensity | Moderate | High | Low |\n\n- RER = Reps Estimated in Reserve\n- Start conservative -- you should feel like you could do 3 more reps\n- Log every set. Track RER honestly.\n- Deload in Week 5: reduce volume 40%, maintain intensity',
    level: 'foundation'
  },
  level: {
    title: 'Saturno Movement -- Level Guide',
    content: '# LEVEL PROGRESSION SYSTEM\n## The Saturno Method\n\n### FOUNDATION (Months 1-6)\nBuild the base. Master the basics. Own every rep.\n- Push-up variations mastered\n- Pull-up: 8+ strict reps\n- L-Sit: 15s+ hold\n- Handstand: Wall-assisted 30s+\n- Pistol Squat: 5+ per leg\n\n---\n\n### INTERMEDIATE (Months 6-18)\nConnect the dots. Skill acquisition begins.\n- Muscle-Up: 3+ clean reps\n- Handstand Push-up: 5+ wall-assisted\n- Front Lever: Tuck hold 10s+\n- Back Lever: Full hold 5s+\n- Planche: Tuck hold 5s+\n\n---\n\n### ADVANCED (Months 18-36)\nThe refinement phase. Movement quality over quantity.\n- Planche Push-ups: Tuck 5+ reps\n- Front Lever Rows: 5+ reps\n- Freestanding Handstand: 15s+\n- One Arm Pull-up: Negative controlled\n- Human Flag: 5s+ hold\n\n---\n\n### ELITE (36+ Months)\nArtistry. The body as instrument.\n- Full Planche: 5s+ hold\n- Iron Cross: Controlled entry\n- One Arm Handstand: 5s+\n- Maltese: Entry position\n- Victorian Cross: Progression work',
    level: ''
  },
  framework: {
    title: 'The Saturno System -- Training Framework',
    content: '# THE SATURNO SYSTEM\n## A Framework for Intelligent Training\n\n> The goal is not to train hard. The goal is to train smart, consistently, for decades.\n\n### PRINCIPLE 1: PROGRESSIVE OVERLOAD VIA RER\n\n| Week | RER | Intensity | Feel |\n|------|-----|-----------|------|\n| 1 | 4-5 | Easy | Building momentum |\n| 2 | 3-4 | Moderate | Finding groove |\n| 3 | 2-3 | Hard | Pushing boundaries |\n| 4 | 1-2 | Near-max | Testing limits |\n| 5 | -- | DELOAD | Recovery |\n\n### PRINCIPLE 2: MOVEMENT QUALITY FIRST\nOne perfect rep > ten sloppy reps.\n- Full range of motion, always\n- Control the eccentric (3s minimum)\n- Pause at end ranges\n- Breathe with intention\n\n### PRINCIPLE 3: SKILL + STRENGTH = MASTERY\nSkills are not separate from strength.\n- Practice skills when fresh (start of session)\n- Build strength after skill work\n- Connect movements -- planche push-ups, not just planche holds\n- Every session has a skill component\n\n### PRINCIPLE 4: RECOVERY IS TRAINING\nYou do not grow in the gym.\n- Sleep 7-9 hours (non-negotiable)\n- Mobility work daily (10-15 min)\n- Deload every 4-8 weeks\n- Listen to your body -- adjust, do not push through pain',
    level: ''
  },
  transcript: {
    title: 'Video Transcript -- Key Points',
    content: '# VIDEO TITLE\n## Channel: Saturno Movement\n\n### KEY POINTS\n- Point one from the video\n- Point two from the video\n- Point three from the video\n- Point four from the video\n\n### SUMMARY\nPaste the full summary here. This section captures the core message of the video in 2-3 paragraphs.\n\nThe second paragraph continues the thought.\n\n### ACTION ITEMS\n1. First action step the viewer should take\n2. Second action step\n3. Third action step\n\n### TIMESTAMPS\n\n| Time | Topic |\n|------|-------|\n| 0:00 | Introduction |\n| 2:15 | Main topic |\n| 5:30 | Key exercise demo |\n| 8:45 | Programming recommendations |\n| 11:00 | Closing thoughts |',
    level: ''
  },
  cover: {
    title: 'Saturno Movement',
    content: '',
    level: '',
    isCover: true
  }
};

function loadPreset(key, el) {
  const p = PRESETS[key];
  if (!p) return;
  document.querySelectorAll('.preset-card').forEach(c => c.classList.remove('active'));
  if (el) el.classList.add('active');
  document.getElementById('f-title').value = p.title;
  document.getElementById('f-content').value = p.content || '';
  if (p.level) { currentLv = p.level; document.querySelectorAll('[data-lv]').forEach(b => b.classList.toggle('active', b.dataset.lv === currentLv)); }
  if (p.isCover) {
    renderCoverPage(p.title);
  } else {
    renderPreview();
  }
  toast('Loaded: ' + key);
}

function renderCoverPage(title) {
  const canvas = document.getElementById('canvas');
  canvas.className = 'pdf-canvas ' + currentTpl;
  const author = document.getElementById('f-author').value || 'Gabo Saturno';
  canvas.innerHTML = '<div class="cover-page">' +
    '<h1>' + esc(title || 'Untitled') + '</h1>' +
    '<div class="cover-sub">Movement Mastery System</div>' +
    '<div class="cover-line"></div>' +
    '<div class="cover-author">' + esc(author) + '</div>' +
    '<div class="cover-brand">SATURNO MOVEMENT / saturnomovement.com</div>' +
    '</div>';
  estPages();
  scheduleSave();
}

// ============================================================
// FILE IMPORT / DROP
// ============================================================
function importFile() { document.getElementById('file-input').click(); }

function handleFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    const title = file.name.replace(/\.(md|txt|markdown|text)$/i, '').replace(/[_-]/g, ' ');
    const doc = createDoc(title, text, currentTpl, '');
    switchDoc(doc.id);
    renderPreview();
    toast('Imported: ' + file.name);
  };
  reader.readAsText(file);
}

// Drag-drop on drop zone
const dz = document.getElementById('drop-zone');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('over'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('over');
  if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});

// Global drag-drop
document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('drop', e => {
  e.preventDefault();
  if (e.dataTransfer.files.length && e.dataTransfer.files[0].name.match(/\.(md|txt|markdown)$/i)) {
    handleFile(e.dataTransfer.files[0]);
  }
});

// ============================================================
// PDF DOWNLOAD
// ============================================================
function downloadPDF() {
  snapshotActive();
  const canvas = document.getElementById('canvas');
  const title = document.getElementById('f-title').value || 'document';
  setStatus('GENERATING...', 'busy');

  const isDark = currentTpl === 'tpl-saturno' || currentTpl === 'tpl-dark';
  const opt = {
    margin: [12, 12, 16, 12],
    filename: title.replace(/[^a-zA-Z0-9_\- ]/g, '_').replace(/\s+/g, '_') + '.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, backgroundColor: isDark ? '#0a0a0a' : '#ffffff' },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
  };

  html2pdf().set(opt).from(canvas).save().then(() => {
    toast('Downloaded: ' + opt.filename);
    setStatus('READY', 'ok');
  }).catch(err => {
    toast('Error: ' + err.message);
    setStatus('ERROR', 'busy');
  });
}

function downloadHTML() {
  const canvas = document.getElementById('canvas');
  const title = document.getElementById('f-title').value || 'document';
  const html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + esc(title) + '</title><style>body{font-family:Sora,system-ui,sans-serif;max-width:800px;margin:40px auto;padding:20px;line-height:1.7}h1{font-size:28px}h2{color:#666}h3{text-transform:uppercase;letter-spacing:0.04em}table{width:100%;border-collapse:collapse}th,td{padding:8px;border:1px solid #ddd;text-align:left}th{background:#f8f8f8}</style></head><body>' + canvas.innerHTML + '</body></html>';
  const blob = new Blob([html], { type: 'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = title.replace(/[^a-zA-Z0-9_\- ]/g, '_') + '.html';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('HTML downloaded');
}

// ============================================================
// CAPTION MULTIPLIER
// ============================================================
function setVoice(btn) {
  currentVoice = btn.dataset.v;
  document.querySelectorAll('[data-v]').forEach(b => b.classList.toggle('active', b === btn));
}

document.querySelectorAll('.chk').forEach(label => {
  label.addEventListener('click', function(e) {
    if (e.target.tagName !== 'INPUT') { const cb = this.querySelector('input'); cb.checked = !cb.checked; }
    this.classList.toggle('on', this.querySelector('input').checked);
  });
});

// ============================================================
// SEED LIBRARY (from Gabo's Writing OS - 16 PDFs)
// ============================================================
const SEED_LIBRARY = [
  // MINDSET / WILL
  {t:'mindset',q:'Every choice costs something. Choosing nothing costs everything.'},
  {t:'mindset',q:'Comfortable is the most expensive choice you can make -- it costs you every version of yourself you will never meet.'},
  {t:'mindset',q:'Will is not a muscle -- it is a structure.'},
  {t:'mindset',q:'Purpose generates clarity. Clarity enables elimination. Elimination reveals will. Will becomes identity.'},
  {t:'mindset',q:'The fundamental error: believing we must become what we already are.'},
  {t:'mindset',q:'Perfectionism is not protection. It is procrastination with a better outfit.'},
  {t:'mindset',q:'The only map you need is the one you draw while walking.'},
  // TRUTH / CLARITY
  {t:'truth',q:'The truth is the only foundation that does not crack under pressure.'},
  {t:'truth',q:'The collapse IS the comeback. The moment you stop pretending is the moment you start building something real.'},
  {t:'truth',q:'Solitude sharpens you.'},
  {t:'truth',q:'The same consciousness that built the cage cannot unlock it.'},
  {t:'truth',q:'Distance is not separation. It is the perspective needed to see what was never solid to begin with.'},
  {t:'truth',q:'The goal is not perfection. The goal is consciousness. Knowing why you write how you write.'},
  // COURAGE / TRUST
  {t:'courage',q:'Logic builds cages. Trust builds wings.'},
  {t:'courage',q:'The jump is the proof, not the landing.'},
  {t:'courage',q:'Courage says I can handle this. Faith says I do not know if I can, but I am walking anyway. One is admirable. The other is transformational.'},
  {t:'courage',q:'Trust the backward motion. Bring a compass. The gate is waiting.'},
  {t:'courage',q:'Surrender is not passivity -- it is the most active form of trust.'},
  // DISCIPLINE / FOCUS
  {t:'discipline',q:'Discipline is just self-trust in action.'},
  {t:'discipline',q:'The body never lies. It keeps the score.'},
  {t:'discipline',q:'Discipline is remembering, not forcing.'},
  {t:'discipline',q:'Michelangelo did not add David to marble. He eliminated everything that was not David.'},
  {t:'discipline',q:'Discipline is just the art of becoming that person obsessively.'},
  // MANIFESTO LINES
  {t:'manifesto',q:'We rise not by getting strong but by remembering we were never broken.'},
  {t:'manifesto',q:'We become not by adding layers but by revealing who was always there.'},
  {t:'manifesto',q:'Stop trying to become who you already are.'},
  {t:'manifesto',q:'The revolution is not becoming someone new. It is remembering who you have always been.'},
  {t:'manifesto',q:'We heal not by fixing what is broken but by becoming whole enough that the broken pieces find their place.'},
  {t:'manifesto',q:'We teach not by knowing more but by remembering less -- by unlearning the noise that made us forget the signal.'},
  // TRAINING / MOVEMENT
  {t:'training',q:'Movement is not exercise. It is the physical expression of how you think.'},
  {t:'training',q:'You are not weak. You are untrained.'},
  {t:'training',q:'You can fake confidence. You can not fake a handstand.'},
  {t:'training',q:'One perfect rep is worth more than ten sloppy ones.'},
  {t:'training',q:'The body is the last honest mirror.'},
  // VULNERABILITY / GROWTH
  {t:'vulnerability',q:'The warrior is not someone who never falls -- it is someone who maintains love for themselves while falling.'},
  {t:'vulnerability',q:'If you can not handle your own worst, you do not deserve your own best.'},
  {t:'vulnerability',q:'The pendulum swings. Always. The darker it gets, the brighter it is about to become. But only if you stay with yourself through the fall.'},
  {t:'vulnerability',q:'These past few months were not a break. They were a total collapse and breakdown. But they were also a rebuild.'},
  {t:'vulnerability',q:'The mess IS the masterpiece.'},
  {t:'vulnerability',q:'You ARE the territory.'},
  {t:'vulnerability',q:'Obligation is fear dressed in productivity. Guidance is peace dressed in movement.'},
  // EFFORT & FOCUS (from Gabo Quotes Master List)
  {t:'discipline',q:'Most people want the result. Almost nobody wants the process.'},
  {t:'discipline',q:'Stop switching goals every week. Depth beats width every time.'},
  {t:'discipline',q:'Success is boring. Same actions. Same effort. Every day.'},
  {t:'discipline',q:'Nothing moves until you do. No one is coming to save you.'},
  {t:'discipline',q:'Real work starts when it gets hard. Everything before that was warming up.'},
  {t:'discipline',q:'If you can not focus, it is not important to you.'},
  {t:'discipline',q:'Pick one thing. Make it undeniable. Then pick the next.'},
  {t:'discipline',q:'Progress does not care how you feel. It cares what you do.'},
  {t:'discipline',q:'Everything you want is on the other side of the thing you keep avoiding.'},
  {t:'truth',q:'Most people are not confused. They are avoiding what they already know.'},
  {t:'truth',q:'You will not find clarity in thinking. You will find it in doing.'},
  {t:'truth',q:'Stop asking if you are capable. Ask if you are willing.'},
  {t:'truth',q:'Everyone wants to win. Few are willing to prepare.'},
  {t:'truth',q:'Presence is not a vibe. It is a practice.'},
  // TRUST (from Trust Before Proof)
  {t:'courage',q:'Your current capacity is not your permanent ceiling.'},
  {t:'courage',q:'Confidence is not earned through mastery. It is built through beginning.'},
  {t:'courage',q:'Trust especially when it does not make sense.'},
  {t:'courage',q:'You do not need to see the whole staircase. Just the next step.'},
  {t:'courage',q:'Every master was once a disaster who refused to wait for permission.'},
  // WE FORGET (from We Forget expansion)
  {t:'truth',q:'Everything we see is simply a reflection of our own internal state.'},
  {t:'truth',q:'We invest an incredible amount of time trying to fix our external environment, failing to realize that is fundamentally the wrong place to work on.'},
  {t:'truth',q:'It is only when we make peace with our current reality that we make room for other realities to play out.'},
  // READINESS (from Nobody's Ready)
  {t:'courage',q:'Nobody is ready. Some people just go for it anyway.'},
  {t:'courage',q:'Comfortable is the most expensive choice you can make. It costs you every version of yourself you will never meet.'},
  {t:'courage',q:'You will not find yourself by arriving somewhere safe. You will find yourself by being willing to get lost.'},
  {t:'manifesto',q:'Every choice costs something. Choosing nothing costs everything.'},
  {t:'manifesto',q:'The only map you need is the one you draw while walking.'}
];

// ============================================================
// GABO CONTENT LIBRARY — Full caption bank for auto-seeding
// Source files: We Rise Not By, Trust Before Proof, Rhyming Synthesis
// ============================================================
const GABO_CAPTIONS = [
  // === WE RISE NOT BY — MANIFESTO COUPLETS (V3: The Perfect Mix) ===
  {t:'manifesto',q:'We rise not by getting strong but by remembering we were never broken.',s:'we-rise-not-by'},
  {t:'manifesto',q:'We heal not by trying to but by acting as we already did.',s:'we-rise-not-by'},
  {t:'manifesto',q:'We love not by earning it but by remembering we always deserved it.',s:'we-rise-not-by'},
  {t:'manifesto',q:'We find fulfillment not by chasing more but by recognizing what already fills us.',s:'we-rise-not-by'},
  {t:'manifesto',q:'We grow not by doing more but by forgetting that which was never ours.',s:'we-rise-not-by'},
  {t:'manifesto',q:'We feel gratitude not by counting blessings but by dropping the story that we lack.',s:'we-rise-not-by'},
  {t:'manifesto',q:'We find peace not by searching for it but by allowing it to be seen.',s:'we-rise-not-by'},
  {t:'manifesto',q:'We become not by adding layers but by revealing who was always there.',s:'we-rise-not-by'},
  // V1/V2 unique couplets
  {t:'manifesto',q:'We teach not by showing the path but by leading every step of it.',s:'we-rise-not-by'},
  {t:'manifesto',q:'We discover purpose not by seeking meaning but by trusting what moves through us.',s:'we-rise-not-by'},
  {t:'manifesto',q:'We create connection not by performing worthiness but by allowing ourselves to be seen.',s:'we-rise-not-by'},
  {t:'manifesto',q:'We become not by transforming into someone else but by forgetting who we pretended to be.',s:'we-rise-not-by'},
  {t:'manifesto',q:'We rise not by building strength but by remembering we were never broken.',s:'we-rise-not-by'},
  {t:'manifesto',q:'We heal not by fixing wounds but by acting from wholeness.',s:'we-rise-not-by'},
  {t:'manifesto',q:'We find fulfillment not by chasing more but by recognizing what already fills us.',s:'we-rise-not-by'},
  // === RAW TRUTH ===
  {t:'truth',q:'Stop trying to become who you already are.',s:'we-rise-not-by'},
  {t:'truth',q:'You\'re carrying weapons against enemies that don\'t exist. Building strength for battles that ended years ago. Searching for peace that\'s been here the whole time, underneath the noise.',s:'we-rise-not-by'},
  {t:'truth',q:'We rise not by getting stronger. We rise by remembering we were never weak.',s:'we-rise-not-by'},
  {t:'truth',q:'Drop the weight. Trust the being. Stop defending against a war that exists only in your head.',s:'we-rise-not-by'},
  {t:'truth',q:'The bomb you\'ve been carrying? Made of stories that were never yours.',s:'we-rise-not-by'},
  {t:'truth',q:'The strength you\'ve been building? For battles that ended before you were born.',s:'we-rise-not-by'},
  {t:'truth',q:'The peace you\'ve been seeking? Been here the entire time.',s:'we-rise-not-by'},
  {t:'truth',q:'Everything else is just remembering.',s:'we-rise-not-by'},
  // === TRUST BEFORE PROOF — CORE PASSAGES ===
  {t:'courage',q:'Base your direction not in your current capacity to tolerate the load associated with the road ahead. Anchor yourself in a deep knowing that you will figure it out along the way.',s:'trust-before-proof'},
  {t:'courage',q:'Collect data as experience usually wins over imagination\u2014yet, do not wait for competence to build confidence. If that was the case, nothing great would\'ve ever been achieved.',s:'trust-before-proof'},
  {t:'courage',q:'Trust when you haven\'t even proven it to yourself. Trust when you have an absurd amount of proof. Trust when you see your mind not trusting.',s:'trust-before-proof'},
  {t:'courage',q:'Because trust doesn\'t come from logic. It comes\u2014it grows\u2014every time you jump even when, and especially when, it doesn\'t make fucking sense.',s:'trust-before-proof'},
  {t:'courage',q:'Courage is walking on solid floor. Faith is walking in turbulent water. Not because you can, but because you know how not to drown even in impossible situations.',s:'trust-before-proof'},
  // Expanded additions
  {t:'courage',q:'The weight you can carry today is not the weight you\'ll carry tomorrow.',s:'trust-before-proof'},
  {t:'courage',q:'Confidence isn\'t earned through mastery. It\'s built through the audacity to begin before you\'re ready.',s:'trust-before-proof'},
  {t:'courage',q:'If competence had to come first, nothing great would\'ve ever been achieved. Every master was once a disaster who refused to wait for permission.',s:'trust-before-proof'},
  {t:'courage',q:'The jump is the proof. Not the landing.',s:'trust-before-proof'},
  {t:'courage',q:'Courage says: \'I can handle this.\' Faith says: \'I don\'t know if I can, but I\'m walking anyway.\' One is admirable. The other is transformational.',s:'trust-before-proof'},
  {t:'courage',q:'You don\'t need to see the whole staircase. You need to trust that your foot knows how to find the next step\u2014even in the dark. Especially in the dark.',s:'trust-before-proof'},
  // === TRUST BEFORE PROOF — ONE-LINERS (20) ===
  {t:'courage',q:'Your current capacity is not your permanent ceiling.',s:'trust-quotes'},
  {t:'courage',q:'The load grows lighter when you stop measuring it.',s:'trust-quotes'},
  {t:'courage',q:'Direction requires conviction, not calculation.',s:'trust-quotes'},
  {t:'courage',q:'You will figure it out\u2014you always have.',s:'trust-quotes'},
  {t:'discipline',q:'Confidence isn\'t earned through mastery\u2014it\'s built through beginning.',s:'trust-quotes'},
  {t:'discipline',q:'Do not wait for competence to build confidence.',s:'trust-quotes'},
  {t:'discipline',q:'Every master was once a disaster who refused to wait.',s:'trust-quotes'},
  {t:'discipline',q:'Experience wins over imagination\u2014but imagination starts the race.',s:'trust-quotes'},
  {t:'courage',q:'Trust when your mind refuses to.',s:'trust-quotes'},
  {t:'courage',q:'The jump is the proof, not the landing.',s:'trust-quotes'},
  {t:'courage',q:'Trust doesn\'t come from logic\u2014it grows from leaps.',s:'trust-quotes'},
  {t:'courage',q:'Trust especially when it doesn\'t make fucking sense.',s:'trust-quotes'},
  {t:'courage',q:'Courage walks on solid ground; faith walks on water.',s:'trust-quotes'},
  {t:'courage',q:'Courage says \'I can.\' Faith says \'I will anyway.\'',s:'trust-quotes'},
  {t:'courage',q:'Faith is the audacity to move without certainty.',s:'trust-quotes'},
  {t:'courage',q:'You don\'t need to see the staircase\u2014just the next step.',s:'trust-quotes'},
  {t:'courage',q:'The weight shifts when you stop calculating if you can carry it.',s:'trust-quotes'},
  {t:'courage',q:'Begin before you\'re ready\u2014readiness is a lie.',s:'trust-quotes'},
  {t:'courage',q:'Movement is the only proof that matters.',s:'trust-quotes'},
  {t:'courage',q:'Walk anyway. That\'s the whole teaching.',s:'trust-quotes'},
  // === TRUST BEFORE PROOF — TWO-LINERS (20) ===
  {t:'courage',q:'Your capacity today is not your capacity tomorrow. Stop measuring weight you haven\'t lifted yet.',s:'trust-quotes'},
  {t:'courage',q:'Don\'t base your direction on what you can tolerate now. Base it on who you\'re becoming.',s:'trust-quotes'},
  {t:'courage',q:'The road ahead looks impossible from here. But \'here\' isn\'t where you\'ll walk it from.',s:'trust-quotes'},
  {t:'courage',q:'Anchor yourself in knowing, not hoping. Knowing survives what hope cannot.',s:'trust-quotes'},
  {t:'discipline',q:'Competence comes from doing. Confidence comes from starting. Start first. The rest follows.',s:'trust-quotes'},
  {t:'discipline',q:'If competence had to come first, nothing great would exist. The greatest things were built by beginners.',s:'trust-quotes'},
  {t:'discipline',q:'Experience usually wins over imagination. But imagination is what gets you to experience.',s:'trust-quotes'},
  {t:'discipline',q:'Don\'t wait for permission from your own mastery. Mastery is built by the unpermissioned.',s:'trust-quotes'},
  {t:'courage',q:'Trust when you haven\'t proven it to yourself. Especially then.',s:'trust-quotes'},
  {t:'courage',q:'Trust doesn\'t come from evidence. It comes from jumping before you have any.',s:'trust-quotes'},
  {t:'courage',q:'Trust when it makes no logical sense. Logic builds cages. Trust builds wings.',s:'trust-quotes'},
  {t:'courage',q:'Your mind will not trust. Trust anyway\u2014that\'s not your mind\'s job.',s:'trust-quotes'},
  {t:'courage',q:'The proof you\'re looking for is on the other side of the jump. Stop waiting for it on this side.',s:'trust-quotes'},
  {t:'courage',q:'Courage handles what it can see. Faith handles what it can\'t.',s:'trust-quotes'},
  {t:'courage',q:'Courage is walking on solid floor. Faith is walking on turbulent water.',s:'trust-quotes'},
  {t:'courage',q:'One is admirable. The other is transformational. Choose transformation.',s:'trust-quotes'},
  {t:'courage',q:'Courage says: \'I can handle this.\' Faith says: \'I don\'t know, but I\'m walking anyway.\'',s:'trust-quotes'},
  {t:'courage',q:'You don\'t need to see the whole staircase. Your foot knows how to find the next step.',s:'trust-quotes'},
  {t:'courage',q:'The dark doesn\'t stop the climb. It just changes what you use to navigate.',s:'trust-quotes'},
  {t:'vulnerability',q:'Walking in the dark isn\'t about sight. It\'s about trust in your own feet.',s:'trust-quotes'},
  // === TRUST BEFORE PROOF — THREE-LINERS (20) ===
  {t:'courage',q:'The load associated with the road ahead looks unbearable. But you\'re not measuring with the strength you\'ll have when you get there. That version of you is waiting to be built by the walk itself.',s:'trust-quotes'},
  {t:'courage',q:'Anchor yourself in deep knowing. Not the knowing that comes from evidence. The knowing that comes from having survived everything so far.',s:'trust-quotes'},
  {t:'courage',q:'Your current capacity is a snapshot, not a verdict. The you who will walk that road doesn\'t exist yet. And won\'t\u2014until you start walking.',s:'trust-quotes'},
  {t:'courage',q:'Direction isn\'t about tolerating what\'s ahead. It\'s about trusting what\'s inside. That\'s never been measured accurately by fear.',s:'trust-quotes'},
  {t:'discipline',q:'Collect data. Experience wins over imagination. But don\'t wait for competence to build confidence. Confidence is the precondition, not the reward.',s:'trust-quotes'},
  {t:'discipline',q:'If waiting for readiness was required, nothing great would\'ve ever been achieved. Every cathedral was started by someone who couldn\'t see the ceiling.',s:'trust-quotes'},
  {t:'discipline',q:'Mastery comes from accumulation. Confidence comes from audacity. One follows competence. The other creates it.',s:'trust-quotes'},
  {t:'discipline',q:'The greatest achievements weren\'t built by the ready. They were built by the willing. Willingness is the only prerequisite.',s:'trust-quotes'},
  {t:'courage',q:'Trust when you haven\'t proven it to yourself. Trust when you have absurd amounts of proof. Trust when you see your mind not trusting.',s:'trust-quotes'},
  {t:'courage',q:'Trust doesn\'t come from logic. It comes\u2014it grows\u2014every time you jump. Even when, especially when, it doesn\'t make fucking sense.',s:'trust-quotes'},
  {t:'courage',q:'Your mind will present evidence against the leap. It\'s doing its job. Your job is to jump anyway.',s:'trust-quotes'},
  {t:'courage',q:'The proof isn\'t found before the jump. The proof IS the jump. Everything after is just confirmation.',s:'trust-quotes'},
  {t:'courage',q:'Logic demands certainty before movement. Trust demands movement before certainty. One keeps you safe. The other keeps you alive.',s:'trust-quotes'},
  {t:'courage',q:'Courage is walking on solid floor. Faith is walking in turbulent water. Not because you can, but because you know how not to drown.',s:'trust-quotes'},
  {t:'courage',q:'Courage operates in the known. Faith operates in the unknown. Transformation only lives in one of those territories.',s:'trust-quotes'},
  {t:'courage',q:'Courage says: \'I\'ve done this before.\' Faith says: \'I haven\'t, but I trust myself to figure it out.\' The second voice is the one that builds new worlds.',s:'trust-quotes'},
  {t:'courage',q:'Courage is admirable. Faith is transformational. One handles challenges. The other creates possibilities. Stop admiring. Start transforming.',s:'trust-quotes'},
  {t:'courage',q:'You don\'t need to see the whole staircase. You need to trust your foot knows the next step. Even in the dark. Especially in the dark.',s:'trust-quotes'},
  {t:'vulnerability',q:'Walking in impossible situations isn\'t about ability. It\'s about the accumulated proof that you\'ve survived every impossible so far. That\'s not confidence. That\'s data.',s:'trust-quotes'},
  {t:'courage',q:'The jump is never logical. The landing is never guaranteed. But the growth is always certain.',s:'trust-quotes'},
  // === RHYMING SYNTHESIS — POEMS ===
  {t:'poetry',q:'When purpose finds its way to you,\nClarity follows, clear and true.\nWhat doesn\'t serve begins to fade,\nRoom for will is gently made.\nYour will becomes who you will be,\nIdentity flows naturally.\nAnd momentum starts to grow,\nLike rivers that have learned to flow.\nNo force required, no strain,\nJust gentle, steady, healing rain.\nThe architecture builds with care,\nFoundation solid, everywhere.\nWhat storms may come, what winds may blow,\nThe structure holds, the roots below\nRemember who you chose to be,\nUnbreakable, eternally.',s:'rhyming-synthesis',v:'soft'},
  {t:'poetry',q:'Purpose cuts through every lie\nElimination starts today\nWill emerges, standing high\nIdentity shows you the way\nClarity slices through the noise\nMomentum builds with every choice\nArchitecture doesn\'t bend\nUnbreakable until the end\nStop waiting for permission\nStart your systematic mission\nCut away what doesn\'t serve\nBuild the will that won\'t observe\nThe storm\u2014it only tests what\'s real\nFoundation that was built with steel\nPurpose, clarity, and will\nUnbreakable, unmoving still',s:'rhyming-synthesis',v:'sharp'},
  {t:'poetry',q:'You spiral back to purpose true\nRound and round the pattern goes\nEach time clarity breaks through\nThe architecture simply grows\nEliminate what held you down\nThe spiral deepens every turn\nWill rises up from common ground\nIdentity is what you learn\nAnd when you think you\'ve lost your way\nThe spiral brings you back again\nMomentum building day by day\nUnbreakable through joy and pain\nReturn, return, but not the same\nEach spiral carries deeper truth\nThe architecture stays the game\nBut you emerge with clearer proof\nThat will was always who you are\nIdentity your truest name\nBuilt to last through near and far\nUnbreakable\u2014that\'s why you came',s:'rhyming-synthesis',v:'spiral'},
  {t:'poetry',q:'Purpose real, cuts through the feel of being lost\nClarity costs, but pays back what you thought you\'d lost\nElimination, no vacation from the truth\nWill uncouth, breaks through, shows proof of deeper youth\nIdentity, the entity that can\'t be faked\nMomentum baked into the will that won\'t be slaked\nArchitecture, not just lectures about strength\nAt length, the building goes to any length\nTo hold, to mold, to be bold enough to last\nThe past can\'t blast what\'s built to hold steadfast\nUnbreakable, unshakeable, unmistakeable\nThe will you build is real, achievable, believable',s:'rhyming-synthesis',v:'raw'},
  {t:'poetry',q:'Purpose flows like water clear\nClarity runs crystal near\nWill springs up without a fear\nAnd momentum starts to build\nIdentity takes shape and form\nArchitecture rides the storm\nNothing here can bring you harm\nWhen momentum starts to build\nElimination like the tide\nWashes what you cannot hide\nStrength emerging from inside\nAs momentum starts to build\nWill becomes the solid ground\nPurpose makes the truest sound\nClarity is what you\'ve found\nWhen momentum starts to build',s:'rhyming-synthesis',v:'lyrical'},
  {t:'poetry',q:'Let me teach you how will\'s made\nPurpose first must find its place\nClarity cuts through the shade\nGives elimination space\nWhat doesn\'t serve must go away\nWill emerges from what\'s left\nIdentity shows you the way\nOf power that can\'t be theft\nMomentum builds on solid ground\nArchitecture holds the line\nUnbreakable will is found\nWhen purpose and clarity align\nThis isn\'t theory, this is fact\nThis isn\'t hope, this is the way\nBuild your will through conscious act\nUnbreakable every day',s:'rhyming-synthesis',v:'teacher'},
  {t:'poetry',q:'You will find your purpose true\nClarity will cut right through\nElimination comes for you\nThis is what your will will do\nYou will see identity\nBorn from who you choose to be\nMomentum flows like destiny\nThis is what your will will do\nYou will build what can\'t be shaken\nArchitecture never broken\nWords I speak are never spoken\nThis is what your will will do\nUnbreakable was always planned\nWritten in your heart and hand\nNow you finally understand\nThis is what your will will do',s:'rhyming-synthesis',v:'prophet'},
  {t:'poetry',q:'Fuck their rules about how will should feel\nMine builds different, mine builds real\nPurpose that they can\'t control\nClarity that saves my soul\nEliminate their expectations\nBuild my own damn foundations\nWill that doesn\'t need permission\nIdentity through self-admission\nMomentum they can\'t understand\nArchitecture built by hand\nNot their plans, not their design\nUnbreakable by my design\nLet them wonder how I built\nWhat they couldn\'t\u2014zero guilt\nPurpose, clarity, and will\nUnbreakable, I\'m building still',s:'rhyming-synthesis',v:'rebel'},
  {t:'poetry',q:'Purpose flows through time and space\nClarity beyond the mind\nWill transcends the human race\nIdentity finds its true place\nWhile souls and stars become aligned\nMomentum of celestial kind\nArchitecture of the soul\nSpans dimensions, spans all time\nWill eternal, spirit whole\nPlaying out its destined role\nIn rhythm and eternal rhyme\nUnbreakable by design sublime\nConsciousness builds what flesh cannot\nFoundation deeper than the earth\nPurpose is what time forgot\nIdentity that can\'t be caught\nMomentum from spiritual birth\nUnbreakable of infinite worth',s:'rhyming-synthesis',v:'mystic'}
];

let currentFramework = 'none';

function renderSeedLibrary() {
  const cat = document.getElementById('seed-cat').value;
  const el = document.getElementById('seed-lib');
  const seeds = cat === 'all' ? SEED_LIBRARY : SEED_LIBRARY.filter(s => s.t === cat);
  el.innerHTML = seeds.map(s =>
    '<div class="seed-item" onclick="loadSeed(this)" data-seed="' + s.q.replace(/"/g, '&quot;') + '">' +
    '<span class="seed-tag">' + s.t + '</span>' + esc(s.q.length > 80 ? s.q.substring(0,80) + '...' : s.q) + '</div>'
  ).join('');
}

function loadSeed(el) {
  document.getElementById('seed-input').value = el.dataset.seed;
  toast('Seed loaded');
}

// ============================================================
// FRAMEWORK MODULES
// ============================================================
const FRAMEWORKS = {
  none: { desc: '' },
  fusion: {
    desc: 'FUSION PROTOCOL: Merge 2 ideas into 1 unified piece. Phase 1: Core Extraction / Phase 2: Harmonic Analysis / Phase 3: Architectural Fusion / Phase 4: Integration Refinement. Techniques: Conceptual Braiding, Paradox Stacking, Causal Chaining, Voice Mode Orchestration, Metaphor Hybridization.',
    transform: (s) => {
      const mid = Math.floor(s.length / 2);
      const seedA = s.substring(0, mid).trim();
      const seedB = s.substring(mid).trim();
      return 'FUSION: ' + seedA + ' + ' + seedB + '\n\nWhen these two truths collide, what emerges is greater than either:\n\n' + s + '\n\nThe architecture of this idea demands both halves -- without one, the other collapses into cliche.';
    }
  },
  expansion: {
    desc: 'CONTENT EXPANSION ENGINE V3: Take a seed and expand 4x. Techniques: Conceptual Unpacking (explain the WHY), Mirror Deepening (5 angles), Paradox Isolation (find contradictions), Concept Transplanting (apply to new domains).',
    transform: (s) => {
      return 'EXPANSION: Unpacking the core\n\n' + s + '\n\n[MIRROR 1 - Training]\n' + s.replace(/\./g, ' -- translated through the body.') +
        '\n\n[MIRROR 2 - Relationships]\n' + s.replace(/\./g, ' -- the same pattern lives in how we love.') +
        '\n\n[MIRROR 3 - Business]\n' + s.replace(/\./g, ' -- this is the principle behind every real venture.') +
        '\n\n[PARADOX]\nThe opposite is also true. And the tension between both IS the lesson.';
    }
  },
  contraction: {
    desc: 'CONTRACTION SYNTHESIS: Take a long piece and compress to its essence. Extract the 10-act story arc, contract into 3 voice variations (Raw, Philosopher, Prophet), produce a 47-word synthesis seed, 5 poems, 20 quotes.',
    transform: (s) => {
      const words = s.split(/\s+/);
      const core = words.slice(0, Math.min(47, words.length)).join(' ');
      return 'CONTRACTION SEED (47 words or less):\n' + core + '\n\n[RAW VERSION]\n' + core.replace(/[.!?]/g, '. Period.') +
        '\n\n[PHILOSOPHER VERSION]\nTo understand this fully: ' + core +
        '\n\n[PROPHET VERSION]\nListen. ' + core + ' And this changes everything.';
    }
  },
  recursive: {
    desc: 'RECURSIVE EXPANSION: Multi-stage multiplication. Stage 1: Fuse 2 seeds. Stage 2: Expand the fusion. Stage 3: Extract 60 quotes (20 raw + 20 philosophical + 20 deployment-ready). Stage 4: Map to 8 platforms.',
    transform: (s) => {
      return 'RECURSIVE STAGE 1 - Seed:\n' + s +
        '\n\nSTAGE 2 - Expansion:\nThe depth here is not in the words. It is in the architecture. ' + s + ' When you break this down to its molecular level, every syllable carries weight.' +
        '\n\nSTAGE 3 - Extracted Quotes:\n1. "' + s.split('.')[0].trim() + '."\n2. "The architecture of this truth is unshakeable."\n3. "When you see it, you can not unsee it."' +
        '\n\nSTAGE 4 - Deployment:\nIG: Hook with line 1 / Email: Full expansion / YT: 3-act structure / Twitter: Quote #1';
    }
  }
};

function setFramework(btn) {
  currentFramework = btn.dataset.fw;
  document.querySelectorAll('[data-fw]').forEach(b => b.classList.toggle('active', b === btn));
  const desc = document.getElementById('fw-desc');
  if (currentFramework !== 'none' && FRAMEWORKS[currentFramework]) {
    desc.textContent = FRAMEWORKS[currentFramework].desc;
    desc.style.display = '';
  } else {
    desc.style.display = 'none';
  }
}

// ============================================================
// CAPTION MULTIPLIER (V2 - 8 Voice Modes + Frameworks)
// ============================================================
function multiply() {
  let seed = document.getElementById('seed-input').value.trim();
  if (!seed) { toast('Enter a seed phrase or pick from library'); return; }
  const pls = []; document.querySelectorAll('[data-pl]:checked').forEach(cb => pls.push(cb.dataset.pl));
  if (!pls.length) { toast('Select a platform'); return; }

  // Apply framework transformation if selected
  if (currentFramework !== 'none' && FRAMEWORKS[currentFramework] && FRAMEWORKS[currentFramework].transform) {
    seed = FRAMEWORKS[currentFramework].transform(seed);
  }

  const S = {
    raw:{p:'',s:''},
    teacher:{p:'',s:'\n\nSave this for later.'},
    prophet:{p:'The truth is this:\n\n',s:'\n\nThis changes everything.'},
    rebel:{p:'Most people get this wrong.\n\n',s:'\n\nThink different.'},
    mystic:{p:'In the silence between reps...\n\n',s:''},
    philosopher:{p:'Consider this:\n\n',s:'\n\nSit with that.'},
    companion:{p:'I need you to hear this.\n\n',s:'\n\nYou are not alone in this.'},
    confessor:{p:'I will be honest with you.\n\n',s:'\n\nThat is the truth. Take it or leave it.'}
  };
  const F = {
    ig:{n:'Instagram',f:(s,t)=>t.p+s+t.s+'\n\n#Calisthenics #Movement #Mastery #SaturnoMovement'},
    email:{n:'Email',f:(s,t)=>{
      const subj = s.split('.')[0].trim().substring(0,60);
      return 'Subject: ' + subj + '\n\n'+t.p+s+t.s+'\n\nYour inbox is sacred, and I respect that deeply.\n\nReply and tell me what you think.\n\n-- Gabo\nSaturno Movement';
    }},
    yt:{n:'YouTube',f:(s,t)=>'[HOOK - 0:00]\n'+s.substring(0,200)+'\n\n[EXPAND - 0:15]\n'+t.p+s+t.s+'\n\n[CTA - End]\nIf this resonated, subscribe. We go deeper every week.'},
    twitter:{n:'Twitter/X',f:(s,t)=>t.p+(s.length>240?s.substring(0,240)+'...':s)+t.s},
    linkedin:{n:'LinkedIn',f:(s,t)=>t.p+s+t.s+'\n\n---\n\nWhat is your experience with this? Share below.'},
    tiktok:{n:'TikTok',f:(s,t)=>'[TEXT ON SCREEN]\n"'+s.substring(0,100)+'..."\n\n[VOICEOVER]\n'+t.p+s+t.s+'\n\n[CAPTION]\n'+s.substring(0,150)}
  };

  const style = S[currentVoice] || S.teacher;
  // Apply voice dials modifiers
  const iLvl = voiceDials.intensity || 5;
  const vLvl = voiceDials.vuln || 4;
  const aLvl = voiceDials.abstract || 4;
  // Dial context badge
  const dialBadge = '[' + SLIDER_LEVELS.intensity[iLvl-1] + ' / ' + SLIDER_LEVELS.vuln[vLvl-1] + ' / ' + SLIDER_LEVELS.abstract[aLvl-1] + ']';
  document.getElementById('cap-output').innerHTML = '<div style="padding:8px 0;margin-bottom:8px;font-size:8px;color:var(--text-muted);border-bottom:1px solid var(--border)"><b style="color:var(--accent)">' + currentVoice.toUpperCase() + '</b> ' + dialBadge + '</div>' + pls.map(p => {
    const f = F[p]; if (!f) return '';
    const c = f.f(seed, style);
    return '<div class="variant-card '+p+'"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-size:8px;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-muted)">'+f.n+'</span><button onclick="navigator.clipboard.writeText(this.parentElement.nextElementSibling.innerText);toast(\'Copied\')" class="btn btn-outline btn-sm">Copy</button></div><pre style="font-size:10px;color:var(--text-secondary);white-space:pre-wrap;line-height:1.6;font-family:var(--mono)">'+esc(c)+'</pre></div>';
  }).join('');
  toast(pls.length + ' variants generated' + (currentFramework !== 'none' ? ' (' + currentFramework + ' applied)' : ''));
}

// ============================================================
// MODE SWITCH
// ============================================================
let capSubMode = 'library';

function setCapSub(sub) {
  capSubMode = sub;
  document.querySelectorAll('.cap-subtab').forEach((b,i) => b.classList.toggle('active', (i===0&&sub==='library')||(i===1&&sub==='multiplier')));
  document.getElementById('cap-library').style.display = sub === 'library' ? '' : 'none';
  document.getElementById('cap-multiplier').style.display = sub === 'multiplier' ? '' : 'none';
  // Update preview area
  const isLib = sub === 'library';
  document.getElementById('cl-preview').style.display = isLib ? '' : 'none';
  document.getElementById('cap-output').style.display = isLib ? 'none' : '';
  document.getElementById('preview-title').textContent = isLib ? 'Caption Preview' : 'Variants';
}

function setMode(mode) {
  document.querySelectorAll('.hdr .tab-btn').forEach((b,i) => b.classList.toggle('active', (i===0&&mode==='pdf')||(i===1&&mode==='caption')||(i===2&&mode==='atomizer')));
  const ws = document.getElementById('workspace');
  ws.classList.remove('caption-mode');
  if (mode === 'caption') ws.classList.add('caption-mode');

  document.getElementById('pdf-ctrl').style.display = mode === 'pdf' ? '' : 'none';
  document.getElementById('cap-ctrl').style.display = mode === 'caption' ? '' : 'none';
  document.getElementById('atom-ctrl').style.display = mode === 'atomizer' ? '' : 'none';
  document.getElementById('pdf-wrap').style.display = mode === 'pdf' ? '' : 'none';
  document.getElementById('atom-preview').style.display = mode === 'atomizer' ? '' : 'none';
  // Caption mode has sub-modes
  if (mode === 'caption') {
    setCapSub(capSubMode);
  } else {
    document.getElementById('cap-output').style.display = 'none';
    document.getElementById('cl-preview').style.display = 'none';
  }
  const titles = {pdf:'PDF Controls',caption:'Captions',atomizer:'Document Atomizer'};
  const ptitles = {pdf:'Live Preview',caption:capSubMode==='library'?'Caption Preview':'Variants',atomizer:'Atom Preview'};
  document.getElementById('ctrl-title').textContent = titles[mode] || '';
  document.getElementById('preview-title').textContent = ptitles[mode] || '';
  document.getElementById('preview-toolbar').style.display = mode === 'pdf' ? '' : 'none';
}

// ============================================================
// UTILITIES
// ============================================================
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(t._t); t._t = setTimeout(() => t.classList.remove('show'), 2000);
}
function setStatus(text, type) {
  const el = document.getElementById('status');
  el.innerHTML = '<span style="width:5px;height:5px;border-radius:50%;background:currentColor;display:inline-block"></span> ' + text;
  el.className = 'status status-' + type;
}

// ============================================================
// AUTO-SAVE ON CANVAS EDIT + WORD COUNT
// ============================================================
document.getElementById('canvas').addEventListener('input', function() {
  scheduleSave();
  updateWordCount();
});

// ============================================================
// ZOOM
// ============================================================
function zoom(delta) {
  if (delta === 0) { zoomLevel = 100; }
  else { zoomLevel = Math.min(200, Math.max(50, zoomLevel + delta)); }
  document.getElementById('canvas').style.transform = 'scale(' + (zoomLevel / 100) + ')';
  document.getElementById('canvas').style.transformOrigin = 'top center';
  document.getElementById('zoom-val').textContent = zoomLevel + '%';
}

// ============================================================
// PAGE BREAK
// ============================================================
function insertPageBreak() {
  const canvas = document.getElementById('canvas');
  if (!canvas.contains(document.activeElement) && document.activeElement !== canvas) { canvas.focus(); }
  const sel = window.getSelection();
  if (sel.rangeCount) {
    const range = sel.getRangeAt(0);
    const pb = document.createElement('hr');
    pb.className = 'page-break';
    range.insertNode(pb);
    range.setStartAfter(pb);
    sel.removeAllRanges();
    sel.addRange(range);
  } else {
    canvas.insertAdjacentHTML('beforeend', '<hr class="page-break">');
  }
  scheduleSave();
}

// ============================================================
// IMAGE INSERT
// ============================================================
function insertImage() {
  document.getElementById('img-input').click();
}

function handleImage(file) {
  if (!file || !file.type.startsWith('image/')) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const canvas = document.getElementById('canvas');
    const img = document.createElement('img');
    img.src = e.target.result;
    img.style.maxWidth = '100%';
    img.alt = file.name;
    const sel = window.getSelection();
    if (sel.rangeCount && canvas.contains(sel.anchorNode)) {
      const range = sel.getRangeAt(0);
      range.insertNode(img);
      range.setStartAfter(img);
      sel.removeAllRanges();
      sel.addRange(range);
    } else {
      const footer = canvas.querySelector('.pdf-footer');
      if (footer) { canvas.insertBefore(img, footer); }
      else { canvas.appendChild(img); }
    }
    scheduleSave();
    toast('Image inserted');
  };
  reader.readAsDataURL(file);
  document.getElementById('img-input').value = '';
}

// ============================================================
// FULLSCREEN
// ============================================================
function toggleFullscreen() {
  document.body.classList.toggle('fullscreen-mode');
  const btn = document.getElementById('fs-btn');
  if (document.body.classList.contains('fullscreen-mode')) {
    btn.classList.add('active');
    btn.title = 'Exit fullscreen';
    toast('Fullscreen mode — press F to exit');
  } else {
    btn.classList.remove('active');
    btn.title = 'Fullscreen';
  }
}

// ============================================================
// EXPORT SETTINGS
// ============================================================
function openExport() {
  snapshotActive();
  document.getElementById('export-overlay').classList.add('open');
  document.getElementById('export-panel').classList.add('open');
}

function closeExport() {
  document.getElementById('export-overlay').classList.remove('open');
  document.getElementById('export-panel').classList.remove('open');
}

function exportPDF() {
  const canvas = document.getElementById('canvas');
  const title = document.getElementById('f-title').value || 'document';
  const paper = document.getElementById('ex-paper').value;
  const orient = document.getElementById('ex-orient').value;
  const mt = parseInt(document.getElementById('ex-mt').value) || 12;
  const ms = parseInt(document.getElementById('ex-ms').value) || 12;
  const mb = parseInt(document.getElementById('ex-mb').value) || 16;
  const quality = parseInt(document.getElementById('ex-quality').value) || 2;
  const pageNum = document.getElementById('ex-pagenum').value === 'yes';

  closeExport();
  setStatus('EXPORTING...', 'busy');

  const isDark = currentTpl === 'tpl-saturno' || currentTpl === 'tpl-dark';

  // Reset zoom for clean export
  const prevZoom = zoomLevel;
  if (zoomLevel !== 100) {
    canvas.style.transform = 'scale(1)';
  }

  const opt = {
    margin: [mt, ms, mb + (pageNum ? 6 : 0), ms],
    filename: title.replace(/[^a-zA-Z0-9_\- ]/g, '_').replace(/\s+/g, '_') + '.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: quality, useCORS: true, backgroundColor: isDark ? '#0a0a0a' : '#ffffff' },
    jsPDF: { unit: 'mm', format: paper, orientation: orient },
    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
  };

  const worker = html2pdf().set(opt).from(canvas);

  if (pageNum) {
    worker.toPdf().get('pdf').then(function(pdf) {
      const totalPages = pdf.internal.getNumberOfPages();
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      for (let i = 1; i <= totalPages; i++) {
        pdf.setPage(i);
        pdf.setFontSize(8);
        pdf.setTextColor(150);
        pdf.text('Page ' + i + ' of ' + totalPages, pageW / 2, pageH - 6, { align: 'center' });
      }
    }).save().then(done);
  } else {
    worker.save().then(done);
  }

  function done() {
    toast('Exported: ' + opt.filename);
    setStatus('READY', 'ok');
    if (prevZoom !== 100) { zoom(0); zoom(prevZoom - 100); }
  }
}

// ============================================================
// MULTI-FORMAT EXPORT
// ============================================================
let exportFormat = 'pdf';

function setExportFormat(fmt) {
  exportFormat = fmt;
  document.querySelectorAll('.ef-btn').forEach(b => b.classList.remove('active'));
  document.querySelector('.ef-btn[onclick*="' + fmt + '"]').classList.add('active');
  document.getElementById('pdf-settings').style.display = fmt === 'pdf' ? '' : 'none';
  const labels = {pdf:'Export PDF',html:'Export HTML',md:'Export Markdown',txt:'Export Text'};
  document.getElementById('ex-action-btn').textContent = labels[fmt] || 'Export';
}

function runExport() {
  if (exportFormat === 'pdf') return exportPDF();
  if (exportFormat === 'html') return exportAsHTML();
  if (exportFormat === 'md') return exportMarkdown();
  if (exportFormat === 'txt') return exportPlainText();
}

function exportAsHTML() {
  const canvas = document.getElementById('canvas');
  const title = document.getElementById('f-title').value || 'document';
  const isDark = currentTpl === 'tpl-saturno' || currentTpl === 'tpl-dark';
  const bg = isDark ? '#0a0a0a' : '#ffffff';
  const fg = isDark ? '#e2e8f0' : '#1a1a1a';
  const accent = isDark ? '#a855f7' : '#a855f7';
  const html = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${esc(title)}</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Sora',system-ui,sans-serif;max-width:800px;margin:40px auto;padding:40px;line-height:1.7;background:${bg};color:${fg}}
h1{font-size:28px;font-weight:700;margin-bottom:4px;line-height:1.2}
h2{font-size:13px;color:#888;margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid ${accent}}
h3{font-size:15px;font-weight:700;margin-top:24px;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.04em}
h4{font-size:13px;font-weight:600;margin-top:16px;margin-bottom:6px}
p{font-size:14px;margin-bottom:10px}
ul,ol{margin-left:20px;margin-bottom:10px}
li{font-size:14px;margin-bottom:3px}
strong{font-weight:700}
em{font-style:italic}
hr{border:none;border-top:1px solid ${isDark ? '#222' : '#ddd'};margin:20px 0}
blockquote{border-left:3px solid ${accent};padding:8px 16px;margin:12px 0;font-style:italic;opacity:0.85}
code{background:${isDark ? '#1a1a1a' : '#f4f4f5'};padding:1px 4px;border-radius:2px;font-family:'JetBrains Mono',monospace;font-size:13px}
table{width:100%;border-collapse:collapse;margin:12px 0}
th{background:${isDark ? '#111' : '#f8f8f8'};font-weight:600;text-align:left;padding:8px 10px;border:1px solid ${isDark ? '#222' : '#e5e5e5'};font-size:12px}
td{padding:6px 10px;border:1px solid ${isDark ? '#1a1a1a' : '#e5e5e5'}}
.pdf-footer{font-size:10px;color:#888;margin-top:40px;padding-top:12px;border-top:1px solid ${isDark ? '#1e293b' : '#eee'};font-family:'JetBrains Mono',monospace}
</style>
</head>
<body>
${canvas.innerHTML}
</body>
</html>`;
  closeExport();
  const blob = new Blob([html], { type: 'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = title.replace(/[^a-zA-Z0-9_\- ]/g, '_') + '.html';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('HTML exported: ' + a.download);
}

function exportMarkdown() {
  const canvas = document.getElementById('canvas');
  const title = document.getElementById('f-title').value || 'document';
  closeExport();
  let md = htmlToMarkdown(canvas.innerHTML);
  const blob = new Blob([md], { type: 'text/markdown' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = title.replace(/[^a-zA-Z0-9_\- ]/g, '_') + '.md';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('Markdown exported: ' + a.download);
}

function exportPlainText() {
  const canvas = document.getElementById('canvas');
  const title = document.getElementById('f-title').value || 'document';
  closeExport();
  const text = canvas.innerText || '';
  const blob = new Blob([text], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = title.replace(/[^a-zA-Z0-9_\- ]/g, '_') + '.txt';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('Text exported: ' + a.download);
}

function htmlToMarkdown(html) {
  let md = html;
  md = md.replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n');
  md = md.replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n');
  md = md.replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n');
  md = md.replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n\n');
  md = md.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**');
  md = md.replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**');
  md = md.replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*');
  md = md.replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*');
  md = md.replace(/<u[^>]*>(.*?)<\/u>/gi, '$1');
  md = md.replace(/<s[^>]*>(.*?)<\/s>/gi, '~~$1~~');
  md = md.replace(/<code[^>]*>(.*?)<\/code>/gi, '`$1`');
  md = md.replace(/<blockquote[^>]*>(.*?)<\/blockquote>/gi, '> $1\n\n');
  md = md.replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n');
  md = md.replace(/<hr[^>]*\/?>/gi, '\n---\n\n');
  md = md.replace(/<br[^>]*\/?>/gi, '\n');
  md = md.replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n');
  md = md.replace(/<div[^>]*>(.*?)<\/div>/gi, '$1\n');
  md = md.replace(/<[^>]+>/g, '');
  md = md.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&#39;/g, "'").replace(/&nbsp;/g, ' ');
  md = md.replace(/\n{3,}/g, '\n\n');
  return md.trim();
}

// ============================================================
// WORD COUNT
// ============================================================
function updateWordCount() {
  const canvas = document.getElementById('canvas');
  const text = canvas.innerText || '';
  const words = text.trim() ? text.trim().split(/\s+/).length : 0;
  const chars = text.length;
  const pages = Math.max(1, Math.ceil(canvas.scrollHeight / 1050));
  const readTime = Math.max(1, Math.ceil(words / 200));
  document.getElementById('wc-words').textContent = words;
  document.getElementById('wc-chars').textContent = chars;
  document.getElementById('wc-pages').textContent = '~' + pages;
  document.getElementById('wc-read').textContent = '~' + readTime + ' min';
  document.getElementById('page-est').textContent = '~ ' + pages + ' page' + (pages > 1 ? 's' : '') + ' (A4)';
}

// ============================================================
// FIND & REPLACE
// ============================================================
function toggleFind() {
  const bar = document.getElementById('find-bar');
  bar.classList.toggle('open');
  if (bar.classList.contains('open')) {
    document.getElementById('find-input').focus();
  } else {
    clearHighlights();
  }
}

function findInCanvas() {
  clearHighlights();
  const query = document.getElementById('find-input').value;
  if (!query) { document.getElementById('find-count').textContent = ''; return; }
  const canvas = document.getElementById('canvas');
  const walker = document.createTreeWalker(canvas, NodeFilter.SHOW_TEXT, null, false);
  let count = 0;
  const nodes = [];
  while (walker.nextNode()) { nodes.push(walker.currentNode); }
  nodes.forEach(node => {
    const idx = node.textContent.toLowerCase().indexOf(query.toLowerCase());
    if (idx >= 0) {
      const span = document.createElement('span');
      span.style.background = 'rgba(168,85,247,0.4)';
      span.style.borderRadius = '2px';
      span.dataset.findhl = 'true';
      const range = document.createRange();
      range.setStart(node, idx);
      range.setEnd(node, idx + query.length);
      range.surroundContents(span);
      count++;
    }
  });
  document.getElementById('find-count').textContent = count + ' found';
}

function clearHighlights() {
  const canvas = document.getElementById('canvas');
  canvas.querySelectorAll('[data-findhl]').forEach(el => {
    const parent = el.parentNode;
    parent.replaceChild(document.createTextNode(el.textContent), el);
    parent.normalize();
  });
}

function replaceOne() {
  const query = document.getElementById('find-input').value;
  const repl = document.getElementById('replace-input').value;
  if (!query) return;
  const canvas = document.getElementById('canvas');
  const hl = canvas.querySelector('[data-findhl]');
  if (hl) {
    hl.replaceWith(document.createTextNode(repl));
    canvas.normalize();
    findInCanvas();
    scheduleSave();
  }
}

function replaceAll() {
  const query = document.getElementById('find-input').value;
  const repl = document.getElementById('replace-input').value;
  if (!query) return;
  clearHighlights();
  const canvas = document.getElementById('canvas');
  const walker = document.createTreeWalker(canvas, NodeFilter.SHOW_TEXT, null, false);
  const nodes = [];
  while (walker.nextNode()) nodes.push(walker.currentNode);
  let count = 0;
  nodes.forEach(node => {
    if (node.textContent.toLowerCase().includes(query.toLowerCase())) {
      const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
      node.textContent = node.textContent.replace(regex, repl);
      count++;
    }
  });
  document.getElementById('find-count').textContent = count + ' replaced';
  scheduleSave();
}

// ============================================================
// TABLE INSERT
// ============================================================
function openTblModal() {
  document.getElementById('tbl-overlay').classList.add('open');
  document.getElementById('tbl-modal').classList.add('open');
  buildTblGrid();
}

function closeTblModal() {
  document.getElementById('tbl-overlay').classList.remove('open');
  document.getElementById('tbl-modal').classList.remove('open');
  tblRows = 0; tblCols = 0;
}

function buildTblGrid() {
  const grid = document.getElementById('tbl-grid');
  grid.innerHTML = '';
  for (let r = 0; r < 6; r++) {
    for (let c = 0; c < 8; c++) {
      const cell = document.createElement('div');
      cell.className = 'tbl-cell';
      cell.dataset.r = r + 1;
      cell.dataset.c = c + 1;
      cell.addEventListener('mouseover', function() {
        tblRows = parseInt(this.dataset.r);
        tblCols = parseInt(this.dataset.c);
        document.getElementById('tbl-size').textContent = tblRows + ' x ' + tblCols;
        grid.querySelectorAll('.tbl-cell').forEach(tc => {
          const tr = parseInt(tc.dataset.r), tcl = parseInt(tc.dataset.c);
          tc.classList.toggle('hl', tr <= tblRows && tcl <= tblCols);
        });
      });
      cell.addEventListener('click', insertTable);
      grid.appendChild(cell);
    }
  }
}

function insertTable() {
  if (tblRows < 1 || tblCols < 1) { tblRows = 2; tblCols = 3; }
  let html = '<table><thead><tr>';
  for (let c = 0; c < tblCols; c++) html += '<th>Header ' + (c + 1) + '</th>';
  html += '</tr></thead><tbody>';
  for (let r = 0; r < tblRows; r++) {
    html += '<tr>';
    for (let c = 0; c < tblCols; c++) html += '<td>&nbsp;</td>';
    html += '</tr>';
  }
  html += '</tbody></table>';
  const canvas = document.getElementById('canvas');
  const footer = canvas.querySelector('.pdf-footer');
  const tbl = document.createElement('div');
  tbl.innerHTML = html;
  if (footer) { canvas.insertBefore(tbl.firstChild, footer); }
  else { canvas.appendChild(tbl.firstChild); }
  closeTblModal();
  scheduleSave();
  toast('Table inserted (' + tblRows + 'x' + tblCols + ')');
}

// ============================================================
// TABLE OF CONTENTS GENERATOR
// ============================================================
function generateTOC() {
  const canvas = document.getElementById('canvas');
  const headings = canvas.querySelectorAll('h1, h2, h3');
  if (!headings.length) { toast('No headings found'); return; }
  let html = '<div style="margin:16px 0;padding:16px;border:1px solid #ddd;border-radius:4px">';
  html += '<h3 style="font-size:13px;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.08em">Table of Contents</h3>';
  headings.forEach((h, i) => {
    const tag = h.tagName.toLowerCase();
    const indent = tag === 'h1' ? 0 : tag === 'h2' ? 16 : 32;
    const id = 'toc-' + i;
    h.id = id;
    html += '<div style="margin-left:' + indent + 'px;margin-bottom:3px">' +
      '<a href="#' + id + '" style="color:inherit;text-decoration:none;font-size:11px" onclick="document.getElementById(\'' + id + '\').scrollIntoView({behavior:\'smooth\'})">' +
      h.textContent + '</a></div>';
  });
  html += '</div>';
  const toc = document.createElement('div');
  toc.innerHTML = html;
  const first = canvas.firstChild;
  if (first) { canvas.insertBefore(toc.firstChild, first); }
  else { canvas.appendChild(toc.firstChild); }
  scheduleSave();
  toast('TOC generated with ' + headings.length + ' entries');
}

// ============================================================
// VERSION HISTORY
// ============================================================
function getVersions() {
  try { return JSON.parse(localStorage.getItem(VER_KEY) || '[]'); } catch(e) { return []; }
}

function saveVersion() {
  snapshotActive();
  const doc = docs.find(d => d.id === activeDocId);
  if (!doc) return;
  const versions = getVersions();
  versions.unshift({
    id: 'ver_' + Date.now(),
    docId: doc.id,
    title: doc.title,
    canvasHTML: document.getElementById('canvas').innerHTML,
    content: doc.content,
    tpl: doc.tpl,
    level: doc.level,
    time: new Date().toISOString(),
    words: (document.getElementById('canvas').innerText || '').trim().split(/\s+/).length
  });
  // Keep max 50 versions
  if (versions.length > 50) versions.length = 50;
  localStorage.setItem(VER_KEY, JSON.stringify(versions));
  renderVersions();
  toast('Snapshot saved');
}

function openVersions() {
  renderVersions();
  document.getElementById('ver-panel').classList.add('open');
}

function closeVersions() {
  document.getElementById('ver-panel').classList.remove('open');
}

function renderVersions() {
  const versions = getVersions().filter(v => v.docId === activeDocId);
  const el = document.getElementById('ver-list');
  if (!versions.length) {
    el.innerHTML = '<div style="padding:16px;text-align:center;font-size:9px;color:var(--text-muted)">No snapshots for this document</div>';
    return;
  }
  el.innerHTML = versions.map(v => {
    const d = new Date(v.time);
    const timeStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const preview = (v.canvasHTML || '').replace(/<[^>]+>/g, '').substring(0, 100);
    return '<div class="ver-item" onclick="restoreVersion(\'' + v.id + '\')">' +
      '<div class="vi-time">' + timeStr + '</div>' +
      '<div class="vi-meta">' + esc(v.title) + ' / ' + (v.words || 0) + ' words</div>' +
      '<div class="vi-preview">' + esc(preview) + '</div></div>';
  }).join('');
}

function restoreVersion(verId) {
  const versions = getVersions();
  const ver = versions.find(v => v.id === verId);
  if (!ver) return;
  if (!confirm('Restore this snapshot? Current state will be saved first.')) return;
  saveVersion(); // Auto-save current state
  const canvas = document.getElementById('canvas');
  canvas.innerHTML = ver.canvasHTML;
  canvas.className = 'pdf-canvas ' + (ver.tpl || currentTpl);
  if (ver.content) document.getElementById('f-content').value = ver.content;
  scheduleSave();
  toast('Version restored');
  closeVersions();
}

// ============================================================
// COMMAND PALETTE (Cmd+K)
// ============================================================
const CMD_ACTIONS = [
  { icon: '+', text: 'New Document', desc: 'Create blank doc', key: 'Cmd+N', fn: () => newDoc() },
  { icon: 'I', text: 'Import File', desc: 'Import .md/.txt', fn: () => importFile() },
  { icon: 'P', text: 'Export PDF', desc: 'Open export settings', key: 'Cmd+Shift+S', fn: () => openExport() },
  { icon: 'H', text: 'Export HTML', desc: 'Styled web page', fn: () => { exportFormat='html'; exportAsHTML(); } },
  { icon: 'MD', text: 'Export Markdown', desc: 'Plain markdown file', fn: () => { exportFormat='md'; exportMarkdown(); } },
  { icon: 'TX', text: 'Export Text', desc: 'Plain text file', fn: () => { exportFormat='txt'; exportPlainText(); } },
  { icon: 'Z', text: 'Export All (ZIP)', desc: 'Batch export all docs', fn: () => batchExport() },
  { icon: 'B', text: 'Backup All Data', desc: 'Download JSON backup', fn: () => backupData() },
  { icon: 'R', text: 'Restore Backup', desc: 'Import JSON backup', fn: () => restoreBackup() },
  { icon: 'S', text: 'Save', desc: 'Save to localStorage', key: 'Cmd+S', fn: () => { saveDocs(); toast('Saved'); } },
  { icon: 'F', text: 'Find & Replace', desc: 'Search in canvas', key: 'Cmd+F', fn: () => toggleFind() },
  { icon: 'T', text: 'Insert Table', desc: 'Visual table builder', fn: () => openTblModal() },
  { icon: 'C', text: 'Insert TOC', desc: 'Table of contents', fn: () => generateTOC() },
  { icon: '*', text: 'Insert Info Callout', desc: 'Blue info box', fn: () => insertCallout('info') },
  { icon: '!', text: 'Insert Tip Callout', desc: 'Green tip box', fn: () => insertCallout('tip') },
  { icon: '~', text: 'Insert Warning', desc: 'Yellow warning box', fn: () => insertCallout('warning') },
  { icon: '||', text: 'Insert Page Break', desc: 'PDF page separator', fn: () => insertPageBreak() },
  { icon: '--', text: 'Insert Divider', desc: 'Labeled section divider', fn: () => insertLabeledDivider() },
  { icon: '{}', text: 'Insert Code Block', desc: 'Monospace code', fn: () => insertCodeBlock() },
  { icon: 'Img', text: 'Insert Image', desc: 'From file', fn: () => insertImage() },
  { icon: '||', text: 'Insert 2 Columns', desc: 'Side-by-side layout', fn: () => insertColumns() },
  { icon: 'V', text: 'Save Snapshot', desc: 'Version history', fn: () => saveVersion() },
  { icon: 'H', text: 'Version History', desc: 'Browse snapshots', fn: () => openVersions() },
  { icon: 'FS', text: 'Fullscreen', desc: 'Toggle fullscreen', fn: () => toggleFullscreen() },
  { icon: '?', text: 'Keyboard Shortcuts', desc: 'Show help', key: 'Cmd+/', fn: () => openShortcuts() },
  { icon: 'A', text: 'Template: Saturno', fn: () => { document.querySelector('[data-tpl="tpl-saturno"]').click(); } },
  { icon: 'A', text: 'Template: Dark', fn: () => { document.querySelector('[data-tpl="tpl-dark"]').click(); } },
  { icon: 'A', text: 'Template: Minimal', fn: () => { document.querySelector('[data-tpl="tpl-minimal"]').click(); } },
  { icon: 'A', text: 'Template: White', fn: () => { document.querySelector('[data-tpl=""]').click(); } },
  { icon: 'P', text: 'Preset: Program PDF', fn: () => loadPreset('program') },
  { icon: 'P', text: 'Preset: Level Guide', fn: () => loadPreset('level') },
  { icon: 'P', text: 'Preset: Framework', fn: () => loadPreset('framework') },
  { icon: 'P', text: 'Preset: Transcript', fn: () => loadPreset('transcript') },
  { icon: 'P', text: 'Preset: Cover Page', fn: () => loadPreset('cover') },
  { icon: 'M', text: 'Mode: PDF Maker', fn: () => setMode('pdf') },
  { icon: 'M', text: 'Mode: Captions', fn: () => setMode('caption') },
  { icon: 'M', text: 'Mode: Atomizer', desc: 'Document atomizer', fn: () => setMode('atomizer') },
  { icon: 'AT', text: 'Atomize File', desc: 'Import PDF/TXT to atoms', fn: () => { setMode('atomizer'); document.getElementById('atom-file').click(); } },
  { icon: 'AT', text: 'Clear Atoms', desc: 'Reset atomizer', fn: () => clearAtoms() },
  { icon: 'D', text: 'Document Stats', desc: 'Show reading time + stats', fn: () => showDocStats() },
  { icon: 'V', text: 'View: Full', desc: '3-panel layout', fn: () => setView('default') },
  { icon: 'V', text: 'View: Split', desc: 'Markdown + Preview', fn: () => setView('split') },
  { icon: 'V', text: 'View: Focus', desc: 'Controls + Preview', fn: () => setView('focus') },
  { icon: 'CL', text: 'Caption Library', desc: 'Browse saved captions', fn: () => { setMode('caption'); setCapSub('library'); } },
  { icon: 'CL', text: 'Import Captions', desc: 'Import JSON/MD/TXT/CSV', fn: () => { setMode('caption'); setCapSub('library'); document.getElementById('cl-file').click(); } },
  { icon: 'CL', text: 'Export All Captions (JSON)', desc: 'Full library backup', fn: () => clExportAll('json') },
  { icon: 'CL', text: 'Export All Captions (Markdown)', desc: 'Library as MD', fn: () => clExportAll('md') },
  { icon: 'CL', text: 'Import Seeds to Library', desc: 'Add built-in quotes to library', fn: () => importSeedsToLibrary() },
  { icon: 'CL', text: 'Seed Full Content Library', desc: 'Load all manifesto, quotes, and poems', fn: () => { setMode('caption'); setCapSub('library'); seedGaboCaptions(); } },
  { icon: 'CL', text: 'Add Caption', desc: 'Add manually', fn: () => { setMode('caption'); setCapSub('library'); addCaptionManual(); } },
  { icon: 'T', text: 'Toggle Library Panel', desc: 'Show/hide sidebar', fn: () => togglePanel('lib') },
  { icon: 'T', text: 'Toggle Toolbar', desc: 'Show/hide formatting bar', fn: () => togglePanel('toolbar') }
];
let cmdSelIdx = 0;

function openCmd() {
  document.getElementById('cmd-overlay').classList.add('open');
  document.getElementById('cmd-palette').classList.add('open');
  document.getElementById('cmd-input').value = '';
  cmdSelIdx = 0;
  filterCmd();
  document.getElementById('cmd-input').focus();
}

function closeCmd() {
  document.getElementById('cmd-overlay').classList.remove('open');
  document.getElementById('cmd-palette').classList.remove('open');
}

function filterCmd() {
  const q = (document.getElementById('cmd-input').value || '').toLowerCase();
  const results = CMD_ACTIONS.filter(a => {
    const txt = (a.text + ' ' + (a.desc || '')).toLowerCase();
    return !q || txt.includes(q);
  }).slice(0, 12);
  cmdSelIdx = 0;
  renderCmdResults(results);
}

function renderCmdResults(results) {
  const el = document.getElementById('cmd-results');
  el.innerHTML = results.map((a, i) =>
    '<div class="cmd-item' + (i === cmdSelIdx ? ' sel' : '') + '" onclick="runCmd(' + CMD_ACTIONS.indexOf(a) + ')" onmouseenter="cmdSelIdx=' + i + ';renderCmdResults(getCmdFiltered())">' +
    '<span class="ci-icon">' + a.icon + '</span>' +
    '<span class="ci-text">' + a.text + '</span>' +
    (a.key ? '<span class="ci-key">' + a.key + '</span>' : (a.desc ? '<span class="ci-desc">' + a.desc + '</span>' : '')) +
    '</div>'
  ).join('');
}

function getCmdFiltered() {
  const q = (document.getElementById('cmd-input').value || '').toLowerCase();
  return CMD_ACTIONS.filter(a => {
    const txt = (a.text + ' ' + (a.desc || '')).toLowerCase();
    return !q || txt.includes(q);
  }).slice(0, 12);
}

function cmdKeyHandler(e) {
  const results = getCmdFiltered();
  if (e.key === 'ArrowDown') { e.preventDefault(); cmdSelIdx = Math.min(cmdSelIdx + 1, results.length - 1); renderCmdResults(results); }
  else if (e.key === 'ArrowUp') { e.preventDefault(); cmdSelIdx = Math.max(cmdSelIdx - 1, 0); renderCmdResults(results); }
  else if (e.key === 'Enter') { e.preventDefault(); if (results[cmdSelIdx]) { runCmd(CMD_ACTIONS.indexOf(results[cmdSelIdx])); } }
  else if (e.key === 'Escape') { closeCmd(); }
}

function runCmd(idx) {
  closeCmd();
  if (CMD_ACTIONS[idx] && CMD_ACTIONS[idx].fn) CMD_ACTIONS[idx].fn();
}

// ============================================================
// BACKUP / RESTORE
// ============================================================
function backupData() {
  snapshotActive();
  const backup = {
    version: '6.4',
    exported: new Date().toISOString(),
    docs: docs,
    versions: getVersions()
  };
  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'content-beast-backup-' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('Backup downloaded (' + docs.length + ' docs)');
}

function restoreBackup() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = function() {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = JSON.parse(e.target.result);
        if (!data.docs || !Array.isArray(data.docs)) { toast('Invalid backup file'); return; }
        if (!confirm('Restore ' + data.docs.length + ' documents? This will MERGE with existing docs.')) return;
        const existingIds = new Set(docs.map(d => d.id));
        let added = 0;
        data.docs.forEach(d => {
          if (!existingIds.has(d.id)) { docs.push(d); added++; }
        });
        saveDocs();
        renderLibrary();
        if (data.versions) {
          const existing = getVersions();
          const existingVerIds = new Set(existing.map(v => v.id));
          data.versions.forEach(v => { if (!existingVerIds.has(v.id)) existing.push(v); });
          localStorage.setItem(VER_KEY, JSON.stringify(existing));
        }
        toast('Restored ' + added + ' new docs (skipped ' + (data.docs.length - added) + ' duplicates)');
      } catch(err) { toast('Error: ' + err.message); }
    };
    reader.readAsText(file);
  };
  input.click();
}

// ============================================================
// DOCUMENT STATS
// ============================================================
function showDocStats() {
  const canvas = document.getElementById('canvas');
  const text = canvas.innerText || '';
  const words = text.trim() ? text.trim().split(/\s+/).length : 0;
  const chars = text.length;
  const charsNoSpace = text.replace(/\s/g, '').length;
  const sentences = text.split(/[.!?]+/).filter(s => s.trim()).length;
  const paragraphs = text.split(/\n\n+/).filter(p => p.trim()).length;
  const readTime = Math.max(1, Math.ceil(words / 200));
  const headings = canvas.querySelectorAll('h1,h2,h3').length;
  const images = canvas.querySelectorAll('img').length;
  const tables = canvas.querySelectorAll('table').length;
  const links = canvas.querySelectorAll('a').length;

  const msg = 'DOCUMENT STATS\n' +
    '---\n' +
    'Words: ' + words + '\n' +
    'Characters: ' + chars + ' (' + charsNoSpace + ' without spaces)\n' +
    'Sentences: ' + sentences + '\n' +
    'Paragraphs: ' + paragraphs + '\n' +
    'Reading time: ~' + readTime + ' min\n' +
    'Headings: ' + headings + '\n' +
    'Images: ' + images + '\n' +
    'Tables: ' + tables + '\n' +
    'Links: ' + links;
  alert(msg);
}

// ============================================================
// VIEW MODES (Full / Split / Focus)
// ============================================================
function setView(mode) {
  const ws = document.getElementById('workspace');
  ws.classList.remove('split-view', 'focus-mode');
  document.querySelectorAll('[id^="view-"]').forEach(b => b.classList.remove('active'));
  if (mode === 'split') {
    ws.classList.add('split-view');
    document.getElementById('view-split').classList.add('active');
    // In split view, auto-render on content change
    document.getElementById('f-content').oninput = function() { onFieldChange(); };
  } else if (mode === 'focus') {
    ws.classList.add('focus-mode');
    document.getElementById('view-focus').classList.add('active');
  } else {
    document.getElementById('view-default').classList.add('active');
  }
}

// ============================================================
// SORT DOCUMENTS
// ============================================================
function sortDocs(mode, btn) {
  document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  snapshotActive();
  if (mode === 'recent') { docs.sort((a, b) => new Date(b.updated) - new Date(a.updated)); }
  else if (mode === 'name') { docs.sort((a, b) => a.title.localeCompare(b.title)); }
  else if (mode === 'oldest') { docs.sort((a, b) => new Date(a.created) - new Date(b.created)); }
  saveDocs();
  renderLibrary();
}

// ============================================================
// BATCH EXPORT (ZIP)
// ============================================================
async function batchExport() {
  if (!docs.length) { toast('No documents to export'); return; }
  if (typeof JSZip === 'undefined') { toast('JSZip not loaded'); return; }
  setStatus('EXPORTING ZIP...', 'busy');
  const zip = new JSZip();
  const canvas = document.getElementById('canvas');
  const originalHTML = canvas.innerHTML;
  const originalClass = canvas.className;

  for (let i = 0; i < docs.length; i++) {
    const doc = docs[i];
    canvas.className = 'pdf-canvas ' + (doc.tpl || 'tpl-saturno');
    canvas.innerHTML = doc.canvasHTML || ('<h1>' + esc(doc.title) + '</h1><p>' + esc(doc.content || '') + '</p>');

    try {
      const isDark = (doc.tpl || '').includes('saturno') || (doc.tpl || '').includes('dark');
      const blob = await html2pdf().set({
        margin: [12, 12, 16, 12],
        image: { type: 'jpeg', quality: 0.95 },
        html2canvas: { scale: 2, useCORS: true, backgroundColor: isDark ? '#0a0a0a' : '#ffffff' },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      }).from(canvas).outputPdf('blob');
      const fname = doc.title.replace(/[^a-zA-Z0-9_\- ]/g, '_').replace(/\s+/g, '_') + '.pdf';
      zip.file(fname, blob);
    } catch(e) { /* skip failed docs */ }
  }

  canvas.className = originalClass;
  canvas.innerHTML = originalHTML;

  const zipBlob = await zip.generateAsync({ type: 'blob' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(zipBlob);
  a.download = 'Content-Beast-Export-' + new Date().toISOString().slice(0,10) + '.zip';
  a.click();
  URL.revokeObjectURL(a.href);
  setStatus('READY', 'ok');
  toast('Exported ' + docs.length + ' docs as ZIP');
}

// ============================================================
// QUICK INSERT BLOCKS
// ============================================================
function toggleQuickInsert() {
  document.getElementById('qi-menu').classList.toggle('open');
}

function insertCallout(type) {
  const canvas = document.getElementById('canvas');
  const div = document.createElement('div');
  div.className = 'callout callout-' + type;
  div.contentEditable = 'true';
  const labels = { info: 'Note:', tip: 'Tip:', warning: 'Warning:', fire: 'Important:' };
  div.innerHTML = '<strong>' + (labels[type] || 'Note:') + '</strong> Type your content here';
  const footer = canvas.querySelector('.pdf-footer');
  if (footer) canvas.insertBefore(div, footer);
  else canvas.appendChild(div);
  document.getElementById('qi-menu').classList.remove('open');
  div.focus();
  scheduleSave();
}

function insertCodeBlock() {
  const canvas = document.getElementById('canvas');
  const pre = document.createElement('pre');
  pre.style.cssText = 'background:#f4f4f5;padding:12px;border-radius:4px;font-family:JetBrains Mono,monospace;font-size:11px;overflow-x:auto;margin:12px 0';
  pre.contentEditable = 'true';
  pre.textContent = '// code here';
  const footer = canvas.querySelector('.pdf-footer');
  if (footer) canvas.insertBefore(pre, footer);
  else canvas.appendChild(pre);
  document.getElementById('qi-menu').classList.remove('open');
  pre.focus();
  scheduleSave();
}

function insertLabeledDivider() {
  const label = prompt('Divider label:', 'SECTION') || 'SECTION';
  const canvas = document.getElementById('canvas');
  const div = document.createElement('div');
  div.style.cssText = 'text-align:center;margin:24px 0;position:relative';
  div.innerHTML = '<hr style="border:none;border-top:1px solid #ddd"><span style="position:relative;top:-10px;background:inherit;padding:0 12px;font-size:9px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#999;font-family:JetBrains Mono,monospace">' + esc(label) + '</span>';
  const footer = canvas.querySelector('.pdf-footer');
  if (footer) canvas.insertBefore(div, footer);
  else canvas.appendChild(div);
  document.getElementById('qi-menu').classList.remove('open');
  scheduleSave();
}

function insertColumns() {
  const canvas = document.getElementById('canvas');
  const div = document.createElement('div');
  div.style.cssText = 'display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:16px 0';
  div.innerHTML = '<div style="border-right:1px solid #eee;padding-right:16px" contenteditable="true"><p>Left column content</p></div><div contenteditable="true"><p>Right column content</p></div>';
  const footer = canvas.querySelector('.pdf-footer');
  if (footer) canvas.insertBefore(div, footer);
  else canvas.appendChild(div);
  document.getElementById('qi-menu').classList.remove('open');
  scheduleSave();
}

// Close quick-insert when clicking outside
document.addEventListener('click', function(e) {
  const menu = document.getElementById('qi-menu');
  if (menu && menu.classList.contains('open') && !e.target.closest('.qi-menu') && !e.target.closest('[onclick*="toggleQuickInsert"]')) {
    menu.classList.remove('open');
  }
});

// ============================================================
// LIBRARY SEARCH
// ============================================================
function filterLibrary() {
  const q = (document.getElementById('lib-search').value || '').toLowerCase();
  const items = document.querySelectorAll('#lib-list .lib-item');
  items.forEach(item => {
    const title = (item.querySelector('.li-title') || {}).textContent || '';
    item.style.display = title.toLowerCase().includes(q) ? '' : 'none';
  });
}

// ============================================================
// DOCUMENT ATOMIZER
// ============================================================
let atoms = [];
let atomFilter = 'all';

// Drag-drop on atomizer
document.addEventListener('DOMContentLoaded', function() {
  const ad = document.getElementById('atom-drop');
  if (ad) {
    ad.addEventListener('dragover', e => { e.preventDefault(); ad.classList.add('over'); });
    ad.addEventListener('dragleave', () => ad.classList.remove('over'));
    ad.addEventListener('drop', e => { e.preventDefault(); ad.classList.remove('over'); if (e.dataTransfer.files.length) atomizeFile(e.dataTransfer.files[0]); });
  }
});

async function atomizeFile(file) {
  if (!file) return;
  setStatus('ATOMIZING...', 'busy');
  animatePipeline(['active','','','','']);
  let text = '';
  const ext = file.name.split('.').pop().toLowerCase();

  if (ext === 'pdf') {
    try {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      const pages = [];
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        pages.push(content.items.map(item => item.str).join(' '));
      }
      text = pages.join('\n\n');
    } catch(e) { toast('PDF error: ' + e.message); setStatus('ERROR', 'busy'); return; }
  } else {
    text = await file.text();
  }

  // Pipeline: parse
  animatePipeline(['complete','active','','','']);
  text = cleanText(text);
  // Pipeline: classify
  setTimeout(() => animatePipeline(['complete','complete','active','','']), 100);
  atoms = parseAtoms(text, file.name);
  // Pipeline: index + ready
  setTimeout(() => animatePipeline(['complete','complete','complete','active','']), 200);
  setTimeout(() => animatePipeline(['complete','complete','complete','complete','active']), 400);
  setTimeout(() => animatePipeline(['complete','complete','complete','complete','complete']), 600);

  // Show source info
  document.getElementById('atom-source-info').style.display = '';
  document.getElementById('atom-source-name').textContent = file.name;
  document.getElementById('atom-source-meta').textContent = atoms.length + ' atoms extracted / ' + text.split(/\s+/).length + ' words / ' + (ext === 'pdf' ? 'PDF' : ext.toUpperCase());

  renderAtomFilters();
  renderAtoms();
  setStatus('READY', 'ok');
  toast(atoms.length + ' atoms extracted from ' + file.name);
}

function cleanText(text) {
  return text
    .replace(/\r\n/g, '\n')
    .replace(/\t/g, '  ')
    .replace(/[^\x20-\x7E\n]/g, function(c) {
      if (/[\u2018\u2019]/.test(c)) return "'";
      if (/[\u201C\u201D]/.test(c)) return '"';
      if (c === '\u2013' || c === '\u2014') return '--';
      if (c === '\u2026') return '...';
      if (c === '\u00A0') return ' ';
      return c;
    })
    .replace(/\n{4,}/g, '\n\n\n')
    .replace(/[ ]{3,}/g, '  ')
    .trim();
}

function parseAtoms(text, filename) {
  const lines = text.split('\n');
  const result = [];
  let idx = 0;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;

    // HEADING
    if (/^#{1,4}\s/.test(line)) {
      const level = (line.match(/^#+/) || [''])[0].length;
      result.push({ id: idx++, type: 'heading', level: level, text: line.replace(/^#+\s*/, ''), raw: line, source: filename });
      continue;
    }

    // ALL-CAPS heading (common in PDFs)
    if (line.length > 3 && line.length < 100 && line === line.toUpperCase() && /[A-Z]/.test(line) && !/^[-=*#>|]/.test(line)) {
      result.push({ id: idx++, type: 'heading', level: 2, text: line, raw: line, source: filename });
      continue;
    }

    // QUOTE (blockquote or "quoted text")
    if (/^>\s/.test(line)) {
      result.push({ id: idx++, type: 'quote', text: line.replace(/^>\s*/, ''), raw: line, source: filename });
      continue;
    }
    if (/^[""\u201C]/.test(line) && /["".\u201D]$/.test(line) && line.length > 10 && line.length < 300) {
      result.push({ id: idx++, type: 'quote', text: line.replace(/^[""\u201C]+|[""\u201D]+$/g, '').trim(), raw: line, source: filename });
      continue;
    }

    // DIVIDER
    if (/^[-=*]{3,}$/.test(line) || /^---+$/.test(line)) {
      result.push({ id: idx++, type: 'divider', text: '---', raw: line, source: filename });
      continue;
    }

    // TABLE ROW
    if (/^\|.*\|$/.test(line) && !(/^\|[-:| ]+\|$/.test(line))) {
      result.push({ id: idx++, type: 'table', text: line, raw: line, source: filename });
      continue;
    }

    // LIST ITEM
    if (/^[-*+]\s/.test(line) || /^\d+\.\s/.test(line)) {
      result.push({ id: idx++, type: 'list', text: line.replace(/^[-*+]\s*/, '').replace(/^\d+\.\s*/, ''), raw: line, source: filename });
      continue;
    }

    // CODE BLOCK
    if (/^```/.test(line)) {
      let code = '';
      i++;
      while (i < lines.length && !/^```/.test(lines[i].trim())) {
        code += lines[i] + '\n';
        i++;
      }
      if (code.trim()) {
        result.push({ id: idx++, type: 'code', text: code.trim(), raw: '```\n' + code.trim() + '\n```', source: filename });
      }
      continue;
    }

    // IMAGE REFERENCE
    if (/!\[.*\]\(.*\)/.test(line) || /\.(png|jpg|jpeg|gif|svg|webp)/i.test(line)) {
      result.push({ id: idx++, type: 'image', text: line, raw: line, source: filename });
      continue;
    }

    // SHORT PUNCHY LINE = potential quote (under 200 chars, no question mark, has a period or is a statement)
    if (line.length > 10 && line.length < 200 && !line.endsWith('?') && /[.!]$/.test(line) && !/^(Note|TODO|FIXME|See|Ref|http|www)/i.test(line)) {
      const words = line.split(/\s+/).length;
      if (words >= 4 && words <= 35) {
        result.push({ id: idx++, type: 'quote', text: line.replace(/^\*\*|\*\*$/g, '').replace(/^\*|\*$/g, ''), raw: line, source: filename });
        continue;
      }
    }

    // PARAGRAPH (everything else)
    if (line.length > 5) {
      result.push({ id: idx++, type: 'paragraph', text: line, raw: line, source: filename });
    }
  }

  return result;
}

function renderAtomFilters() {
  const counts = {};
  atoms.forEach(a => { counts[a.type] = (counts[a.type] || 0) + 1; });
  const types = ['all', ...Object.keys(counts).sort()];
  const el = document.getElementById('atom-filters');
  el.innerHTML = types.map(t =>
    '<button class="atom-filter' + (t === atomFilter ? ' active' : '') + '" onclick="setAtomFilter(\'' + t + '\')">' +
    t + (t !== 'all' ? '<span class="af-count">' + counts[t] + '</span>' : '<span class="af-count">' + atoms.length + '</span>') + '</button>'
  ).join('');
}

function setAtomFilter(f) {
  atomFilter = f;
  renderAtomFilters();
  renderAtoms();
}

function renderAtoms() {
  const el = document.getElementById('atom-list');
  const filtered = atomFilter === 'all' ? atoms : atoms.filter(a => a.type === atomFilter);
  if (!filtered.length) {
    el.innerHTML = '<div style="padding:16px;text-align:center;font-size:9px;color:var(--text-muted)">No atoms of this type</div>';
    return;
  }
  el.innerHTML = filtered.map(a =>
    '<div class="atom-card draggable-item" data-atom-id="' + a.id + '" draggable="true" onclick="toggleAtomSelect(this,' + a.id + ')">' +
    '<div style="display:flex;align-items:flex-start;gap:6px">' +
    '<div class="drag-handle" title="Drag to canvas or seed"><span></span></div>' +
    '<div style="flex:1;min-width:0">' +
    '<span class="ac-type t-' + a.type + '">' + a.type + (a.level ? ' H' + a.level : '') + '</span>' +
    '<div class="ac-meta">#' + a.id + ' / ' + a.text.split(/\s+/).length + ' words</div>' +
    '<div class="ac-text">' + esc(a.text) + '</div>' +
    '<div class="ac-actions">' +
    '<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();atomToCanvas(' + a.id + ')">To Canvas</button>' +
    '<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();atomToSeed(' + a.id + ')">To Seed</button>' +
    '<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();atomCopy(' + a.id + ')">Copy</button>' +
    '<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();atomNewDoc(' + a.id + ')">New Doc</button>' +
    '<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();previewAtom(' + a.id + ')" style="color:var(--green)">Preview</button>' +
    '</div></div></div></div>'
  ).join('');
  // Wire HTML5 drag events for atom items
  el.querySelectorAll('.atom-card[draggable]').forEach(item => {
    item.addEventListener('dragstart', function(e) {
      const aid = parseInt(this.dataset.atomId);
      const atom = atoms.find(x => x.id === aid);
      if (!atom) return;
      e.dataTransfer.setData('application/x-cb-atom', JSON.stringify(atom));
      e.dataTransfer.setData('text/plain', atom.text);
      e.dataTransfer.effectAllowed = 'copyMove';
      this.classList.add('dragging');
    });
    item.addEventListener('dragend', function() { this.classList.remove('dragging'); });
  });

  // Stats
  const stats = document.getElementById('atom-stats');
  stats.style.display = '';
  const qCount = atoms.filter(a => a.type === 'quote').length;
  const hCount = atoms.filter(a => a.type === 'heading').length;
  stats.innerHTML = '<span>Total: ' + atoms.length + '</span><span>Quotes: ' + qCount + '</span><span>Headings: ' + hCount + '</span><span>Filter: ' + atomFilter + '</span>';
  updateBulkBar();
}

function toggleAtomSelect(el, id) {
  el.classList.toggle('selected');
  updateBulkBar();
}

function updateBulkBar() {
  const sel = document.querySelectorAll('.atom-card.selected');
  const bar = document.getElementById('atom-bulk');
  if (sel.length > 0) {
    bar.style.display = 'flex';
    document.getElementById('atom-sel-count').textContent = sel.length;
  } else {
    bar.style.display = 'none';
  }
}

function getSelectedAtoms() {
  const ids = [];
  document.querySelectorAll('.atom-card.selected').forEach(el => ids.push(parseInt(el.dataset.atomId)));
  return atoms.filter(a => ids.includes(a.id));
}

function deselectAll() {
  document.querySelectorAll('.atom-card.selected').forEach(el => el.classList.remove('selected'));
  updateBulkBar();
}

// SINGLE ATOM ACTIONS
function atomToCanvas(id) {
  const a = atoms.find(x => x.id === id);
  if (!a) return;
  const canvas = document.getElementById('canvas');
  const footer = canvas.querySelector('.pdf-footer');
  let html = '';
  if (a.type === 'heading') html = '<h' + (a.level || 2) + '>' + esc(a.text) + '</h' + (a.level || 2) + '>';
  else if (a.type === 'quote') html = '<blockquote>' + esc(a.text) + '</blockquote>';
  else if (a.type === 'list') html = '<li>' + esc(a.text) + '</li>';
  else if (a.type === 'code') html = '<pre style="background:#f4f4f5;padding:12px;border-radius:4px;font-family:JetBrains Mono,monospace;font-size:11px;margin:12px 0">' + esc(a.text) + '</pre>';
  else html = '<p>' + esc(a.text) + '</p>';
  const el = document.createElement('div');
  el.innerHTML = html;
  if (footer) canvas.insertBefore(el.firstChild, footer);
  else canvas.appendChild(el.firstChild);
  setMode('pdf');
  scheduleSave();
  toast('Atom #' + id + ' added to canvas');
}

function atomToSeed(id) {
  const a = atoms.find(x => x.id === id);
  if (!a) return;
  document.getElementById('seed-input').value = a.text;
  setMode('caption');
  toast('Atom #' + id + ' loaded as seed');
}

function atomCopy(id) {
  const a = atoms.find(x => x.id === id);
  if (!a) return;
  navigator.clipboard.writeText(a.text);
  toast('Copied atom #' + id);
}

function atomNewDoc(id) {
  const a = atoms.find(x => x.id === id);
  if (!a) return;
  const title = a.type === 'heading' ? a.text : a.text.substring(0, 40) + '...';
  const doc = createDoc(title, a.raw, currentTpl, '');
  switchDoc(doc.id);
  setMode('pdf');
  toast('New doc from atom #' + id);
}

function previewAtom(id) {
  const a = atoms.find(x => x.id === id);
  if (!a) return;
  const el = document.getElementById('atom-preview-content');
  let html = '<div style="margin-bottom:8px"><span class="ac-type t-' + a.type + '">' + a.type + '</span></div>';
  if (a.type === 'heading') html += '<h2 style="color:var(--text-primary);font-size:18px;font-family:var(--sans)">' + esc(a.text) + '</h2>';
  else if (a.type === 'quote') html += '<blockquote style="border-left:3px solid var(--accent);padding:12px 16px;font-style:italic;color:var(--text-primary);font-size:13px;font-family:var(--sans);line-height:1.8">' + esc(a.text) + '</blockquote>';
  else if (a.type === 'code') html += '<pre style="background:var(--bg-base);padding:12px;border-radius:4px;font-family:var(--mono);font-size:11px;color:var(--text-secondary);overflow-x:auto">' + esc(a.text) + '</pre>';
  else html += '<p style="color:var(--text-primary);font-size:12px;font-family:var(--sans);line-height:1.8">' + esc(a.text) + '</p>';
  html += '<div style="margin-top:12px;font-size:8px;color:var(--text-muted)">Source: ' + esc(a.source) + ' / #' + a.id + ' / ' + a.text.split(/\s+/).length + ' words</div>';
  el.innerHTML = html;
}

// BULK ACTIONS
function bulkToCanvas() {
  const sel = getSelectedAtoms();
  if (!sel.length) return;
  sel.forEach(a => atomToCanvas(a.id));
  deselectAll();
  setMode('pdf');
  toast(sel.length + ' atoms added to canvas');
}

function bulkToSeed() {
  const sel = getSelectedAtoms();
  if (!sel.length) return;
  document.getElementById('seed-input').value = sel.map(a => a.text).join('\n\n');
  deselectAll();
  setMode('caption');
  toast(sel.length + ' atoms loaded as seed');
}

function bulkNewDoc() {
  const sel = getSelectedAtoms();
  if (!sel.length) return;
  const content = sel.map(a => {
    if (a.type === 'heading') return '## ' + a.text;
    if (a.type === 'quote') return '> ' + a.text;
    if (a.type === 'list') return '- ' + a.text;
    return a.text;
  }).join('\n\n');
  const doc = createDoc('Assembled Document', content, currentTpl, '');
  switchDoc(doc.id);
  deselectAll();
  setMode('pdf');
  renderPreview();
  toast('New doc from ' + sel.length + ' atoms');
}

function bulkCopy() {
  const sel = getSelectedAtoms();
  if (!sel.length) return;
  navigator.clipboard.writeText(sel.map(a => a.text).join('\n\n'));
  deselectAll();
  toast(sel.length + ' atoms copied');
}

function clearAtoms() {
  atoms = [];
  atomFilter = 'all';
  document.getElementById('atom-list').innerHTML = '<div style="padding:20px;text-align:center;font-size:9px;color:var(--text-muted);line-height:1.8">Import a document to break it into<br>atomic units</div>';
  document.getElementById('atom-filters').innerHTML = '';
  document.getElementById('atom-stats').style.display = 'none';
  document.getElementById('atom-bulk').style.display = 'none';
  document.getElementById('atom-source-info').style.display = 'none';
  document.getElementById('atom-preview-content').innerHTML = '';
}

// ============================================================
// CAPTION LIBRARY — IndexedDB Storage
// ============================================================
const CL_DB_NAME = 'ContentBeastCaptions';
const CL_DB_VER = 1;
const CL_STORE = 'captions';
let clDB = null;
let clCaptions = [];
let clFilter = 'all';
let clSortMode = 'recent';

function openCaptionDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(CL_DB_NAME, CL_DB_VER);
    req.onupgradeneeded = function(e) {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(CL_STORE)) {
        const store = db.createObjectStore(CL_STORE, { keyPath: 'id' });
        store.createIndex('theme', 'theme', { unique: false });
        store.createIndex('voice', 'voice', { unique: false });
        store.createIndex('platform', 'platform', { unique: false, multiEntry: true });
        store.createIndex('created', 'created', { unique: false });
      }
    };
    req.onsuccess = function(e) { clDB = e.target.result; resolve(clDB); };
    req.onerror = function(e) { reject(e.target.error); };
  });
}

function clPut(caption) {
  return new Promise((resolve, reject) => {
    const tx = clDB.transaction(CL_STORE, 'readwrite');
    tx.objectStore(CL_STORE).put(caption);
    tx.oncomplete = resolve;
    tx.onerror = () => reject(tx.error);
  });
}

function clDelete(id) {
  return new Promise((resolve, reject) => {
    const tx = clDB.transaction(CL_STORE, 'readwrite');
    tx.objectStore(CL_STORE).delete(id);
    tx.oncomplete = resolve;
    tx.onerror = () => reject(tx.error);
  });
}

function clGetAll() {
  return new Promise((resolve, reject) => {
    const tx = clDB.transaction(CL_STORE, 'readonly');
    const req = tx.objectStore(CL_STORE).getAll();
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function clLoadAll() {
  clCaptions = await clGetAll();
  renderCaptionLibrary();
}

function makeCaptionId() { return 'cap_' + Date.now() + '_' + Math.random().toString(36).slice(2, 6); }

function makeCaption(text, opts) {
  return {
    id: makeCaptionId(),
    text: text.trim(),
    theme: (opts && opts.theme) || 'general',
    voice: (opts && opts.voice) || '',
    platform: (opts && opts.platform) || [],
    source: (opts && opts.source) || 'manual',
    scale: (opts && opts.scale) || '',
    words: text.trim().split(/\s+/).length,
    created: new Date().toISOString(),
    updated: new Date().toISOString()
  };
}

// CAPTION LIBRARY RENDER
function renderCaptionLibrary() {
  const searchQ = (document.getElementById('cl-search').value || '').toLowerCase();
  let filtered = clCaptions;

  // Filter by theme
  if (clFilter !== 'all') {
    filtered = filtered.filter(c => c.theme === clFilter);
  }

  // Filter by search
  if (searchQ) {
    filtered = filtered.filter(c =>
      c.text.toLowerCase().includes(searchQ) ||
      (c.theme || '').toLowerCase().includes(searchQ) ||
      (c.voice || '').toLowerCase().includes(searchQ) ||
      (c.source || '').toLowerCase().includes(searchQ)
    );
  }

  // Sort
  if (clSortMode === 'recent') filtered.sort((a, b) => new Date(b.created) - new Date(a.created));
  else if (clSortMode === 'oldest') filtered.sort((a, b) => new Date(a.created) - new Date(b.created));
  else if (clSortMode === 'words') filtered.sort((a, b) => a.words - b.words);
  else if (clSortMode === 'alpha') filtered.sort((a, b) => a.text.localeCompare(b.text));

  // Render filters
  renderClFilters();

  const el = document.getElementById('cl-list');
  if (!filtered.length) {
    if (clCaptions.length === 0) {
      el.innerHTML = '<div class="cl-empty"><div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;font-weight:500">Caption Library</div>Import captions from JSON, Markdown, or TXT.<br>Or click <b style="color:var(--cyan)">+</b> to write one now.<br><br>Every caption gets tagged, searchable,<br>and ready to deploy.</div>';
    } else {
      el.innerHTML = '<div class="cl-empty">No captions match this filter.</div>';
    }
    document.getElementById('cl-stats').style.display = 'none';
    return;
  }

  el.innerHTML = filtered.map(c =>
    '<div class="cl-item draggable-item" data-cl-id="' + c.id + '" draggable="true" onclick="toggleClSelect(this,\'' + c.id + '\')">' +
    '<div style="display:flex;align-items:flex-start;gap:6px">' +
    '<div class="drag-handle" title="Drag to canvas or seed"><span></span></div>' +
    '<div style="flex:1;min-width:0">' +
    (c.voice ? '<span class="cl-voice">' + esc(c.voice) + '</span>' : '') +
    '<span class="cl-theme">' + esc(c.theme) + '</span>' +
    '<div class="cl-text">' + esc(c.text) + '</div>' +
    '<div class="cl-meta"><span>' + c.words + 'w</span>' +
    (c.platform && c.platform.length ? '<span>' + c.platform.join(', ') + '</span>' : '') +
    '<span>' + new Date(c.created).toLocaleDateString() + '</span>' +
    (c.source && c.source !== 'manual' ? '<span>' + esc(c.source) + '</span>' : '') +
    '</div>' +
    '<div class="cl-actions">' +
    '<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();clPreview(\'' + c.id + '\')" style="color:var(--cyan)">View</button>' +
    '<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();clToCanvas(\'' + c.id + '\')">Canvas</button>' +
    '<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();clToSeed(\'' + c.id + '\')">Seed</button>' +
    '<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();clCopy(\'' + c.id + '\')">Copy</button>' +
    '<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();clEdit(\'' + c.id + '\')">Edit</button>' +
    '<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();clRemove(\'' + c.id + '\')" style="color:var(--red)">x</button>' +
    '</div></div></div></div>'
  ).join('');
  // Wire HTML5 drag events for caption items
  el.querySelectorAll('.cl-item[draggable]').forEach(item => {
    item.addEventListener('dragstart', function(e) {
      const cid = this.dataset.clId;
      const cap = clCaptions.find(x => x.id === cid);
      if (!cap) return;
      e.dataTransfer.setData('application/x-cb-caption', JSON.stringify(cap));
      e.dataTransfer.setData('text/plain', cap.text);
      e.dataTransfer.effectAllowed = 'copyMove';
      this.classList.add('dragging');
    });
    item.addEventListener('dragend', function() { this.classList.remove('dragging'); });
  });

  // Stats
  const stats = document.getElementById('cl-stats');
  stats.style.display = '';
  stats.innerHTML = '<span>Total: ' + clCaptions.length + '</span><span>Shown: ' + filtered.length + '</span><span>Sort: ' + clSortMode + '</span>';
  updateClBulk();
}

function renderClFilters() {
  const counts = {};
  clCaptions.forEach(c => { counts[c.theme] = (counts[c.theme] || 0) + 1; });
  const themes = ['all', ...Object.keys(counts).sort()];
  const el = document.getElementById('cl-filters');

  // Sort buttons + theme filters
  el.innerHTML =
    '<button class="cl-filter' + (clSortMode==='recent'?' active':'') + '" onclick="clSetSort(\'recent\')" style="border-color:var(--border-hover);color:var(--text-secondary)">Recent</button>' +
    '<button class="cl-filter' + (clSortMode==='alpha'?' active':'') + '" onclick="clSetSort(\'alpha\')" style="border-color:var(--border-hover);color:var(--text-secondary)">A-Z</button>' +
    '<button class="cl-filter' + (clSortMode==='words'?' active':'') + '" onclick="clSetSort(\'words\')" style="border-color:var(--border-hover);color:var(--text-secondary)">Short</button>' +
    '<span style="width:1px;height:14px;background:var(--border);margin:0 2px"></span>' +
    themes.map(t =>
      '<button class="cl-filter' + (t === clFilter ? ' active' : '') + '" onclick="clSetFilter(\'' + t + '\')">' +
      t + (t !== 'all' ? '<span class="clf-n">' + counts[t] + '</span>' : '<span class="clf-n">' + clCaptions.length + '</span>') +
      '</button>'
    ).join('');
}

function clSetFilter(f) { clFilter = f; renderCaptionLibrary(); }
function clSetSort(s) { clSortMode = s; renderCaptionLibrary(); }
function searchCaptions() { renderCaptionLibrary(); }

// SELECTION
function toggleClSelect(el, id) { el.classList.toggle('selected'); updateClBulk(); }

function updateClBulk() {
  const sel = document.querySelectorAll('.cl-item.selected');
  const bar = document.getElementById('cl-bulk');
  if (sel.length > 0) {
    bar.style.display = 'flex';
    document.getElementById('cl-sel-count').textContent = sel.length;
  } else {
    bar.style.display = 'none';
  }
}

function getSelectedCaptions() {
  const ids = [];
  document.querySelectorAll('.cl-item.selected').forEach(el => ids.push(el.dataset.clId));
  return clCaptions.filter(c => ids.includes(c.id));
}

function clDeselectAll() {
  document.querySelectorAll('.cl-item.selected').forEach(el => el.classList.remove('selected'));
  updateClBulk();
}

// SINGLE ACTIONS
function clPreview(id) {
  const c = clCaptions.find(x => x.id === id);
  if (!c) return;
  document.getElementById('cl-preview-content').textContent = c.text;
  document.getElementById('cl-preview-meta').innerHTML =
    '<span>Theme: <b>' + esc(c.theme) + '</b></span>' +
    (c.voice ? ' / Voice: <b>' + esc(c.voice) + '</b>' : '') +
    (c.platform && c.platform.length ? ' / Platform: <b>' + c.platform.join(', ') + '</b>' : '') +
    ' / Words: <b>' + c.words + '</b>' +
    ' / Source: <b>' + esc(c.source || 'manual') + '</b>' +
    ' / Created: <b>' + new Date(c.created).toLocaleDateString() + '</b>';
}

function clToCanvas(id) {
  const c = clCaptions.find(x => x.id === id);
  if (!c) return;
  const canvas = document.getElementById('canvas');
  const footer = canvas.querySelector('.pdf-footer');
  const p = document.createElement('p');
  p.textContent = c.text;
  if (footer) canvas.insertBefore(p, footer);
  else canvas.appendChild(p);
  setMode('pdf');
  scheduleSave();
  toast('Caption added to canvas');
}

function clToSeed(id) {
  const c = clCaptions.find(x => x.id === id);
  if (!c) return;
  document.getElementById('seed-input').value = c.text;
  setCapSub('multiplier');
  toast('Caption loaded as seed');
}

function clCopy(id) {
  const c = clCaptions.find(x => x.id === id);
  if (!c) return;
  navigator.clipboard.writeText(c.text);
  toast('Copied');
}

async function clRemove(id) {
  if (!confirm('Remove this caption from library?')) return;
  await clDelete(id);
  clCaptions = clCaptions.filter(c => c.id !== id);
  renderCaptionLibrary();
  toast('Caption removed');
}

function clEdit(id) {
  const c = clCaptions.find(x => x.id === id);
  if (!c) return;
  const newText = prompt('Edit caption:', c.text);
  if (newText === null || newText.trim() === '') return;
  c.text = newText.trim();
  c.words = c.text.split(/\s+/).length;
  c.updated = new Date().toISOString();
  const newTheme = prompt('Theme:', c.theme);
  if (newTheme !== null) c.theme = newTheme.trim() || 'general';
  clPut(c).then(() => { renderCaptionLibrary(); toast('Caption updated'); });
}

// BULK ACTIONS
function clBulkToCanvas() {
  const sel = getSelectedCaptions();
  sel.forEach(c => clToCanvas(c.id));
  clDeselectAll();
}

function clBulkToSeed() {
  const sel = getSelectedCaptions();
  document.getElementById('seed-input').value = sel.map(c => c.text).join('\n\n');
  clDeselectAll();
  setCapSub('multiplier');
  toast(sel.length + ' captions loaded as seed');
}

function clBulkCopy() {
  const sel = getSelectedCaptions();
  navigator.clipboard.writeText(sel.map(c => c.text).join('\n\n'));
  clDeselectAll();
  toast(sel.length + ' captions copied');
}

function clBulkExport() {
  const sel = getSelectedCaptions();
  if (!sel.length) return;
  const data = JSON.stringify(sel, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'captions-export-' + new Date().toISOString().slice(0, 10) + '.json';
  a.click();
  URL.revokeObjectURL(a.href);
  clDeselectAll();
  toast('Exported ' + sel.length + ' captions');
}

// ADD MANUAL
function addCaptionManual() {
  const text = prompt('Enter caption text:');
  if (!text || !text.trim()) return;
  const theme = prompt('Theme (e.g. mindset, truth, courage, discipline, manifesto, training, vulnerability):', 'general') || 'general';
  const c = makeCaption(text, { theme: theme.toLowerCase() });
  clPut(c).then(() => {
    clCaptions.push(c);
    renderCaptionLibrary();
    toast('Caption added');
  });
}

// IMPORT
async function importCaptions(files) {
  let imported = 0;
  for (const file of files) {
    const text = await readFileText(file);
    const ext = file.name.split('.').pop().toLowerCase();
    let newCaptions = [];

    if (ext === 'json') {
      newCaptions = parseJsonCaptions(text, file.name);
    } else if (ext === 'csv') {
      newCaptions = parseCsvCaptions(text, file.name);
    } else {
      // MD or TXT — split by double newlines
      newCaptions = parseTextCaptions(text, file.name);
    }

    // Deduplicate against existing
    for (const c of newCaptions) {
      const exists = clCaptions.some(existing => existing.text === c.text);
      if (!exists) {
        await clPut(c);
        clCaptions.push(c);
        imported++;
      }
    }
  }
  renderCaptionLibrary();
  toast('Imported ' + imported + ' caption' + (imported !== 1 ? 's' : ''));
  // Reset file input
  document.getElementById('cl-file').value = '';
}

function readFileText(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result);
    reader.readAsText(file);
  });
}

function parseJsonCaptions(text, source) {
  try {
    let data = JSON.parse(text);
    if (!Array.isArray(data)) data = [data];
    return data.map(item => {
      // Flexible: support {text}, {content}, {caption}, {q}
      const t = item.text || item.content || item.caption || item.q || item.body || '';
      if (!t.trim()) return null;
      return makeCaption(t, {
        theme: item.theme || item.t || item.category || 'imported',
        voice: item.voice || item.voice_mode || '',
        platform: Array.isArray(item.platform) ? item.platform : (item.platform ? [item.platform] : []),
        source: source,
        scale: item.scale || ''
      });
    }).filter(Boolean);
  } catch(e) { toast('JSON parse error: ' + e.message); return []; }
}

function parseCsvCaptions(text, source) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) return [];
  const headers = lines[0].toLowerCase().split(',').map(h => h.trim().replace(/"/g, ''));
  const textIdx = headers.findIndex(h => ['text','content','caption','body','quote'].includes(h));
  const themeIdx = headers.findIndex(h => ['theme','category','tag','type'].includes(h));
  if (textIdx === -1) { toast('CSV needs a text/content/caption column'); return []; }
  const results = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(',').map(c => c.trim().replace(/^"|"$/g, ''));
    const t = cols[textIdx] || '';
    if (t.trim()) {
      results.push(makeCaption(t, {
        theme: (themeIdx >= 0 ? cols[themeIdx] : '') || 'imported',
        source: source
      }));
    }
  }
  return results;
}

function parseTextCaptions(text, source) {
  // Split by double newline, each block is a caption
  const blocks = text.split(/\n\s*\n/).map(b => b.trim()).filter(b => b.length > 10);
  return blocks.map(block => {
    // Try to detect theme from common patterns
    let theme = 'imported';
    const lc = block.toLowerCase();
    if (lc.includes('trust') || lc.includes('faith') || lc.includes('courage')) theme = 'courage';
    else if (lc.includes('discipline') || lc.includes('focus') || lc.includes('effort')) theme = 'discipline';
    else if (lc.includes('truth') || lc.includes('clarity') || lc.includes('honest')) theme = 'truth';
    else if (lc.includes('rise') || lc.includes('become') || lc.includes('manifesto')) theme = 'manifesto';
    else if (lc.includes('mindset') || lc.includes('will') || lc.includes('purpose')) theme = 'mindset';
    else if (lc.includes('training') || lc.includes('movement') || lc.includes('exercise')) theme = 'training';
    else if (lc.includes('vulnerability') || lc.includes('growth') || lc.includes('heal')) theme = 'vulnerability';
    return makeCaption(block, { theme, source });
  });
}

// MULTIPLY + SAVE TO LIBRARY
function multiplyAndSave() {
  multiply();
  // Save the original seed to the library
  const seed = document.getElementById('seed-input').value.trim();
  if (!seed) return;
  const c = makeCaption(seed, { theme: 'seed', voice: currentVoice, source: 'multiplier' });
  clPut(c).then(() => {
    clCaptions.push(c);
    renderCaptionLibrary();
    toast('Seed saved to library');
  });
}

// EXPORT ALL CAPTIONS
function clExportAll(fmt) {
  if (!clCaptions.length) { toast('No captions to export'); return; }
  let content, mimeType, ext;
  if (fmt === 'json') {
    content = JSON.stringify(clCaptions, null, 2);
    mimeType = 'application/json';
    ext = 'json';
  } else if (fmt === 'md') {
    content = clCaptions.map(c =>
      '## ' + c.theme.toUpperCase() + (c.voice ? ' / ' + c.voice : '') + '\n\n' + c.text + '\n'
    ).join('\n---\n\n');
    mimeType = 'text/markdown';
    ext = 'md';
  } else {
    content = clCaptions.map(c => c.text).join('\n\n---\n\n');
    mimeType = 'text/plain';
    ext = 'txt';
  }
  const blob = new Blob([content], { type: mimeType });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'content-beast-captions-' + new Date().toISOString().slice(0, 10) + '.' + ext;
  a.click();
  URL.revokeObjectURL(a.href);
  toast('Exported ' + clCaptions.length + ' captions as ' + ext.toUpperCase());
}

// SEED LIBRARY → CAPTION LIBRARY (import built-in seeds)
async function importSeedsToLibrary() {
  let imported = 0;
  for (const s of SEED_LIBRARY) {
    const exists = clCaptions.some(c => c.text === s.q);
    if (!exists) {
      const c = makeCaption(s.q, { theme: s.t, source: 'seed-library' });
      await clPut(c);
      clCaptions.push(c);
      imported++;
    }
  }
  renderCaptionLibrary();
  toast('Imported ' + imported + ' seeds to library');
}

// GABO CONTENT → CAPTION LIBRARY (full content bank)
async function seedGaboCaptions() {
  let imported = 0;
  for (const g of GABO_CAPTIONS) {
    const exists = clCaptions.some(c => c.text === g.q);
    if (!exists) {
      const c = makeCaption(g.q, {
        theme: g.t,
        source: g.s || 'gabo-content',
        voice: g.v || ''
      });
      await clPut(c);
      clCaptions.push(c);
      imported++;
    }
  }
  // Also import seed library entries
  for (const s of SEED_LIBRARY) {
    const exists = clCaptions.some(c => c.text === s.q);
    if (!exists) {
      const c = makeCaption(s.q, { theme: s.t, source: 'seed-library' });
      await clPut(c);
      clCaptions.push(c);
      imported++;
    }
  }
  if (imported > 0) {
    renderCaptionLibrary();
    toast('Loaded ' + imported + ' captions from content library');
  }
}

// ============================================================
// DRAGGABLE PANEL RESIZE
// ============================================================
function initPanelResize() {
  const ws = document.getElementById('workspace');
  const lib = document.getElementById('lib-panel');
  const ctrl = document.getElementById('ctrl-panel');

  // Insert resize handles INSIDE panels (positioned absolute at right edge)
  const h1 = document.createElement('div');
  h1.className = 'resize-handle';
  h1.id = 'rh-lib';
  lib.appendChild(h1);

  const h2 = document.createElement('div');
  h2.className = 'resize-handle';
  h2.id = 'rh-ctrl';
  ctrl.appendChild(h2);

  let dragging = null;
  let startX = 0;
  let startCols = [];

  function onDown(e, target) {
    e.preventDefault();
    dragging = target;
    startX = e.clientX;
    startCols = getComputedStyle(ws).gridTemplateColumns.split(' ').map(v => parseFloat(v));
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    e.target.classList.add('dragging');
  }

  h1.addEventListener('mousedown', e => onDown(e, 'lib'));
  h2.addEventListener('mousedown', e => onDown(e, 'ctrl'));

  document.addEventListener('mousemove', e => {
    if (!dragging) return;
    const delta = e.clientX - startX;
    if (dragging === 'lib') {
      const newW = Math.max(120, Math.min(400, startCols[0] + delta));
      ws.style.gridTemplateColumns = newW + 'px 1fr 1fr';
    } else {
      const newW = Math.max(200, Math.min(600, startCols[1] + delta));
      ws.style.gridTemplateColumns = startCols[0] + 'px ' + newW + 'px 1fr';
    }
  });

  document.addEventListener('mouseup', () => {
    if (dragging) {
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
      document.querySelectorAll('.resize-handle').forEach(h => h.classList.remove('dragging'));
      dragging = null;
    }
  });
}

// ============================================================
// SHORTCUTS HELP
// ============================================================
function openShortcuts() {
  document.getElementById('sc-overlay').classList.add('open');
  document.getElementById('sc-modal').classList.add('open');
}
function closeShortcuts() {
  document.getElementById('sc-overlay').classList.remove('open');
  document.getElementById('sc-modal').classList.remove('open');
}

// ============================================================
// KEYBOARD SHORTCUTS
// ============================================================
document.addEventListener('keydown', e => {
  if (e.metaKey || e.ctrlKey) {
    if (e.shiftKey && e.key === 's') { e.preventDefault(); openExport(); return; }
    if (e.key === 's') { e.preventDefault(); saveDocs(); toast('Saved'); return; }
    if (e.key === 'n') { e.preventDefault(); newDoc(); return; }
    if (e.key === 'k') { e.preventDefault(); openCmd(); return; }
    if (e.key === 'f') { e.preventDefault(); toggleFind(); return; }
    if (e.key === '/') { e.preventDefault(); openShortcuts(); return; }
    if (e.key === 'p') { e.preventDefault(); window.print(); return; }
  }
  if (e.key === 'Escape') {
    if (document.body.classList.contains('fullscreen-mode')) toggleFullscreen();
    if (document.getElementById('export-panel').classList.contains('open')) closeExport();
    if (document.getElementById('find-bar').classList.contains('open')) toggleFind();
    if (document.getElementById('ver-panel').classList.contains('open')) closeVersions();
    if (document.getElementById('tbl-modal').classList.contains('open')) closeTblModal();
    if (document.getElementById('sc-modal').classList.contains('open')) closeShortcuts();
    if (document.getElementById('cmd-palette').classList.contains('open')) closeCmd();
  }
});

// ============================================================
// VOICE CARDS (Rich Selection)
// ============================================================
function setVoiceCard(el) {
  currentVoice = el.dataset.v;
  document.querySelectorAll('.voice-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
}

// ============================================================
// SLIDER UI (Collision Matrix Style)
// ============================================================
const SLIDER_LEVELS = {
  intensity: ['whisper','soft','gentle','measured','confident','passionate','urgent','explosive','volcanic','nuclear'],
  vuln: ['guarded','professional','measured','open','honest','exposed','raw','bleeding','shattered','naked'],
  abstract: ['concrete','specific','grounded','practical','balanced','conceptual','abstract','philosophical','cosmic','transcendent']
};

let voiceDials = { intensity: 5, vuln: 4, abstract: 4 };

function updateSliderUI(key, val) {
  val = parseInt(val);
  voiceDials[key] = val;
  document.getElementById('sl-' + key + '-val').textContent = val;
  document.getElementById('sl-' + key + '-level').textContent = SLIDER_LEVELS[key][val - 1] || '';
  // Update track gradient
  const pct = ((val - 1) / 9) * 100;
  const slider = document.getElementById('sl-' + key);
  slider.style.background = 'linear-gradient(to right, rgba(168,85,247,0.3) ' + pct + '%, rgba(255,255,255,0.06) ' + pct + '%)';
}

// ============================================================
// PIPELINE ANIMATION
// ============================================================
function animatePipeline(stages) {
  const ids = ['ps-ingest','ps-parse','ps-classify','ps-index','ps-ready'];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.className = 'pipeline-stage'; }
  });
  stages.forEach((s, i) => {
    setTimeout(() => {
      const el = document.getElementById(ids[i]);
      if (el) el.className = 'pipeline-stage ' + s;
    }, i * 300);
  });
}

// ============================================================
// SIDEBAR TOGGLE (Astra-style + localStorage)
// ============================================================
function toggleSidebar() {
  const ws = document.getElementById('workspace');
  const btn = document.getElementById('sidebar-btn');
  const isHidden = ws.classList.toggle('two-col');
  if (btn) btn.classList.toggle('active', !isHidden);
  localStorage.setItem('cb-sidebar', isHidden ? '0' : '1');
}

function togglePanel(panel) {
  if (panel === 'lib') return toggleSidebar();
  if (panel === 'toolbar') {
    const tb = document.getElementById('preview-toolbar');
    tb.style.display = tb.style.display === 'none' ? '' : 'none';
  }
}

// ============================================================
// MOBILE NAVIGATION
// ============================================================
function mobileTab(tab, btn) {
  document.getElementById('lib-panel').classList.remove('mobile-show');
  document.getElementById('ctrl-panel').classList.remove('mobile-show');
  document.querySelectorAll('.mobile-tab').forEach(function(b) { b.classList.remove('active'); });
  if (btn) btn.classList.add('active');
  if (tab === 'lib') document.getElementById('lib-panel').classList.add('mobile-show');
  else if (tab === 'ctrl') document.getElementById('ctrl-panel').classList.add('mobile-show');
}

// ============================================================
// COLLAPSIBLE SECTIONS
// ============================================================
function toggleSection(el) {
  el.classList.toggle('collapsed');
  const content = el.nextElementSibling;
  if (content && content.classList.contains('section-content')) {
    content.classList.toggle('collapsed');
  }
}

// ============================================================
// UNIVERSAL DRAG-DROP SYSTEM
// ============================================================
let dragPayload = null;
let dragGhost = null;

function initUniversalDragDrop() {
  // Create reusable ghost element
  dragGhost = document.createElement('div');
  dragGhost.className = 'drag-ghost';
  dragGhost.style.display = 'none';
  document.body.appendChild(dragGhost);

  // Setup drop targets
  setupDropTarget(document.getElementById('pdf-wrap'), 'canvas');
  setupDropTarget(document.getElementById('seed-input'), 'seed');

  // Setup caption library import zone as drop target
  const clImport = document.querySelector('.cl-import-zone');
  if (clImport) setupDropTarget(clImport, 'cl-import');
}

function startDrag(e, type, data, text) {
  e.preventDefault();
  dragPayload = { type: type, data: data, text: text };
  dragGhost.textContent = text.length > 50 ? text.substring(0, 50) + '...' : text;
  dragGhost.style.display = 'block';
  dragGhost.style.left = e.clientX + 12 + 'px';
  dragGhost.style.top = e.clientY + 12 + 'px';

  // Highlight all valid drop targets
  document.querySelectorAll('.drop-target').forEach(dt => {
    dt.style.transition = 'all 0.2s ease';
  });

  document.addEventListener('mousemove', onDragMove);
  document.addEventListener('mouseup', onDragEnd);
  document.body.style.cursor = 'grabbing';
  document.body.style.userSelect = 'none';
}

function onDragMove(e) {
  if (!dragPayload) return;
  dragGhost.style.left = e.clientX + 12 + 'px';
  dragGhost.style.top = e.clientY + 12 + 'px';

  // Check drop targets under cursor
  document.querySelectorAll('.drop-target').forEach(dt => {
    const r = dt.getBoundingClientRect();
    const over = e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom;
    dt.classList.toggle('drag-over', over);
  });
}

function onDragEnd(e) {
  if (!dragPayload) return;
  document.removeEventListener('mousemove', onDragMove);
  document.removeEventListener('mouseup', onDragEnd);
  document.body.style.cursor = '';
  document.body.style.userSelect = '';
  dragGhost.style.display = 'none';

  // Find the drop target under cursor
  const dropTarget = document.elementFromPoint(e.clientX, e.clientY);
  const dt = dropTarget ? dropTarget.closest('.drop-target') : null;

  if (dt) {
    const dropType = dt.dataset.drop;
    handleDrop(dropType, dragPayload);
  }

  // Clean up
  document.querySelectorAll('.drop-target.drag-over').forEach(el => el.classList.remove('drag-over'));
  dragPayload = null;
}

function handleDrop(dropType, payload) {
  if (dropType === 'canvas') {
    const canvas = document.getElementById('canvas');
    const footer = canvas.querySelector('.pdf-footer');
    let html = '';
    if (payload.type === 'atom') {
      const a = payload.data;
      if (a.type === 'heading') html = '<h' + (a.level || 2) + '>' + esc(a.text) + '</h' + (a.level || 2) + '>';
      else if (a.type === 'quote') html = '<blockquote>' + esc(a.text) + '</blockquote>';
      else if (a.type === 'list') html = '<li>' + esc(a.text) + '</li>';
      else if (a.type === 'code') html = '<pre style="background:#f4f4f5;padding:12px;border-radius:4px;font-family:JetBrains Mono,monospace;font-size:11px;margin:12px 0">' + esc(a.text) + '</pre>';
      else html = '<p>' + esc(a.text) + '</p>';
    } else {
      html = '<p>' + esc(payload.text) + '</p>';
    }
    const el = document.createElement('div');
    el.innerHTML = html;
    if (footer) canvas.insertBefore(el.firstChild, footer);
    else canvas.appendChild(el.firstChild);
    setMode('pdf');
    scheduleSave();
    toast('Dropped to canvas');
  } else if (dropType === 'seed') {
    const seedInput = document.getElementById('seed-input');
    seedInput.value = (seedInput.value ? seedInput.value + '\n\n' : '') + payload.text;
    setMode('caption');
    setCapSub('multiplier');
    toast('Dropped to seed');
  }
}

function setupDropTarget(el, type) {
  if (!el) return;
  el.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('drag-over');
  });
  el.addEventListener('dragleave', function() {
    this.classList.remove('drag-over');
  });
  el.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('drag-over');
    // Handle native HTML5 drag-drop (for file drops or text)
    const text = e.dataTransfer.getData('text/plain');
    const cbText = e.dataTransfer.getData('application/x-cb-caption');
    const abText = e.dataTransfer.getData('application/x-cb-atom');

    if (cbText) {
      try {
        const payload = JSON.parse(cbText);
        handleDrop(type, { type: 'caption', data: payload, text: payload.text });
      } catch(err) {}
    } else if (abText) {
      try {
        const payload = JSON.parse(abText);
        handleDrop(type, { type: 'atom', data: payload, text: payload.text });
      } catch(err) {}
    } else if (text && type === 'seed') {
      const seedInput = document.getElementById('seed-input');
      seedInput.value = (seedInput.value ? seedInput.value + '\n\n' : '') + text;
      toast('Text dropped to seed');
    } else if (e.dataTransfer.files.length) {
      if (type === 'canvas') handleFile(e.dataTransfer.files[0]);
    }
  });
}

// ============================================================
// INIT
// ============================================================
loadDocs();
updateWordCount();
renderSeedLibrary();
initPanelResize();
initUniversalDragDrop();
openCaptionDB().then(() => clLoadAll()).then(() => { if (clCaptions.length === 0) seedGaboCaptions(); }).catch(e => console.warn('IndexedDB:', e));
// Restore sidebar state from localStorage
if(localStorage.getItem('cb-sidebar')==='0'){document.getElementById('workspace').classList.add('two-col');var sb=document.getElementById('sidebar-btn');if(sb)sb.classList.remove('active');}
</script>
</body>
</html>
