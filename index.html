<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CONTENT BEAST — PDF Maker + Content Tools</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Sora:wght@300;400;500;600;700&display=swap');

*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg-void:#020202;--bg-base:#050505;--bg-elevated:#0a0a0a;--bg-surface:#111;
  --border:#1a1a1a;--border-hover:#2a2a2a;--border-active:#333;
  --text-primary:#fff;--text-secondary:#a1a1aa;--text-muted:#52525b;
  --accent:#a855f7;--cyan:#06b6d4;--green:#22c55e;--amber:#f59e0b;--red:#ef4444;
  --mono:'JetBrains Mono',monospace;--sans:'Sora',system-ui,sans-serif;
}
body{font-family:var(--mono);background:var(--bg-void);color:var(--text-secondary);height:100vh;overflow:hidden}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:var(--bg-base)}
::-webkit-scrollbar-thumb{background:var(--border-hover);border-radius:2px}

/* === APP SHELL === */
.app{display:grid;grid-template-rows:44px 1fr 28px;height:100vh}

/* HEADER */
.hdr{border-bottom:1px solid var(--border);background:var(--bg-base);display:flex;align-items:center;padding:0 12px;gap:12px}
.hdr-brand{display:flex;align-items:center;gap:8px}
.hdr-brand h1{color:var(--text-primary);font-size:12px;font-weight:700;letter-spacing:-0.01em}
.hdr-brand .ver{font-size:8px;color:var(--text-muted);padding:1px 5px;border:1px solid var(--border);border-radius:3px}
.hdr .tab-bar{display:flex;gap:1px;background:var(--bg-base);border:1px solid var(--border);border-radius:4px;padding:2px}
.tab-btn{padding:5px 10px;font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;background:transparent;border:none;color:var(--text-muted);cursor:pointer;border-radius:3px;font-family:var(--mono);transition:all 0.15s}
.tab-btn:hover{color:var(--text-secondary)}
.tab-btn.active{background:var(--accent);color:#fff}
.hdr-right{margin-left:auto;display:flex;gap:8px;align-items:center}
.status{display:inline-flex;align-items:center;gap:5px;padding:3px 8px;border-radius:10px;font-size:8px;font-weight:500;text-transform:uppercase}
.status-ok{background:rgba(34,197,94,0.1);color:var(--green)}
.status-busy{background:rgba(245,158,11,0.1);color:var(--amber)}

/* FOOTER */
.ftr{border-top:1px solid var(--border);background:var(--bg-base);display:flex;align-items:center;justify-content:space-between;padding:0 12px;font-size:8px;color:var(--text-muted)}

/* === 3-COLUMN LAYOUT === */
.workspace{display:grid;grid-template-columns:200px 1fr 1fr;overflow:hidden}
.workspace.two-col{grid-template-columns:0px 1fr 1fr}
.workspace.caption-mode{grid-template-columns:200px 320px 1fr}

/* LEFT: LIBRARY */
.lib{background:var(--bg-base);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transition:width 0.2s}
.lib-hdr{padding:8px;border-bottom:1px solid var(--border);display:flex;gap:4px}
.lib-list{flex:1;overflow-y:auto;padding:4px}
.lib-item{padding:8px 10px;border-radius:4px;cursor:pointer;transition:all 0.1s;margin-bottom:2px}
.lib-item:hover{background:var(--bg-elevated)}
.lib-item.active{background:rgba(168,85,247,0.12);border-left:2px solid var(--accent)}
.lib-item .li-title{font-size:10px;color:var(--text-primary);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lib-item .li-meta{font-size:8px;color:var(--text-muted);margin-top:2px}
.lib-empty{padding:16px;text-align:center;font-size:9px;color:var(--text-muted);line-height:1.6}

/* MID: CONTROLS */
.ctrl{border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.ctrl-hdr{background:var(--bg-surface);border-bottom:1px solid var(--border);padding:8px 12px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.ctrl-hdr .title{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.12em}
.ctrl-body{flex:1;overflow-y:auto;padding:12px}

/* RIGHT: PREVIEW */
.preview{display:flex;flex-direction:column;overflow:hidden}
.preview-hdr{background:var(--bg-surface);border-bottom:1px solid var(--border);padding:6px 12px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.preview-hdr .title{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.12em;color:var(--green)}
.preview-toolbar{display:flex;gap:3px;flex-wrap:wrap;align-items:center}
.preview-body{flex:1;overflow-y:auto;padding:20px;background:#1a1a1a}

/* FORM */
textarea,input[type="text"],select{width:100%;background:var(--bg-base);border:1px solid var(--border);border-radius:3px;padding:8px 10px;color:var(--text-primary);font-family:var(--mono);font-size:11px;resize:none;transition:border-color 0.15s}
textarea:focus,input:focus,select:focus{outline:none;border-color:var(--accent)}
.lbl{display:block;font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:4px;font-weight:600}
.row{margin-bottom:10px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:6px}

/* BUTTONS */
.btn{padding:6px 12px;border:none;border-radius:3px;font-family:var(--mono);font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.06em;cursor:pointer;transition:all 0.12s;display:inline-flex;align-items:center;gap:4px}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:#9333ea}
.btn-outline{background:transparent;color:var(--text-secondary);border:1px solid var(--border)}
.btn-outline:hover{border-color:var(--border-hover);color:#fff}
.btn-green{background:var(--green);color:#fff}
.btn-green:hover{background:#16a34a}
.btn-cyan{background:var(--cyan);color:#fff}
.btn-red{background:transparent;color:var(--red);border:1px solid rgba(239,68,68,0.3)}
.btn-red:hover{background:rgba(239,68,68,0.1)}
.btn-sm{padding:4px 8px;font-size:8px}
.btn-block{width:100%}
.btn-icon{width:26px;height:26px;padding:0;display:inline-flex;align-items:center;justify-content:center;background:var(--bg-base);border:1px solid var(--border);border-radius:3px;color:var(--text-muted);cursor:pointer;font-family:var(--mono);font-size:10px;font-weight:700;transition:all 0.1s}
.btn-icon:hover{border-color:var(--border-hover);color:var(--text-primary)}
.btn-icon.active{border-color:var(--accent);color:var(--accent);background:rgba(168,85,247,0.08)}

/* MODE BTNS */
.mode-btn{padding:5px 8px;font-size:8px;background:var(--bg-base);border:1px solid var(--border);border-radius:3px;color:var(--text-muted);cursor:pointer;transition:all 0.12s;font-family:var(--mono);font-weight:500}
.mode-btn:hover{border-color:var(--border-hover);color:var(--text-secondary)}
.mode-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(168,85,247,0.08)}

/* PRESET CARDS */
.preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.preset-card{background:var(--bg-base);border:1px solid var(--border);border-radius:3px;padding:8px;cursor:pointer;transition:all 0.12s}
.preset-card:hover{border-color:var(--border-hover)}
.preset-card.active{border-color:var(--accent);background:rgba(168,85,247,0.06)}
.preset-card .pn{font-size:9px;font-weight:600;color:var(--text-primary);margin-bottom:1px}
.preset-card .pd{font-size:7px;color:var(--text-muted)}

/* === PDF CANVAS === */
.pdf-canvas{background:#fff;color:#1a1a1a;font-family:var(--sans);padding:48px 56px;border-radius:3px;min-height:600px;position:relative;box-shadow:0 2px 20px rgba(0,0,0,0.5);line-height:1.7}
.pdf-canvas[contenteditable]{outline:none;cursor:text}
.pdf-canvas[contenteditable]:focus{box-shadow:0 0 0 2px var(--accent),0 2px 20px rgba(0,0,0,0.5)}

.pdf-canvas h1{font-size:28px;font-weight:700;margin-bottom:4px;color:#111;line-height:1.2}
.pdf-canvas h2{font-size:13px;color:#888;margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid #111}
.pdf-canvas h3{font-size:15px;font-weight:700;margin-top:24px;margin-bottom:8px;color:#222;text-transform:uppercase;letter-spacing:0.04em}
.pdf-canvas h4{font-size:13px;font-weight:600;margin-top:16px;margin-bottom:6px;color:#444}
.pdf-canvas p{font-size:12px;margin-bottom:8px;color:#333}
.pdf-canvas ul,.pdf-canvas ol{margin-left:20px;margin-bottom:10px}
.pdf-canvas li{font-size:12px;margin-bottom:3px;color:#333}
.pdf-canvas strong{font-weight:700;color:#111}
.pdf-canvas em{font-style:italic}
.pdf-canvas hr{border:none;border-top:1px solid #ddd;margin:20px 0}
.pdf-canvas blockquote{border-left:3px solid #a855f7;padding:8px 16px;margin:12px 0;background:#faf5ff;font-style:italic;color:#555}
.pdf-canvas code{background:#f4f4f5;padding:1px 4px;border-radius:2px;font-family:var(--mono);font-size:11px}
.pdf-canvas .pdf-footer{font-size:9px;color:#aaa;margin-top:40px;padding-top:12px;border-top:1px solid #eee;font-family:var(--mono);letter-spacing:0.04em}
.pdf-canvas table{width:100%;border-collapse:collapse;margin:12px 0;font-size:12px}
.pdf-canvas th{background:#f8f8f8;font-weight:600;text-align:left;padding:8px 10px;border:1px solid #e5e5e5;font-size:11px;text-transform:uppercase;letter-spacing:0.03em}
.pdf-canvas td{padding:6px 10px;border:1px solid #e5e5e5;color:#444}

/* DARK */
.pdf-canvas.tpl-dark{background:#0a0a0a;color:#e2e8f0}
.pdf-canvas.tpl-dark h1{color:#fff}
.pdf-canvas.tpl-dark h2{color:#a855f7;border-bottom-color:#a855f7}
.pdf-canvas.tpl-dark h3{color:#22d3ee}
.pdf-canvas.tpl-dark h4{color:#94a3b8}
.pdf-canvas.tpl-dark p,.pdf-canvas.tpl-dark li{color:#cbd5e1}
.pdf-canvas.tpl-dark blockquote{background:rgba(168,85,247,0.05);border-left-color:#a855f7;color:#a78bfa}
.pdf-canvas.tpl-dark th{background:#111;border-color:#222;color:#94a3b8}
.pdf-canvas.tpl-dark td{border-color:#1a1a1a;color:#94a3b8}
.pdf-canvas.tpl-dark hr{border-top-color:#222}
.pdf-canvas.tpl-dark .pdf-footer{color:#334155;border-top-color:#1e293b}

/* SATURNO */
.pdf-canvas.tpl-saturno{background:linear-gradient(180deg,#030508 0%,#050711 100%);color:#e2e8f0;border:1px solid #1a1f2e;padding:48px 52px}
.pdf-canvas.tpl-saturno h1{color:#fff;font-size:30px;letter-spacing:-0.02em}
.pdf-canvas.tpl-saturno h2{color:#06b6d4;border-bottom-color:#06b6d430;font-weight:300}
.pdf-canvas.tpl-saturno h3{color:#a855f7}
.pdf-canvas.tpl-saturno h4{color:#06b6d4}
.pdf-canvas.tpl-saturno p,.pdf-canvas.tpl-saturno li{color:#94a3b8}
.pdf-canvas.tpl-saturno strong{color:#e2e8f0}
.pdf-canvas.tpl-saturno blockquote{background:rgba(6,182,212,0.05);border-left-color:#06b6d4;color:#67e8f9}
.pdf-canvas.tpl-saturno th{background:rgba(168,85,247,0.08);border-color:#1e293b;color:#a78bfa}
.pdf-canvas.tpl-saturno td{border-color:#1e293b;color:#94a3b8}
.pdf-canvas.tpl-saturno hr{border-top-color:#1e293b}
.pdf-canvas.tpl-saturno .pdf-footer{color:#334155;border-top-color:#1e293b}
.pdf-canvas.tpl-saturno .level-badge{display:inline-block;padding:3px 10px;border-radius:3px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:12px;font-family:var(--mono)}
.level-badge.lv-foundation{background:rgba(34,197,94,0.12);color:#4ade80;border:1px solid rgba(34,197,94,0.25)}
.level-badge.lv-intermediate{background:rgba(6,182,212,0.12);color:#22d3ee;border:1px solid rgba(6,182,212,0.25)}
.level-badge.lv-advanced{background:rgba(168,85,247,0.12);color:#c084fc;border:1px solid rgba(168,85,247,0.25)}
.level-badge.lv-elite{background:rgba(245,158,11,0.12);color:#fbbf24;border:1px solid rgba(245,158,11,0.25)}

/* MINIMAL */
.pdf-canvas.tpl-minimal{padding:60px 64px;font-family:Georgia,'Times New Roman',serif}
.pdf-canvas.tpl-minimal h1{font-size:24px;font-weight:400;letter-spacing:0.01em}
.pdf-canvas.tpl-minimal h2{font-size:11px;color:#aaa;border-bottom:1px solid #eee;font-weight:400}
.pdf-canvas.tpl-minimal h3{font-size:13px;font-weight:400;text-transform:none;color:#555}

/* PAGE EST */
.page-est{font-size:8px;color:var(--text-muted);text-align:center;padding:6px;margin-top:8px}

/* ZOOM */
.zoom-bar{display:flex;align-items:center;gap:4px;margin-left:auto}
.zoom-bar .zb{font-size:8px;color:var(--text-muted);font-family:var(--mono);min-width:32px;text-align:center}

/* IMAGE IN CANVAS */
.pdf-canvas img{max-width:100%;height:auto;border-radius:3px;margin:8px 0}
.pdf-canvas .img-block{position:relative;display:inline-block;margin:8px 0}
.pdf-canvas .img-block img{display:block}

/* PAGE BREAK MARKER */
.page-break{border:none;border-top:2px dashed var(--accent);margin:24px 0;position:relative;page-break-after:always}
.page-break::after{content:'PAGE BREAK';position:absolute;top:-8px;left:50%;transform:translateX(-50%);background:var(--bg-elevated);padding:0 8px;font-size:7px;color:var(--accent);font-family:var(--mono);letter-spacing:0.1em}

/* EXPORT SETTINGS PANEL */
.export-panel{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-elevated);border:1px solid var(--border);border-radius:6px;padding:20px;width:360px;z-index:1000;display:none}
.export-panel.open{display:block}
.export-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:999;display:none}
.export-overlay.open{display:block}
.export-panel h3{font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.08em}
.export-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.export-row label{font-size:9px;color:var(--text-secondary)}
.export-row select,.export-row input[type="number"]{width:140px;padding:6px 8px;font-size:10px}

/* FULLSCREEN CANVAS */
.fullscreen-mode .workspace{grid-template-columns:0 0 1fr !important}
.fullscreen-mode .lib,.fullscreen-mode .ctrl{display:none !important}
.fullscreen-mode .preview-body{padding:32px 10%}

/* COVER PAGE */
.cover-page{text-align:center;padding:80px 60px;min-height:500px;display:flex;flex-direction:column;justify-content:center;align-items:center}
.cover-page h1{font-size:42px;margin-bottom:8px;line-height:1.1}
.cover-page .cover-sub{font-size:16px;color:#06b6d4;margin-bottom:40px;font-weight:300}
.cover-page .cover-author{font-size:14px;color:#94a3b8;margin-top:auto}
.cover-page .cover-brand{font-size:10px;color:#334155;margin-top:16px;letter-spacing:0.1em;text-transform:uppercase;font-family:var(--mono)}
.cover-page .cover-line{width:60px;height:2px;background:var(--accent);margin:24px auto}

/* TOOLBAR SEP */
.tb-sep{width:1px;height:16px;background:var(--border);margin:0 3px}

/* CAPTION */
.variant-card{background:var(--bg-base);border-left:3px solid var(--accent);padding:10px;margin-bottom:6px;border-radius:0 3px 3px 0}
.variant-card.ig{border-color:#e1306c}
.variant-card.email{border-color:var(--amber)}
.variant-card.yt{border-color:#ff0000}
.variant-card.twitter{border-color:#1da1f2}
.variant-card.linkedin{border-color:#0077b5}
.variant-card.tiktok{border-color:#69c9d0}
.chk{display:flex;align-items:center;gap:6px;padding:5px 8px;background:var(--bg-base);border:1px solid var(--border);border-radius:3px;cursor:pointer;transition:all 0.12s;font-size:9px}
.chk:hover{border-color:var(--border-hover)}
.chk.on{border-color:var(--accent);background:rgba(168,85,247,0.08)}
.chk input{display:none}

/* TOAST */
.toast{position:fixed;bottom:16px;right:16px;background:var(--bg-surface);border:1px solid var(--accent);color:var(--text-primary);padding:8px 14px;border-radius:3px;font-size:10px;opacity:0;transition:opacity 0.2s;pointer-events:none;z-index:9999;font-family:var(--mono)}
.toast.show{opacity:1}

/* DROP ZONE */
.drop-zone{border:2px dashed var(--border);border-radius:4px;padding:20px;text-align:center;margin-bottom:10px;transition:all 0.2s;cursor:pointer}
.drop-zone:hover,.drop-zone.over{border-color:var(--accent);background:rgba(168,85,247,0.04)}
.drop-zone .dz-text{font-size:9px;color:var(--text-muted)}
</style>
</head>
<body>
<div class="app">

<div class="hdr">
  <div class="hdr-brand">
    <h1>CONTENT BEAST</h1>
    <span class="ver">v3.0</span>
  </div>
  <div class="tab-bar">
    <button class="tab-btn active" onclick="setMode('pdf')">PDF Maker</button>
    <button class="tab-btn" onclick="setMode('caption')">Captions</button>
  </div>
  <div class="hdr-right">
    <span id="save-ind" style="font-size:8px;color:var(--text-muted);opacity:0;transition:opacity 0.3s">Saved</span>
    <span id="status" class="status status-ok"><span style="width:5px;height:5px;border-radius:50%;background:currentColor;display:inline-block"></span> READY</span>
  </div>
</div>

<div class="workspace" id="workspace">

  <!-- LIBRARY -->
  <div class="lib" id="lib-panel">
    <div class="lib-hdr">
      <button class="btn btn-primary btn-sm" style="flex:1" onclick="newDoc()">+ New</button>
      <button class="btn btn-outline btn-sm" onclick="importFile()" title="Import .md or .txt">Import</button>
    </div>
    <div class="lib-list" id="lib-list">
      <div class="lib-empty">No documents yet.<br>Click + New to start.</div>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="ctrl" id="ctrl-panel">
    <div class="ctrl-hdr">
      <span class="title" id="ctrl-title" style="color:var(--accent)">PDF Controls</span>
    </div>
    <div class="ctrl-body" id="ctrl-body">

      <!-- PDF CONTROLS -->
      <div id="pdf-ctrl">
        <div class="grid2 row">
          <div><label class="lbl">Title</label><input type="text" id="f-title" value="" placeholder="Document title" oninput="onFieldChange()"></div>
          <div><label class="lbl">Author</label><input type="text" id="f-author" value="Gabo Saturno" oninput="onFieldChange()"></div>
        </div>

        <div class="row">
          <label class="lbl">Template</label>
          <div style="display:flex;gap:3px;flex-wrap:wrap">
            <button class="mode-btn active" data-tpl="tpl-saturno" onclick="setTpl(this)">Saturno</button>
            <button class="mode-btn" data-tpl="tpl-dark" onclick="setTpl(this)">Dark</button>
            <button class="mode-btn" data-tpl="tpl-minimal" onclick="setTpl(this)">Minimal</button>
            <button class="mode-btn" data-tpl="" onclick="setTpl(this)">White</button>
          </div>
        </div>

        <div class="row">
          <label class="lbl">Level Badge</label>
          <div style="display:flex;gap:3px;flex-wrap:wrap">
            <button class="mode-btn active" data-lv="" onclick="setLv(this)">None</button>
            <button class="mode-btn" data-lv="foundation" onclick="setLv(this)" style="color:#4ade80">Foundation</button>
            <button class="mode-btn" data-lv="intermediate" onclick="setLv(this)" style="color:#22d3ee">Intermediate</button>
            <button class="mode-btn" data-lv="advanced" onclick="setLv(this)" style="color:#c084fc">Advanced</button>
            <button class="mode-btn" data-lv="elite" onclick="setLv(this)" style="color:#fbbf24">Elite</button>
          </div>
        </div>

        <div class="row">
          <label class="lbl">Presets</label>
          <div class="preset-grid">
            <div class="preset-card" onclick="loadPreset('program',this)"><div class="pn">Program PDF</div><div class="pd">Workout with exercises, sets, reps</div></div>
            <div class="preset-card" onclick="loadPreset('level',this)"><div class="pn">Level Guide</div><div class="pd">Foundation to Elite progression</div></div>
            <div class="preset-card" onclick="loadPreset('framework',this)"><div class="pn">Framework</div><div class="pd">Training methodology breakdown</div></div>
            <div class="preset-card" onclick="loadPreset('transcript',this)"><div class="pn">Transcript</div><div class="pd">Video key points + actions</div></div>
            <div class="preset-card" onclick="loadPreset('cover',this)"><div class="pn">Cover Page</div><div class="pd">Branded title page</div></div>
          </div>
        </div>

        <div class="row">
          <label class="lbl">Content (Markdown)</label>
          <div class="drop-zone" id="drop-zone" onclick="document.getElementById('f-content').focus()">
            <div class="dz-text">Drop .md / .txt file here or type below</div>
          </div>
          <textarea id="f-content" style="height:200px" placeholder="# Heading&#10;## Subheading&#10;### Section&#10;- Bullet points&#10;**Bold** *italic*&#10;> Blockquote&#10;---&#10;| Col1 | Col2 |&#10;|------|------|&#10;| data | data |" oninput="onFieldChange()"></textarea>
        </div>

        <div style="display:flex;gap:6px">
          <button onclick="renderPreview()" class="btn btn-outline" style="flex:1">Refresh</button>
          <button onclick="openExport()" class="btn btn-primary" style="flex:1">Export PDF</button>
          <button onclick="downloadHTML()" class="btn btn-outline" title="Download as HTML">HTML</button>
        </div>
      </div>

      <!-- CAPTION CONTROLS -->
      <div id="cap-ctrl" style="display:none">
        <div class="row">
          <label class="lbl">Seed Phrase</label>
          <textarea id="seed-input" style="height:120px" placeholder="Enter your core idea...&#10;&#10;Example: 'Mastery is not about perfection. It is about showing up before you are ready.'"></textarea>
        </div>
        <div class="row">
          <label class="lbl">Voice</label>
          <div style="display:flex;gap:3px;flex-wrap:wrap">
            <button class="mode-btn active" data-v="teacher" onclick="setVoice(this)">Teacher</button>
            <button class="mode-btn" data-v="raw" onclick="setVoice(this)">Raw</button>
            <button class="mode-btn" data-v="prophet" onclick="setVoice(this)">Prophet</button>
            <button class="mode-btn" data-v="rebel" onclick="setVoice(this)">Rebel</button>
            <button class="mode-btn" data-v="mystic" onclick="setVoice(this)">Mystic</button>
          </div>
        </div>
        <div class="row">
          <label class="lbl">Platforms</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px">
            <label class="chk on"><input type="checkbox" data-pl="ig" checked><span>Instagram</span></label>
            <label class="chk on"><input type="checkbox" data-pl="email" checked><span>Email</span></label>
            <label class="chk on"><input type="checkbox" data-pl="yt" checked><span>YouTube</span></label>
            <label class="chk"><input type="checkbox" data-pl="twitter"><span>Twitter/X</span></label>
            <label class="chk"><input type="checkbox" data-pl="linkedin"><span>LinkedIn</span></label>
            <label class="chk"><input type="checkbox" data-pl="tiktok"><span>TikTok</span></label>
          </div>
        </div>
        <button onclick="multiply()" class="btn btn-cyan btn-block">Multiply Variants</button>
      </div>
    </div>
  </div>

  <!-- PREVIEW -->
  <div class="preview">
    <div class="preview-hdr">
      <span class="title" id="preview-title">Live Preview</span>
      <div class="preview-toolbar" id="preview-toolbar">
        <button class="btn-icon" onclick="execCmd('bold')" title="Bold"><b>B</b></button>
        <button class="btn-icon" onclick="execCmd('italic')" title="Italic"><i>I</i></button>
        <button class="btn-icon" onclick="execCmd('underline')" title="Underline"><u>U</u></button>
        <span class="tb-sep"></span>
        <select onchange="execCmd('fontSize',this.value);this.selectedIndex=0" style="width:50px;padding:3px;font-size:8px;background:var(--bg-base);border:1px solid var(--border);color:var(--text-muted);border-radius:3px;font-family:var(--mono)" title="Font size">
          <option value="">Size</option>
          <option value="1">Small</option>
          <option value="3">Normal</option>
          <option value="5">Large</option>
          <option value="7">XL</option>
        </select>
        <span class="tb-sep"></span>
        <button class="btn-icon" onclick="execBlock('h1')" title="H1">1</button>
        <button class="btn-icon" onclick="execBlock('h2')" title="H2">2</button>
        <button class="btn-icon" onclick="execBlock('h3')" title="H3">3</button>
        <span class="tb-sep"></span>
        <button class="btn-icon" onclick="execCmd('justifyLeft')" title="Align left">L</button>
        <button class="btn-icon" onclick="execCmd('justifyCenter')" title="Align center">C</button>
        <button class="btn-icon" onclick="execCmd('justifyRight')" title="Align right">R</button>
        <span class="tb-sep"></span>
        <button class="btn-icon" onclick="execCmd('insertUnorderedList')" title="Bullet list">*</button>
        <button class="btn-icon" onclick="execCmd('insertOrderedList')" title="Numbered list">#</button>
        <button class="btn-icon" onclick="execCmd('formatBlock','blockquote')" title="Quote">"</button>
        <button class="btn-icon" onclick="insertHR()" title="Rule">--</button>
        <button class="btn-icon" onclick="insertPageBreak()" title="Page break">||</button>
        <span class="tb-sep"></span>
        <button class="btn-icon" onclick="insertImage()" title="Insert image">Img</button>
        <input type="file" id="img-input" accept="image/*" style="display:none" onchange="handleImage(this.files[0])">
        <span class="tb-sep"></span>
        <button class="btn-icon" onclick="toggleFullscreen()" title="Fullscreen" id="fs-btn">F</button>
        <div class="zoom-bar">
          <button class="btn-icon" onclick="zoom(-10)" title="Zoom out">-</button>
          <span class="zb" id="zoom-val">100%</span>
          <button class="btn-icon" onclick="zoom(10)" title="Zoom in">+</button>
          <button class="btn-icon" onclick="zoom(0)" title="Reset zoom">R</button>
        </div>
      </div>
    </div>
    <div class="preview-body" id="preview-body">
      <div id="pdf-wrap">
        <div class="pdf-canvas tpl-saturno" id="canvas" contenteditable="true">
          <h1>Content Beast</h1>
          <h2>By Gabo Saturno</h2>
          <p>Select a preset or paste content. Click here to edit directly.</p>
          <div class="pdf-footer">CONTENT BEAST / saturnomovement.com</div>
        </div>
        <div class="page-est" id="page-est">~ 1 page (A4)</div>
      </div>
      <div id="cap-output" style="display:none"></div>
    </div>
  </div>

</div>

<div class="ftr">
  <span>CONTENT BEAST v3.0 — by Saturno Movement</span>
  <span>Cmd+S: Save / Cmd+Shift+S: Export PDF / Cmd+N: New Doc / Esc: Exit</span>
</div>

</div>

<div class="toast" id="toast"></div>
<input type="file" id="file-input" accept=".md,.txt,.markdown,.text" style="display:none" onchange="handleFile(this.files[0])">

<!-- EXPORT SETTINGS MODAL -->
<div class="export-overlay" id="export-overlay" onclick="closeExport()"></div>
<div class="export-panel" id="export-panel">
  <h3>Export Settings</h3>
  <div class="export-row"><label>Paper Size</label><select id="ex-paper"><option value="a4">A4 (210x297mm)</option><option value="letter">Letter (8.5x11in)</option><option value="legal">Legal (8.5x14in)</option></select></div>
  <div class="export-row"><label>Orientation</label><select id="ex-orient"><option value="portrait">Portrait</option><option value="landscape">Landscape</option></select></div>
  <div class="export-row"><label>Top Margin (mm)</label><input type="number" id="ex-mt" value="12" min="0" max="50"></div>
  <div class="export-row"><label>Side Margins (mm)</label><input type="number" id="ex-ms" value="12" min="0" max="50"></div>
  <div class="export-row"><label>Bottom Margin (mm)</label><input type="number" id="ex-mb" value="16" min="0" max="50"></div>
  <div class="export-row"><label>Quality</label><select id="ex-quality"><option value="2">High (2x)</option><option value="3">Ultra (3x)</option><option value="1">Standard (1x)</option></select></div>
  <div class="export-row"><label>Include Page Numbers</label><select id="ex-pagenum"><option value="yes">Yes</option><option value="no">No</option></select></div>
  <div style="display:flex;gap:6px;margin-top:16px">
    <button class="btn btn-primary" style="flex:1" onclick="exportPDF()">Export PDF</button>
    <button class="btn btn-outline" style="flex:1" onclick="closeExport()">Cancel</button>
  </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
const STORE_KEY = 'content-beast-docs';
let docs = [];
let activeDocId = null;
let currentTpl = 'tpl-saturno';
let currentLv = '';
let currentVoice = 'teacher';
let saveTimer = null;
let zoomLevel = 100;

// ============================================================
// PERSISTENCE
// ============================================================
function loadDocs() {
  try { docs = JSON.parse(localStorage.getItem(STORE_KEY) || '[]'); } catch(e) { docs = []; }
  if (!docs.length) { createDoc('Untitled', '', 'tpl-saturno', ''); }
  renderLibrary();
  if (!activeDocId || !docs.find(d => d.id === activeDocId)) {
    switchDoc(docs[0].id);
  }
}

function saveDocs() {
  snapshotActive();
  localStorage.setItem(STORE_KEY, JSON.stringify(docs));
  flashSave();
}

function flashSave() {
  const ind = document.getElementById('save-ind');
  ind.style.opacity = '1';
  clearTimeout(ind._t);
  ind._t = setTimeout(() => ind.style.opacity = '0', 1500);
}

function scheduleSave() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(saveDocs, 800);
}

// ============================================================
// DOCUMENT MANAGEMENT
// ============================================================
function createDoc(title, content, tpl, lv) {
  const doc = {
    id: 'doc_' + Date.now(),
    title: title || 'Untitled',
    author: 'Gabo Saturno',
    content: content || '',
    tpl: tpl || 'tpl-saturno',
    level: lv || '',
    canvasHTML: '',
    created: new Date().toISOString(),
    updated: new Date().toISOString()
  };
  docs.unshift(doc);
  saveDocs();
  renderLibrary();
  return doc;
}

function newDoc() {
  const doc = createDoc('Untitled', '', currentTpl, '');
  switchDoc(doc.id);
}

function deleteDoc(id) {
  if (docs.length <= 1) { toast('Cannot delete last document'); return; }
  if (!confirm('Delete this document?')) return;
  docs = docs.filter(d => d.id !== id);
  saveDocs();
  renderLibrary();
  if (activeDocId === id) switchDoc(docs[0].id);
}

function duplicateDoc(id) {
  const src = docs.find(d => d.id === id);
  if (!src) return;
  const doc = createDoc(src.title + ' (copy)', src.content, src.tpl, src.level);
  doc.canvasHTML = src.canvasHTML;
  saveDocs();
  renderLibrary();
  switchDoc(doc.id);
}

function switchDoc(id) {
  snapshotActive();
  activeDocId = id;
  const doc = docs.find(d => d.id === id);
  if (!doc) return;

  document.getElementById('f-title').value = doc.title;
  document.getElementById('f-author').value = doc.author;
  document.getElementById('f-content').value = doc.content;
  currentTpl = doc.tpl || 'tpl-saturno';
  currentLv = doc.level || '';

  document.querySelectorAll('[data-tpl]').forEach(b => b.classList.toggle('active', b.dataset.tpl === currentTpl));
  document.querySelectorAll('[data-lv]').forEach(b => b.classList.toggle('active', b.dataset.lv === currentLv));

  if (doc.canvasHTML) {
    const canvas = document.getElementById('canvas');
    canvas.className = 'pdf-canvas ' + currentTpl;
    canvas.innerHTML = doc.canvasHTML;
  } else {
    renderPreview();
  }

  renderLibrary();
}

function snapshotActive() {
  if (!activeDocId) return;
  const doc = docs.find(d => d.id === activeDocId);
  if (!doc) return;
  doc.title = document.getElementById('f-title').value || 'Untitled';
  doc.author = document.getElementById('f-author').value || '';
  doc.content = document.getElementById('f-content').value || '';
  doc.tpl = currentTpl;
  doc.level = currentLv;
  doc.canvasHTML = document.getElementById('canvas').innerHTML;
  doc.updated = new Date().toISOString();
}

// ============================================================
// LIBRARY RENDER
// ============================================================
function renderLibrary() {
  const el = document.getElementById('lib-list');
  if (!docs.length) { el.innerHTML = '<div class="lib-empty">No documents yet.</div>'; return; }
  el.innerHTML = docs.map(d => {
    const active = d.id === activeDocId;
    const date = new Date(d.updated).toLocaleDateString();
    return '<div class="lib-item' + (active ? ' active' : '') + '" onclick="switchDoc(\'' + d.id + '\')">' +
      '<div class="li-title">' + esc(d.title) + '</div>' +
      '<div class="li-meta">' + date + (d.level ? ' / ' + d.level : '') +
      '<span style="float:right;display:flex;gap:4px">' +
      '<span onclick="event.stopPropagation();duplicateDoc(\'' + d.id + '\')" style="cursor:pointer" title="Duplicate">+</span>' +
      '<span onclick="event.stopPropagation();deleteDoc(\'' + d.id + '\')" style="cursor:pointer;color:var(--red)" title="Delete">x</span>' +
      '</span></div></div>';
  }).join('');
}

// ============================================================
// PREVIEW RENDERING
// ============================================================
function renderPreview() {
  const title = document.getElementById('f-title').value || 'Untitled';
  const author = document.getElementById('f-author').value || '';
  const content = document.getElementById('f-content').value;
  const canvas = document.getElementById('canvas');

  canvas.className = 'pdf-canvas ' + currentTpl;

  let html = '';
  if (currentLv && currentTpl === 'tpl-saturno') {
    html += '<div class="level-badge lv-' + currentLv + '">' + currentLv.toUpperCase() + '</div>\n';
  }
  html += '<h1>' + esc(title) + '</h1>\n';
  if (author) html += '<h2>By ' + esc(author) + '</h2>\n';

  if (content.trim()) {
    html += md(content);
  } else {
    html += '<p style="color:#999;font-style:italic">Paste content or select a preset. Click the preview to edit directly.</p>';
  }
  html += '\n<div class="pdf-footer">CONTENT BEAST / saturnomovement.com / ' + new Date().toLocaleDateString() + '</div>';
  canvas.innerHTML = html;
  estPages();
  scheduleSave();
}

function onFieldChange() {
  renderPreview();
}

// ============================================================
// MARKDOWN PARSER
// ============================================================
function md(text) {
  // Tables
  text = text.replace(/^(\|.+\|)\n(\|[-:| ]+\|)\n((?:\|.+\|\n?)*)/gm, function(m, header, sep, body) {
    const hCells = header.split('|').filter(c => c.trim());
    const bRows = body.trim().split('\n').map(r => r.split('|').filter(c => c.trim()));
    let t = '<table><thead><tr>' + hCells.map(c => '<th>' + c.trim() + '</th>').join('') + '</tr></thead><tbody>';
    bRows.forEach(row => { t += '<tr>' + row.map(c => '<td>' + c.trim() + '</td>').join('') + '</tr>'; });
    return t + '</tbody></table>';
  });

  return text
    .replace(/^#### (.*$)/gm, '<h4>$1</h4>')
    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
    .replace(/^# (.*$)/gm, '<h1 style="font-size:22px;font-weight:700;margin-top:24px;margin-bottom:8px">$1</h1>')
    .replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>')
    .replace(/^---$/gm, '<hr>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/`(.*?)`/g, '<code>$1</code>')
    .replace(/^\d+\. (.*$)/gm, '<li style="margin-left:20px;list-style:decimal">$1</li>')
    .replace(/^- (.*$)/gm, '<li style="margin-left:20px">$1</li>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/\n/g, '<br>');
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function estPages() {
  const c = document.getElementById('canvas');
  const pages = Math.max(1, Math.ceil(c.scrollHeight / 1050));
  document.getElementById('page-est').textContent = '~ ' + pages + ' page' + (pages > 1 ? 's' : '') + ' (A4)';
}

// ============================================================
// RICH TEXT COMMANDS (for canvas editing)
// ============================================================
function execCmd(cmd, val) { document.execCommand(cmd, false, val || null); }
function execBlock(tag) { document.execCommand('formatBlock', false, '<' + tag + '>'); }
function insertHR() {
  const sel = window.getSelection();
  if (sel.rangeCount) {
    const range = sel.getRangeAt(0);
    const hr = document.createElement('hr');
    range.insertNode(hr);
    range.setStartAfter(hr);
    sel.removeAllRanges();
    sel.addRange(range);
  }
}

// ============================================================
// TEMPLATE & LEVEL
// ============================================================
function setTpl(btn) {
  currentTpl = btn.dataset.tpl;
  document.querySelectorAll('[data-tpl]').forEach(b => b.classList.toggle('active', b === btn));
  document.getElementById('canvas').className = 'pdf-canvas ' + currentTpl;
  scheduleSave();
  toast('Template: ' + (currentTpl || 'white'));
}

function setLv(btn) {
  currentLv = btn.dataset.lv;
  document.querySelectorAll('[data-lv]').forEach(b => b.classList.toggle('active', b === btn));
  renderPreview();
}

// ============================================================
// PRESETS
// ============================================================
const PRESETS = {
  program: {
    title: 'Calisthenics Foundation Phase 1',
    content: '# CALISTHENICS FOUNDATION -- PHASE 1\n## Week 1-4 / Training Block A\n\n### UPPER BODY PUSH\n- Pseudo Planche Push-ups -- 4x8-12 / RER 3\n- Pike Push-ups (Elevated) -- 3x8-10 / RER 3\n- Diamond Push-ups -- 3x10-15 / RER 2\n- Dips (Parallel Bars) -- 3x6-10 / RER 3\n\n### UPPER BODY PULL\n- Pull-ups (Pronated) -- 4x5-8 / RER 3\n- Australian Rows (Rings) -- 3x10-12 / RER 2\n- Chin-ups (Supinated) -- 3x6-8 / RER 3\n\n### CORE\n- L-Sit Progression -- 4x15-30s hold\n- Dragon Flag Negatives -- 3x5-8\n- Hollow Body Hold -- 3x30-45s\n\n### PROGRAMMING NOTES\n\n| Variable | Week 1-2 | Week 3-4 | Deload |\n|----------|----------|----------|--------|\n| Volume | 100% | 110% | 60% |\n| RER | 4-5 | 2-3 | 5+ |\n| Intensity | Moderate | High | Low |\n\n- RER = Reps Estimated in Reserve\n- Start conservative -- you should feel like you could do 3 more reps\n- Log every set. Track RER honestly.\n- Deload in Week 5: reduce volume 40%, maintain intensity',
    level: 'foundation'
  },
  level: {
    title: 'Saturno Movement -- Level Guide',
    content: '# LEVEL PROGRESSION SYSTEM\n## The Saturno Method\n\n### FOUNDATION (Months 1-6)\nBuild the base. Master the basics. Own every rep.\n- Push-up variations mastered\n- Pull-up: 8+ strict reps\n- L-Sit: 15s+ hold\n- Handstand: Wall-assisted 30s+\n- Pistol Squat: 5+ per leg\n\n---\n\n### INTERMEDIATE (Months 6-18)\nConnect the dots. Skill acquisition begins.\n- Muscle-Up: 3+ clean reps\n- Handstand Push-up: 5+ wall-assisted\n- Front Lever: Tuck hold 10s+\n- Back Lever: Full hold 5s+\n- Planche: Tuck hold 5s+\n\n---\n\n### ADVANCED (Months 18-36)\nThe refinement phase. Movement quality over quantity.\n- Planche Push-ups: Tuck 5+ reps\n- Front Lever Rows: 5+ reps\n- Freestanding Handstand: 15s+\n- One Arm Pull-up: Negative controlled\n- Human Flag: 5s+ hold\n\n---\n\n### ELITE (36+ Months)\nArtistry. The body as instrument.\n- Full Planche: 5s+ hold\n- Iron Cross: Controlled entry\n- One Arm Handstand: 5s+\n- Maltese: Entry position\n- Victorian Cross: Progression work',
    level: ''
  },
  framework: {
    title: 'The Saturno System -- Training Framework',
    content: '# THE SATURNO SYSTEM\n## A Framework for Intelligent Training\n\n> The goal is not to train hard. The goal is to train smart, consistently, for decades.\n\n### PRINCIPLE 1: PROGRESSIVE OVERLOAD VIA RER\n\n| Week | RER | Intensity | Feel |\n|------|-----|-----------|------|\n| 1 | 4-5 | Easy | Building momentum |\n| 2 | 3-4 | Moderate | Finding groove |\n| 3 | 2-3 | Hard | Pushing boundaries |\n| 4 | 1-2 | Near-max | Testing limits |\n| 5 | -- | DELOAD | Recovery |\n\n### PRINCIPLE 2: MOVEMENT QUALITY FIRST\nOne perfect rep > ten sloppy reps.\n- Full range of motion, always\n- Control the eccentric (3s minimum)\n- Pause at end ranges\n- Breathe with intention\n\n### PRINCIPLE 3: SKILL + STRENGTH = MASTERY\nSkills are not separate from strength.\n- Practice skills when fresh (start of session)\n- Build strength after skill work\n- Connect movements -- planche push-ups, not just planche holds\n- Every session has a skill component\n\n### PRINCIPLE 4: RECOVERY IS TRAINING\nYou do not grow in the gym.\n- Sleep 7-9 hours (non-negotiable)\n- Mobility work daily (10-15 min)\n- Deload every 4-8 weeks\n- Listen to your body -- adjust, do not push through pain',
    level: ''
  },
  transcript: {
    title: 'Video Transcript -- Key Points',
    content: '# VIDEO TITLE\n## Channel: Saturno Movement\n\n### KEY POINTS\n- Point one from the video\n- Point two from the video\n- Point three from the video\n- Point four from the video\n\n### SUMMARY\nPaste the full summary here. This section captures the core message of the video in 2-3 paragraphs.\n\nThe second paragraph continues the thought.\n\n### ACTION ITEMS\n1. First action step the viewer should take\n2. Second action step\n3. Third action step\n\n### TIMESTAMPS\n\n| Time | Topic |\n|------|-------|\n| 0:00 | Introduction |\n| 2:15 | Main topic |\n| 5:30 | Key exercise demo |\n| 8:45 | Programming recommendations |\n| 11:00 | Closing thoughts |',
    level: ''
  },
  cover: {
    title: 'Saturno Movement',
    content: '',
    level: '',
    isCover: true
  }
};

function loadPreset(key, el) {
  const p = PRESETS[key];
  if (!p) return;
  document.querySelectorAll('.preset-card').forEach(c => c.classList.remove('active'));
  if (el) el.classList.add('active');
  document.getElementById('f-title').value = p.title;
  document.getElementById('f-content').value = p.content || '';
  if (p.level) { currentLv = p.level; document.querySelectorAll('[data-lv]').forEach(b => b.classList.toggle('active', b.dataset.lv === currentLv)); }
  if (p.isCover) {
    renderCoverPage(p.title);
  } else {
    renderPreview();
  }
  toast('Loaded: ' + key);
}

function renderCoverPage(title) {
  const canvas = document.getElementById('canvas');
  canvas.className = 'pdf-canvas ' + currentTpl;
  const author = document.getElementById('f-author').value || 'Gabo Saturno';
  canvas.innerHTML = '<div class="cover-page">' +
    '<h1>' + esc(title || 'Untitled') + '</h1>' +
    '<div class="cover-sub">Movement Mastery System</div>' +
    '<div class="cover-line"></div>' +
    '<div class="cover-author">' + esc(author) + '</div>' +
    '<div class="cover-brand">SATURNO MOVEMENT / saturnomovement.com</div>' +
    '</div>';
  estPages();
  scheduleSave();
}

// ============================================================
// FILE IMPORT / DROP
// ============================================================
function importFile() { document.getElementById('file-input').click(); }

function handleFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    const title = file.name.replace(/\.(md|txt|markdown|text)$/i, '').replace(/[_-]/g, ' ');
    const doc = createDoc(title, text, currentTpl, '');
    switchDoc(doc.id);
    renderPreview();
    toast('Imported: ' + file.name);
  };
  reader.readAsText(file);
}

// Drag-drop on drop zone
const dz = document.getElementById('drop-zone');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('over'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('over');
  if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});

// Global drag-drop
document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('drop', e => {
  e.preventDefault();
  if (e.dataTransfer.files.length && e.dataTransfer.files[0].name.match(/\.(md|txt|markdown)$/i)) {
    handleFile(e.dataTransfer.files[0]);
  }
});

// ============================================================
// PDF DOWNLOAD
// ============================================================
function downloadPDF() {
  snapshotActive();
  const canvas = document.getElementById('canvas');
  const title = document.getElementById('f-title').value || 'document';
  setStatus('GENERATING...', 'busy');

  const isDark = currentTpl === 'tpl-saturno' || currentTpl === 'tpl-dark';
  const opt = {
    margin: [12, 12, 16, 12],
    filename: title.replace(/[^a-zA-Z0-9_\- ]/g, '_').replace(/\s+/g, '_') + '.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, backgroundColor: isDark ? '#0a0a0a' : '#ffffff' },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
  };

  html2pdf().set(opt).from(canvas).save().then(() => {
    toast('Downloaded: ' + opt.filename);
    setStatus('READY', 'ok');
  }).catch(err => {
    toast('Error: ' + err.message);
    setStatus('ERROR', 'busy');
  });
}

function downloadHTML() {
  const canvas = document.getElementById('canvas');
  const title = document.getElementById('f-title').value || 'document';
  const html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + esc(title) + '</title><style>body{font-family:Sora,system-ui,sans-serif;max-width:800px;margin:40px auto;padding:20px;line-height:1.7}h1{font-size:28px}h2{color:#666}h3{text-transform:uppercase;letter-spacing:0.04em}table{width:100%;border-collapse:collapse}th,td{padding:8px;border:1px solid #ddd;text-align:left}th{background:#f8f8f8}</style></head><body>' + canvas.innerHTML + '</body></html>';
  const blob = new Blob([html], { type: 'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = title.replace(/[^a-zA-Z0-9_\- ]/g, '_') + '.html';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('HTML downloaded');
}

// ============================================================
// CAPTION MULTIPLIER
// ============================================================
function setVoice(btn) {
  currentVoice = btn.dataset.v;
  document.querySelectorAll('[data-v]').forEach(b => b.classList.toggle('active', b === btn));
}

document.querySelectorAll('.chk').forEach(label => {
  label.addEventListener('click', function(e) {
    if (e.target.tagName !== 'INPUT') { const cb = this.querySelector('input'); cb.checked = !cb.checked; }
    this.classList.toggle('on', this.querySelector('input').checked);
  });
});

function multiply() {
  const seed = document.getElementById('seed-input').value.trim();
  if (!seed) { toast('Enter a seed phrase'); return; }
  const pls = []; document.querySelectorAll('[data-pl]:checked').forEach(cb => pls.push(cb.dataset.pl));
  if (!pls.length) { toast('Select a platform'); return; }

  const S = {raw:{p:'',s:''},teacher:{p:'',s:'\n\nSave this for later.'},prophet:{p:'The truth is this:\n\n',s:'\n\nThis changes everything.'},rebel:{p:'Most people get this wrong.\n\n',s:'\n\nThink different.'},mystic:{p:'In the silence between reps...\n\n',s:''}};
  const F = {
    ig:{n:'Instagram',f:(s,t)=>t.p+s+t.s+'\n\n#Calisthenics #Movement #Mastery #SaturnoMovement'},
    email:{n:'Email',f:(s,t)=>'Subject: This changed my perspective\n\n'+t.p+s+t.s+'\n\nReply and tell me what you think.\n\n-- Gabo'},
    yt:{n:'YouTube',f:(s,t)=>'[HOOK - 0:00]\n'+s.substring(0,200)+'\n\n[EXPAND - 0:15]\n'+t.p+s+t.s+'\n\n[CTA - End]\nSubscribe for more movement wisdom.'},
    twitter:{n:'Twitter/X',f:(s,t)=>t.p+(s.length>240?s.substring(0,240)+'...':s)+t.s},
    linkedin:{n:'LinkedIn',f:(s,t)=>t.p+s+t.s+'\n\n---\n\nWhat is your experience with this? Share below.'},
    tiktok:{n:'TikTok',f:(s,t)=>'[TEXT ON SCREEN]\n"'+s.substring(0,100)+'..."\n\n[VOICEOVER]\n'+t.p+s+t.s}
  };

  const style = S[currentVoice] || S.teacher;
  document.getElementById('cap-output').innerHTML = pls.map(p => {
    const f = F[p]; if (!f) return '';
    const c = f.f(seed, style);
    return '<div class="variant-card '+p+'"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-size:8px;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-muted)">'+f.n+'</span><button onclick="navigator.clipboard.writeText(this.parentElement.nextElementSibling.innerText);toast(\'Copied\')" class="btn btn-outline btn-sm">Copy</button></div><pre style="font-size:10px;color:var(--text-secondary);white-space:pre-wrap;line-height:1.6;font-family:var(--mono)">'+esc(c)+'</pre></div>';
  }).join('');
  toast(pls.length + ' variants generated');
}

// ============================================================
// MODE SWITCH
// ============================================================
function setMode(mode) {
  document.querySelectorAll('.hdr .tab-btn').forEach((b,i) => b.classList.toggle('active', (i===0&&mode==='pdf')||(i===1&&mode==='caption')));
  const ws = document.getElementById('workspace');
  ws.classList.toggle('caption-mode', mode === 'caption');

  document.getElementById('pdf-ctrl').style.display = mode === 'pdf' ? '' : 'none';
  document.getElementById('cap-ctrl').style.display = mode === 'caption' ? '' : 'none';
  document.getElementById('pdf-wrap').style.display = mode === 'pdf' ? '' : 'none';
  document.getElementById('cap-output').style.display = mode === 'caption' ? '' : 'none';
  document.getElementById('ctrl-title').textContent = mode === 'pdf' ? 'PDF Controls' : 'Caption Multiplier';
  document.getElementById('preview-title').textContent = mode === 'pdf' ? 'Live Preview' : 'Variants';
  document.getElementById('preview-toolbar').style.display = mode === 'pdf' ? '' : 'none';
}

// ============================================================
// UTILITIES
// ============================================================
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(t._t); t._t = setTimeout(() => t.classList.remove('show'), 2000);
}
function setStatus(text, type) {
  const el = document.getElementById('status');
  el.innerHTML = '<span style="width:5px;height:5px;border-radius:50%;background:currentColor;display:inline-block"></span> ' + text;
  el.className = 'status status-' + type;
}

// ============================================================
// AUTO-SAVE ON CANVAS EDIT
// ============================================================
document.getElementById('canvas').addEventListener('input', scheduleSave);

// ============================================================
// ZOOM
// ============================================================
function zoom(delta) {
  if (delta === 0) { zoomLevel = 100; }
  else { zoomLevel = Math.min(200, Math.max(50, zoomLevel + delta)); }
  document.getElementById('canvas').style.transform = 'scale(' + (zoomLevel / 100) + ')';
  document.getElementById('canvas').style.transformOrigin = 'top center';
  document.getElementById('zoom-val').textContent = zoomLevel + '%';
}

// ============================================================
// PAGE BREAK
// ============================================================
function insertPageBreak() {
  const canvas = document.getElementById('canvas');
  if (!canvas.contains(document.activeElement) && document.activeElement !== canvas) { canvas.focus(); }
  const sel = window.getSelection();
  if (sel.rangeCount) {
    const range = sel.getRangeAt(0);
    const pb = document.createElement('hr');
    pb.className = 'page-break';
    range.insertNode(pb);
    range.setStartAfter(pb);
    sel.removeAllRanges();
    sel.addRange(range);
  } else {
    canvas.insertAdjacentHTML('beforeend', '<hr class="page-break">');
  }
  scheduleSave();
}

// ============================================================
// IMAGE INSERT
// ============================================================
function insertImage() {
  document.getElementById('img-input').click();
}

function handleImage(file) {
  if (!file || !file.type.startsWith('image/')) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const canvas = document.getElementById('canvas');
    const img = document.createElement('img');
    img.src = e.target.result;
    img.style.maxWidth = '100%';
    img.alt = file.name;
    const sel = window.getSelection();
    if (sel.rangeCount && canvas.contains(sel.anchorNode)) {
      const range = sel.getRangeAt(0);
      range.insertNode(img);
      range.setStartAfter(img);
      sel.removeAllRanges();
      sel.addRange(range);
    } else {
      const footer = canvas.querySelector('.pdf-footer');
      if (footer) { canvas.insertBefore(img, footer); }
      else { canvas.appendChild(img); }
    }
    scheduleSave();
    toast('Image inserted');
  };
  reader.readAsDataURL(file);
  document.getElementById('img-input').value = '';
}

// ============================================================
// FULLSCREEN
// ============================================================
function toggleFullscreen() {
  document.body.classList.toggle('fullscreen-mode');
  const btn = document.getElementById('fs-btn');
  if (document.body.classList.contains('fullscreen-mode')) {
    btn.classList.add('active');
    btn.title = 'Exit fullscreen';
    toast('Fullscreen mode — press F to exit');
  } else {
    btn.classList.remove('active');
    btn.title = 'Fullscreen';
  }
}

// ============================================================
// EXPORT SETTINGS
// ============================================================
function openExport() {
  snapshotActive();
  document.getElementById('export-overlay').classList.add('open');
  document.getElementById('export-panel').classList.add('open');
}

function closeExport() {
  document.getElementById('export-overlay').classList.remove('open');
  document.getElementById('export-panel').classList.remove('open');
}

function exportPDF() {
  const canvas = document.getElementById('canvas');
  const title = document.getElementById('f-title').value || 'document';
  const paper = document.getElementById('ex-paper').value;
  const orient = document.getElementById('ex-orient').value;
  const mt = parseInt(document.getElementById('ex-mt').value) || 12;
  const ms = parseInt(document.getElementById('ex-ms').value) || 12;
  const mb = parseInt(document.getElementById('ex-mb').value) || 16;
  const quality = parseInt(document.getElementById('ex-quality').value) || 2;
  const pageNum = document.getElementById('ex-pagenum').value === 'yes';

  closeExport();
  setStatus('EXPORTING...', 'busy');

  const isDark = currentTpl === 'tpl-saturno' || currentTpl === 'tpl-dark';

  // Reset zoom for clean export
  const prevZoom = zoomLevel;
  if (zoomLevel !== 100) {
    canvas.style.transform = 'scale(1)';
  }

  const opt = {
    margin: [mt, ms, mb + (pageNum ? 6 : 0), ms],
    filename: title.replace(/[^a-zA-Z0-9_\- ]/g, '_').replace(/\s+/g, '_') + '.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: quality, useCORS: true, backgroundColor: isDark ? '#0a0a0a' : '#ffffff' },
    jsPDF: { unit: 'mm', format: paper, orientation: orient },
    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
  };

  const worker = html2pdf().set(opt).from(canvas);

  if (pageNum) {
    worker.toPdf().get('pdf').then(function(pdf) {
      const totalPages = pdf.internal.getNumberOfPages();
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      for (let i = 1; i <= totalPages; i++) {
        pdf.setPage(i);
        pdf.setFontSize(8);
        pdf.setTextColor(150);
        pdf.text('Page ' + i + ' of ' + totalPages, pageW / 2, pageH - 6, { align: 'center' });
      }
    }).save().then(done);
  } else {
    worker.save().then(done);
  }

  function done() {
    toast('Exported: ' + opt.filename);
    setStatus('READY', 'ok');
    if (prevZoom !== 100) { zoom(0); zoom(prevZoom - 100); }
  }
}

// ============================================================
// KEYBOARD SHORTCUTS
// ============================================================
document.addEventListener('keydown', e => {
  if (e.metaKey || e.ctrlKey) {
    if (e.shiftKey && e.key === 's') { e.preventDefault(); openExport(); return; }
    if (e.key === 's') { e.preventDefault(); saveDocs(); toast('Saved'); return; }
    if (e.key === 'n') { e.preventDefault(); newDoc(); return; }
    if (e.key === 'p') { e.preventDefault(); window.print(); return; }
  }
  if (e.key === 'Escape') {
    if (document.body.classList.contains('fullscreen-mode')) toggleFullscreen();
    if (document.getElementById('export-panel').classList.contains('open')) closeExport();
  }
});

// ============================================================
// INIT
// ============================================================
loadDocs();
</script>
</body>
</html>
